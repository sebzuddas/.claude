     1→'use client'
     2→
     3→import { useEffect, useRef, useState } from 'react'
     4→import { ColorUtils, TypographyUtils } from '@/lib/utils'
     5→import type { HeatMapData, ColorTuple, VisualizationProps } from '@/types'
     6→
     7→interface HeatMapProps extends VisualizationProps {
     8→  data: HeatMapData
     9→  colorPalette?: string
    10→}
    11→
    12→export default function HeatMap({
    13→  data,
    14→  width = 900,
    15→  height = 600,
    16→  colorPalette = 'viridis',
    17→  onError
    18→}: HeatMapProps) {
    19→  const canvasRef = useRef<HTMLDivElement>(null)
    20→  const [p5Instance, setP5Instance] = useState<any>(null)
    21→  const paletteRef = useRef<ColorTuple[]>([]) // Use ref so P5 sketch sees updates
    22→
    23→  useEffect(() => {
    24→    let p5: any
    25→    let isMounted = true
    26→
    27→    const loadP5 = async () => {
    28→      if (typeof window !== 'undefined' && canvasRef.current) {
    29→        // Clear any existing canvases in the container first
    30→        if (canvasRef.current) {
    31→          canvasRef.current.innerHTML = ''
    32→        }
    33→
    34→        const p5Module = await import('p5')
    35→        const P5 = p5Module.default
    36→
    37→        // Check if component is still mounted
    38→        if (!isMounted) return
    39→
    40→        // Load theme configuration (title not used - handled by React component)
    41→        let labelSize = 12
    42→        let valueSize = 10
    43→
    44→        try {
    45→          const [loadedLabelSize, loadedValueSize] = await Promise.all([
    46→            TypographyUtils.getVisualizationFontSize('heatmap', 'labelSize'),
    47→            TypographyUtils.getVisualizationFontSize('heatmap', 'fontSize')
    48→          ])
    49→
    50→          if (!isMounted) return
    51→
    52→          labelSize = loadedLabelSize
    53→          valueSize = loadedValueSize
    54→        } catch (error) {
    55→          console.warn('Could not load font sizes, using defaults')
    56→        }
    57→
    58→        // Load color palette
    59→        try {
    60→          const paletteData = await ColorUtils.getColorPalette(colorPalette, 256)
    61→          // console.log('Loaded color palette:', colorPalette, 'with', paletteData.length, 'colors')
    62→          if (!isMounted) return
    63→          paletteRef.current = paletteData
    64→        } catch (error) {
    65→          console.warn('Could not load color palette, using default')
    66→          // Fallback to basic viridis colors
    67→          const fallbackPalette: ColorTuple[] = [
    68→            [68, 1, 84], [72, 40, 120], [62, 74, 137], [49, 104, 142],
    69→            [38, 130, 142], [31, 158, 137], [53, 183, 121], [109, 205, 89],
    70→            [180, 222, 44], [253, 231, 37]
    71→          ]
    72→          if (!isMounted) return
    73→          paletteRef.current = fallbackPalette
    74→          onError?.('Could not load color palette, using fallback')
    75→        }
    76→
    77→        if (!isMounted) return
    78→
    79→        const sketch = (p: any) => {
    80→          let cellWidth: number, cellHeight: number
    81→          let dataMin: number, dataMax: number
    82→
    83→          p.setup = () => {
    84→            const canvas = p.createCanvas(width, height)
    85→            canvas.parent(canvasRef.current)
    86→            canvas.style('display', 'block')
    87→            canvas.style('margin', '0 auto')
    88→
    89→            p.textAlign(p.CENTER, p.CENTER)
    90→            calculateLayout()
    91→            p.noLoop() // Stop continuous redrawing - heatmaps are static
    92→          }
    93→
    94→          p.draw = () => {
    95→            p.background(250)
    96→
    97→            if (!data?.data || !Array.isArray(data.data)) {
    98→              drawNoDataMessage()
    99→              return
   100→            }

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
