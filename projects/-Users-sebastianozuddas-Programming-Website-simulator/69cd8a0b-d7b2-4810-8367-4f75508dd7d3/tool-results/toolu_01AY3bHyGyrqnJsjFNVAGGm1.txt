     1â†’'use client'
     2â†’
     3â†’import { useState, useEffect, useRef, useCallback } from 'react'
     4â†’import VisualizationLayout from '@/components/ui/VisualizationLayout'
     5â†’import FileUploadZone from '@/components/ui/FileUploadZone'
     6â†’import MessageDisplay from '@/components/ui/MessageDisplay'
     7â†’import type { FileUploadResult } from '@/types'
     8â†’import {
     9â†’  SimulationController,
    10â†’  ABMRenderer,
    11â†’  createLegend,
    12â†’  type ABMModelDefinition,
    13â†’  type SimulationState,
    14â†’  type TimeseriesData,
    15â†’  type EntityId,
    16â†’  type VisualConfig
    17â†’} from '@/lib/abm'
    18â†’
    19â†’// Demo models
    20â†’import { FLOCKING_MODEL } from './demos/flocking'
    21â†’import { SIR_MODEL } from './demos/sir'
    22â†’import { PREDATOR_PREY_MODEL } from './demos/predatorPrey'
    23â†’
    24â†’// =============================================================================
    25â†’// TYPES
    26â†’// =============================================================================
    27â†’
    28â†’interface InspectedEntity {
    29â†’  id: EntityId
    30â†’  archetype: string
    31â†’  components: Record<string, unknown>
    32â†’}
    33â†’
    34â†’// =============================================================================
    35â†’// MAIN COMPONENT
    36â†’// =============================================================================
    37â†’
    38â†’export default function ABMPage() {
    39â†’  // State
    40â†’  const [model, setModel] = useState<ABMModelDefinition | null>(null)
    41â†’  const [simState, setSimState] = useState<SimulationState | null>(null)
    42â†’  const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' | 'info' }>()
    43â†’  const [timeseries, setTimeseries] = useState<Map<string, TimeseriesData>>(new Map())
    44â†’  const [inspectedEntity, setInspectedEntity] = useState<InspectedEntity | null>(null)
    45â†’  const [selectedDemo, setSelectedDemo] = useState<string>('flocking')
    46â†’  const [showTrails, setShowTrails] = useState(false)
    47â†’  const [speed, setSpeed] = useState(1)
    48â†’
    49â†’  // Refs
    50â†’  const containerRef = useRef<HTMLDivElement>(null)
    51â†’  const controllerRef = useRef<SimulationController | null>(null)
    52â†’  const rendererRef = useRef<ABMRenderer | null>(null)
    53â†’  const animationFrameRef = useRef<number | null>(null)
    54â†’  const lastTickTimeRef = useRef<number>(0)
    55â†’
    56â†’  // Demo models map
    57â†’  const demoModels: Record<string, ABMModelDefinition> = {
    58â†’    flocking: FLOCKING_MODEL,
    59â†’    sir: SIR_MODEL,
    60â†’    predatorPrey: PREDATOR_PREY_MODEL
    61â†’  }
    62â†’
    63â†’  // =============================================================================
    64â†’  // INITIALIZATION
    65â†’  // =============================================================================
    66â†’
    67â†’  const initializeSimulation = useCallback(async (modelDef: ABMModelDefinition) => {
    68â†’    if (!containerRef.current) return
    69â†’
    70â†’    try {
    71â†’      // Clean up existing simulation
    72â†’      if (animationFrameRef.current) {
    73â†’        cancelAnimationFrame(animationFrameRef.current)
    74â†’      }
    75â†’      if (rendererRef.current) {
    76â†’        rendererRef.current.destroy()
    77â†’      }
    78â†’
    79â†’      // Create controller
    80â†’      const controller = new SimulationController()
    81â†’      controllerRef.current = controller
    82â†’
    83â†’      // Initialize simulation
    84â†’      controller.initialize(modelDef)
    85â†’
    86â†’      // Get environment config
    87â†’      const envConfig = controller.getEnvironmentConfig()
    88â†’      if (!envConfig) throw new Error('No environment config')
    89â†’
    90â†’      // Create renderer
    91â†’      const renderer = new ABMRenderer({
    92â†’        width: envConfig.spatial.width,
    93â†’        height: envConfig.spatial.height,
    94â†’        showGrid: envConfig.spatial.type === 'grid2D',
    95â†’        showTrails: showTrails
    96â†’      })
    97â†’
    98â†’      await renderer.initialize(containerRef.current)
    99â†’      rendererRef.current = renderer
   100â†’
   101â†’      // Setup environment
   102â†’      renderer.setupEnvironment(
   103â†’        envConfig,
   104â†’        envConfig.features?.zones,
   105â†’        envConfig.features?.obstacles
   106â†’      )
   107â†’
   108â†’      // Set archetype visuals
   109â†’      const visuals = new Map<string, VisualConfig>()
   110â†’      for (const archetype of modelDef.overview.entities.archetypes) {
   111â†’        visuals.set(archetype.name, archetype.visual || {})
   112â†’      }
   113â†’      renderer.setArchetypeVisuals(visuals)
   114â†’
   115â†’      // Subscribe to controller events
   116â†’      controller.on('stateChanged', (state: unknown) => {
   117â†’        setSimState({ ...(state as SimulationState) })
   118â†’      })
   119â†’
   120â†’      controller.on('tick', () => {
   121â†’        setTimeseries(new Map(controller.getTimeseries()))
   122â†’      })
   123â†’
   124â†’      // Initial render
   125â†’      renderer.render(controller.getEntities())
   126â†’
   127â†’      setModel(modelDef)
   128â†’      setSimState(controller.getState())
   129â†’      setMessage({ text: `Loaded: ${modelDef.overview.purpose}`, type: 'success' })
   130â†’
   131â†’    } catch (error) {
   132â†’      console.error('Failed to initialize simulation:', error)
   133â†’      setMessage({
   134â†’        text: `Failed to initialize: ${error instanceof Error ? error.message : 'Unknown error'}`,
   135â†’        type: 'error'
   136â†’      })
   137â†’    }
   138â†’  }, [showTrails])
   139â†’
   140â†’  // Load demo on mount and when selection changes
   141â†’  useEffect(() => {
   142â†’    const demo = demoModels[selectedDemo]
   143â†’    if (demo) {
   144â†’      initializeSimulation(demo)
   145â†’    }
   146â†’    // eslint-disable-next-line react-hooks/exhaustive-deps
   147â†’  }, [selectedDemo])
   148â†’
   149â†’  // =============================================================================
   150â†’  // SIMULATION LOOP
   151â†’  // =============================================================================
   152â†’
   153â†’  useEffect(() => {
   154â†’    if (!controllerRef.current || !rendererRef.current) return
   155â†’
   156â†’    const controller = controllerRef.current
   157â†’    const renderer = rendererRef.current
   158â†’
   159â†’    const loop = (timestamp: number) => {
   160â†’      const state = controller.getState()
   161â†’
   162â†’      if (!state.paused) {
   163â†’        // Calculate time since last tick
   164â†’        const elapsed = timestamp - lastTickTimeRef.current
   165â†’        const tickInterval = 1000 / (10 * speed) // 10 ticks per second at 1x speed
   166â†’
   167â†’        if (elapsed >= tickInterval) {
   168â†’          controller.step()
   169â†’          lastTickTimeRef.current = timestamp
   170â†’        }
   171â†’      }
   172â†’
   173â†’      // Always render
   174â†’      renderer.render(controller.getEntities())
   175â†’
   176â†’      animationFrameRef.current = requestAnimationFrame(loop)
   177â†’    }
   178â†’
   179â†’    animationFrameRef.current = requestAnimationFrame(loop)
   180â†’
   181â†’    return () => {
   182â†’      if (animationFrameRef.current) {
   183â†’        cancelAnimationFrame(animationFrameRef.current)
   184â†’      }
   185â†’    }
   186â†’  }, [speed, simState?.paused])
   187â†’
   188â†’  // =============================================================================
   189â†’  // CONTROLS
   190â†’  // =============================================================================
   191â†’
   192â†’  const handlePlay = () => {
   193â†’    controllerRef.current?.play()
   194â†’    lastTickTimeRef.current = performance.now()
   195â†’  }
   196â†’
   197â†’  const handlePause = () => {
   198â†’    controllerRef.current?.pause()
   199â†’  }
   200â†’
   201â†’  const handleStep = () => {
   202â†’    controllerRef.current?.step()
   203â†’    rendererRef.current?.render(controllerRef.current?.getEntities() || [])
   204â†’  }
   205â†’
   206â†’  const handleReset = () => {
   207â†’    controllerRef.current?.reset()
   208â†’    rendererRef.current?.clearTrails()
   209â†’    rendererRef.current?.render(controllerRef.current?.getEntities() || [])
   210â†’    setTimeseries(new Map())
   211â†’    setInspectedEntity(null)
   212â†’  }
   213â†’
   214â†’  const handleSpeedChange = (newSpeed: number) => {
   215â†’    setSpeed(newSpeed)
   216â†’    controllerRef.current?.setSpeed(newSpeed)
   217â†’  }
   218â†’
   219â†’  const handleTrailsToggle = () => {
   220â†’    const newShowTrails = !showTrails
   221â†’    setShowTrails(newShowTrails)
   222â†’    rendererRef.current?.updateConfig({ showTrails: newShowTrails })
   223â†’  }
   224â†’
   225â†’  // =============================================================================
   226â†’  // FILE UPLOAD
   227â†’  // =============================================================================
   228â†’
   229â†’  const handleFileUpload = (result: FileUploadResult) => {
   230â†’    if (result.error) {
   231â†’      setMessage({ text: result.error, type: 'error' })
   232â†’    } else if (result.data) {
   233â†’      try {
   234â†’        // Basic validation
   235â†’        if (!result.data.overview || !result.data.designConcepts || !result.data.details) {
   236â†’          throw new Error('Invalid ABM model: missing required sections (overview, designConcepts, details)')
   237â†’        }
   238â†’
   239â†’        initializeSimulation(result.data as ABMModelDefinition)
   240â†’      } catch (error) {
   241â†’        setMessage({
   242â†’          text: `Invalid model: ${error instanceof Error ? error.message : 'Unknown error'}`,
   243â†’          type: 'error'
   244â†’        })
   245â†’      }
   246â†’    }
   247â†’  }
   248â†’
   249â†’  // =============================================================================
   250â†’  // ENTITY INSPECTION
   251â†’  // =============================================================================
   252â†’
   253â†’  const handleCanvasClick = (event: React.MouseEvent<HTMLDivElement>) => {
   254â†’    if (!rendererRef.current || !containerRef.current) return
   255â†’
   256â†’    const rect = containerRef.current.getBoundingClientRect()
   257â†’    const x = event.clientX - rect.left
   258â†’    const y = event.clientY - rect.top
   259â†’
   260â†’    const entityId = rendererRef.current.getEntityAtPosition(x, y)
   261â†’
   262â†’    if (entityId) {
   263â†’      const entity = controllerRef.current?.getEntity(entityId)
   264â†’      if (entity) {
   265â†’        const components: Record<string, unknown> = {}
   266â†’        for (const [type, data] of (entity as any).getAllComponents()) {
   267â†’          components[type] = data
   268â†’        }
   269â†’
   270â†’        setInspectedEntity({
   271â†’          id: entityId,
   272â†’          archetype: (entity as any).archetype,
   273â†’          components
   274â†’        })
   275â†’        rendererRef.current.setTrackedEntity(entityId)
   276â†’      }
   277â†’    } else {
   278â†’      setInspectedEntity(null)
   279â†’      rendererRef.current.setTrackedEntity(null)
   280â†’    }
   281â†’  }
   282â†’
   283â†’  // =============================================================================
   284â†’  // EXPORT
   285â†’  // =============================================================================
   286â†’
   287â†’  const handleExportJSON = () => {
   288â†’    const json = controllerRef.current?.exportJSON()
   289â†’    if (json) {
   290â†’      const blob = new Blob([json], { type: 'application/json' })
   291â†’      const url = URL.createObjectURL(blob)
   292â†’      const a = document.createElement('a')
   293â†’      a.href = url
   294â†’      a.download = 'abm-simulation-export.json'
   295â†’      a.click()
   296â†’      URL.revokeObjectURL(url)
   297â†’    }
   298â†’  }
   299â†’
   300â†’  const handleExportCSV = () => {
   301â†’    const csv = controllerRef.current?.exportCSV()
   302â†’    if (csv) {
   303â†’      const blob = new Blob([csv], { type: 'text/csv' })
   304â†’      const url = URL.createObjectURL(blob)
   305â†’      const a = document.createElement('a')
   306â†’      a.href = url
   307â†’      a.download = 'abm-timeseries.csv'
   308â†’      a.click()
   309â†’      URL.revokeObjectURL(url)
   310â†’    }
   311â†’  }
   312â†’
   313â†’  // =============================================================================
   314â†’  // RENDER
   315â†’  // =============================================================================
   316â†’
   317â†’  return (
   318â†’    <VisualizationLayout
   319â†’      title="Agent-Based Model Simulator"
   320â†’      description="Simulate complex systems with interacting agents"
   321â†’    >
   322â†’      {/* Demo Selection */}
   323â†’      <div className="mb-4 flex flex-wrap gap-2 items-center">
   324â†’        <label className="font-medium">Demo:</label>
   325â†’        <select
   326â†’          value={selectedDemo}
   327â†’          onChange={(e) => setSelectedDemo(e.target.value)}
   328â†’          className="px-3 py-2 border rounded-md bg-white"
   329â†’        >
   330â†’          <option value="flocking">Flocking (Boids)</option>
   331â†’          <option value="sir">SIR Epidemic</option>
   332â†’          <option value="predatorPrey">Predator-Prey</option>
   333â†’        </select>
   334â†’      </div>
   335â†’
   336â†’      {/* File Upload */}
   337â†’      <FileUploadZone
   338â†’        onFileUpload={handleFileUpload}
   339â†’        description="Upload an ABM model JSON file"
   340â†’        className="w-full max-w-2xl mb-4"
   341â†’      />
   342â†’
   343â†’      {/* Message Display */}
   344â†’      {message && (
   345â†’        <MessageDisplay
   346â†’          message={message.text}
   347â†’          type={message.type}
   348â†’          onClose={() => setMessage(undefined)}
   349â†’        />
   350â†’      )}
   351â†’
   352â†’      {/* Main Content */}
   353â†’      <div className="flex flex-col lg:flex-row gap-4">
   354â†’        {/* Simulation Canvas */}
   355â†’        <div className="flex-1">
   356â†’          <div className="bg-gray-900 rounded-lg overflow-hidden relative">
   357â†’            {/* Canvas Container */}
   358â†’            <div
   359â†’              ref={containerRef}
   360â†’              onClick={handleCanvasClick}
   361â†’              className="cursor-crosshair"
   362â†’              style={{ minHeight: 400 }}
   363â†’            />
   364â†’
   365â†’            {/* Controls Overlay */}
   366â†’            <div className="absolute bottom-4 left-4 right-4 flex flex-wrap gap-2 items-center bg-black/50 rounded-lg p-3">
   367â†’              {/* Playback */}
   368â†’              <button
   369â†’                onClick={simState?.paused ? handlePlay : handlePause}
   370â†’                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium"
   371â†’              >
   372â†’                {simState?.paused ? 'â–¶ Play' : 'â¸ Pause'}
   373â†’              </button>
   374â†’              <button
   375â†’                onClick={handleStep}
   376â†’                className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md"
   377â†’                disabled={!simState?.paused}
   378â†’              >
   379â†’                Step
   380â†’              </button>
   381â†’              <button
   382â†’                onClick={handleReset}
   383â†’                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md"
   384â†’              >
   385â†’                Reset
   386â†’              </button>
   387â†’
   388â†’              {/* Speed */}
   389â†’              <div className="flex items-center gap-2 ml-4">
   390â†’                <label className="text-white text-sm">Speed:</label>
   391â†’                <select
   392â†’                  value={speed}
   393â†’                  onChange={(e) => handleSpeedChange(parseFloat(e.target.value))}
   394â†’                  className="px-2 py-1 rounded bg-gray-700 text-white text-sm"
   395â†’                >
   396â†’                  <option value={0.5}>0.5x</option>
   397â†’                  <option value={1}>1x</option>
   398â†’                  <option value={2}>2x</option>
   399â†’                </select>
   400â†’              </div>
   401â†’
   402â†’              {/* Trails Toggle */}
   403â†’              <label className="flex items-center gap-2 ml-4 text-white text-sm cursor-pointer">
   404â†’                <input
   405â†’                  type="checkbox"
   406â†’                  checked={showTrails}
   407â†’                  onChange={handleTrailsToggle}
   408â†’                  className="rounded"
   409â†’                />
   410â†’                Trails
   411â†’              </label>
   412â†’
   413â†’              {/* Tick Counter */}
   414â†’              <div className="ml-auto text-white text-sm">
   415â†’                Tick: {simState?.tick || 0} | Seed: {simState?.seed || 0}
   416â†’              </div>
   417â†’            </div>
   418â†’          </div>
   419â†’
   420â†’          {/* Export Buttons */}
   421â†’          <div className="mt-4 flex gap-2">
   422â†’            <button
   423â†’              onClick={handleExportJSON}
   424â†’              className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-sm"
   425â†’            >
   426â†’              ğŸ“„ Export JSON
   427â†’            </button>
   428â†’            <button
   429â†’              onClick={handleExportCSV}
   430â†’              className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-sm"
   431â†’            >
   432â†’              ğŸ“Š Export CSV
   433â†’            </button>
   434â†’          </div>
   435â†’        </div>
   436â†’
   437â†’        {/* Side Panel */}
   438â†’        <div className="w-full lg:w-80 space-y-4">
   439â†’          {/* Entity Inspector */}
   440â†’          {inspectedEntity && (
   441â†’            <div className="bg-white rounded-lg shadow-lg p-4">
   442â†’              <h3 className="font-semibold mb-2">Agent Inspector</h3>
   443â†’              <div className="text-sm space-y-1">
   444â†’                <div><strong>ID:</strong> {inspectedEntity.id}</div>
   445â†’                <div><strong>Type:</strong> {inspectedEntity.archetype}</div>
   446â†’                <hr className="my-2" />
   447â†’                {Object.entries(inspectedEntity.components).map(([type, data]) => (
   448â†’                  <div key={type} className="mb-2">
   449â†’                    <div className="font-medium text-blue-600">{type}</div>
   450â†’                    <pre className="text-xs bg-gray-100 p-2 rounded overflow-auto max-h-32">
   451â†’                      {JSON.stringify(data, null, 2)}
   452â†’                    </pre>
   453â†’                  </div>
   454â†’                ))}
   455â†’              </div>
   456â†’              <button
   457â†’                onClick={() => {
   458â†’                  setInspectedEntity(null)
   459â†’                  rendererRef.current?.setTrackedEntity(null)
   460â†’                }}
   461â†’                className="mt-2 text-sm text-gray-500 hover:text-gray-700"
   462â†’              >
   463â†’                Close
   464â†’              </button>
   465â†’            </div>
   466â†’          )}
   467â†’
   468â†’          {/* Model Info */}
   469â†’          {model && (
   470â†’            <div className="bg-white rounded-lg shadow-lg p-4">
   471â†’              <h3 className="font-semibold mb-2">Model Info</h3>
   472â†’              <p className="text-sm text-gray-600">{model.overview.purpose}</p>
   473â†’              <div className="mt-2 text-sm">
   474â†’                <div><strong>Agents:</strong> {controllerRef.current?.getEntities().length || 0}</div>
   475â†’                <div><strong>dt:</strong> {model.overview.scales.temporal.dt}</div>
   476â†’              </div>
   477â†’            </div>
   478â†’          )}
   479â†’        </div>
   480â†’      </div>
   481â†’
   482â†’      {/* Timeseries Plots */}
   483â†’      <div className="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
   484â†’        {/* Macro-level Plot */}
   485â†’        <div className="bg-white rounded-lg shadow-lg p-4">
   486â†’          <h3 className="font-semibold mb-2">Population Dynamics</h3>
   487â†’          <div className="h-48 relative">
   488â†’            {timeseries.size > 0 ? (
   489â†’              <TimeseriesPlot data={timeseries} />
   490â†’            ) : (
   491â†’              <div className="h-full flex items-center justify-center text-gray-400">
   492â†’                Run simulation to see data
   493â†’              </div>
   494â†’            )}
   495â†’          </div>
   496â†’        </div>
   497â†’
   498â†’        {/* Instructions */}
   499â†’        <div className="bg-white rounded-lg shadow-lg p-4">
   500â†’          <h3 className="font-semibold mb-2">Instructions</h3>
   501â†’          <ul className="text-sm text-gray-600 space-y-1 list-disc list-inside">
   502â†’            <li>Select a demo or upload a custom JSON model</li>
   503â†’            <li>Click Play to start the simulation</li>
   504â†’            <li>Click on agents to inspect their state</li>
   505â†’            <li>Use Speed control to slow down or speed up</li>
   506â†’            <li>Enable Trails to see agent movement history</li>
   507â†’            <li>Export data as JSON or CSV for analysis</li>
   508â†’          </ul>
   509â†’        </div>
   510â†’      </div>
   511â†’    </VisualizationLayout>
   512â†’  )
   513â†’}
   514â†’
   515â†’// =============================================================================
   516â†’// TIMESERIES PLOT COMPONENT
   517â†’// =============================================================================
   518â†’
   519â†’interface TimeseriesPlotProps {
   520â†’  data: Map<string, TimeseriesData>
   521â†’}
   522â†’
   523â†’function TimeseriesPlot({ data }: TimeseriesPlotProps) {
   524â†’  const canvasRef = useRef<HTMLCanvasElement>(null)
   525â†’
   526â†’  useEffect(() => {
   527â†’    const canvas = canvasRef.current
   528â†’    if (!canvas) return
   529â†’
   530â†’    const ctx = canvas.getContext('2d')
   531â†’    if (!ctx) return
   532â†’
   533â†’    const rect = canvas.getBoundingClientRect()
   534â†’    canvas.width = rect.width * window.devicePixelRatio
   535â†’    canvas.height = rect.height * window.devicePixelRatio
   536â†’    ctx.scale(window.devicePixelRatio, window.devicePixelRatio)
   537â†’
   538â†’    const width = rect.width
   539â†’    const height = rect.height
   540â†’    const padding = 40
   541â†’
   542â†’    // Clear
   543â†’    ctx.fillStyle = '#f9fafb'
   544â†’    ctx.fillRect(0, 0, width, height)
   545â†’
   546â†’    // Find data range
   547â†’    let minVal = Infinity
   548â†’    let maxVal = -Infinity
   549â†’    let maxTick = 0
   550â†’
   551â†’    data.forEach(ts => {
   552â†’      for (const v of ts.values) {
   553â†’        minVal = Math.min(minVal, v)
   554â†’        maxVal = Math.max(maxVal, v)
   555â†’      }
   556â†’      maxTick = Math.max(maxTick, ts.ticks.length > 0 ? ts.ticks[ts.ticks.length - 1] : 0)
   557â†’    })
   558â†’
   559â†’    if (minVal === Infinity) return
   560â†’
   561â†’    // Add padding to range
   562â†’    const range = maxVal - minVal
   563â†’    minVal -= range * 0.1
   564â†’    maxVal += range * 0.1
   565â†’
   566â†’    // Draw axes
   567â†’    ctx.strokeStyle = '#ccc'
   568â†’    ctx.lineWidth = 1
   569â†’    ctx.beginPath()
   570â†’    ctx.moveTo(padding, padding)
   571â†’    ctx.lineTo(padding, height - padding)
   572â†’    ctx.lineTo(width - padding, height - padding)
   573â†’    ctx.stroke()
   574â†’
   575â†’    // Colors for each series
   576â†’    const colors = ['#4285f4', '#ea4335', '#fbbc04', '#34a853', '#ff6d01']
   577â†’    let colorIndex = 0
   578â†’
   579â†’    // Draw data
   580â†’    data.forEach((ts, name) => {
   581â†’      if (ts.values.length < 2) return
   582â†’
   583â†’      ctx.strokeStyle = colors[colorIndex % colors.length]
   584â†’      ctx.lineWidth = 2
   585â†’      ctx.beginPath()
   586â†’
   587â†’      for (let i = 0; i < ts.values.length; i++) {
   588â†’        const x = padding + (ts.ticks[i] / maxTick) * (width - 2 * padding)
   589â†’        const y = height - padding - ((ts.values[i] - minVal) / (maxVal - minVal)) * (height - 2 * padding)
   590â†’
   591â†’        if (i === 0) {
   592â†’          ctx.moveTo(x, y)
   593â†’        } else {
   594â†’          ctx.lineTo(x, y)
   595â†’        }
   596â†’      }
   597â†’
   598â†’      ctx.stroke()
   599â†’      colorIndex++
   600â†’    })
   601â†’
   602â†’    // Draw legend
   603â†’    colorIndex = 0
   604â†’    let legendY = 10
   605â†’    data.forEach((ts, name) => {
   606â†’      ctx.fillStyle = colors[colorIndex % colors.length]
   607â†’      ctx.fillRect(width - 100, legendY, 12, 12)
   608â†’      ctx.fillStyle = '#333'
   609â†’      ctx.font = '11px sans-serif'
   610â†’      ctx.fillText(name, width - 84, legendY + 10)
   611â†’      legendY += 16
   612â†’      colorIndex++
   613â†’    })
   614â†’
   615â†’  }, [data])
   616â†’
   617â†’  return (
   618â†’    <canvas
   619â†’      ref={canvasRef}
   620â†’      className="w-full h-full"
   621â†’    />
   622â†’  )
   623â†’}
   624â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
