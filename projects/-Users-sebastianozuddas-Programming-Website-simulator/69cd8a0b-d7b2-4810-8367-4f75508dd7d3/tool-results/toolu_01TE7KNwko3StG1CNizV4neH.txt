488-              const dState = new Array(n).fill(0)
489-              for (let i = 0; i < n; i++) {
490-                for (let j = 0; j < n; j++) {
491-                  dState[i] += data.A[i][j] * state[j]
492-                }
493-              }
494-              return dState
495-            }
496-            return new Array(state.length).fill(0)
497-          }
498-
499-          function magnitudeToColor(mag: number, maxMag: number): [number, number, number] {
500-            // Map magnitude to color (blue = low, red = high)
501-            const normalized = Math.min(mag / (maxMag || 1), 1)
502-            const r = Math.floor(normalized * 255)
503-            const b = Math.floor((1 - normalized) * 255)
504-            return [r, 100, b]
505-          }
506-
507-          // Mouse click to add trajectory
508:          p.mousePressed = () => {
509-            if (!is3D && p.mouseX > 50 && p.mouseX < width - 50 && p.mouseY > 50 && p.mouseY < height - 200) {
510-              addTrajectoryFromClick(p)
511-              return false
512-            }
513-          }
514-
515-          function addTrajectoryFromClick(p: any) {
516-            if (trajectories.length >= 2) return // Max 2 trajectories
517-
518-            const selectedStates = data.selectedStates || [0, 1]
519-            const stateX = selectedStates[0]
520-            const stateY = selectedStates[1]
521-
522-            const xMin = bounds!.min[stateX]
523-            const xMax = bounds!.max[stateX]
524-            const yMin = bounds!.min[stateY]
525-            const yMax = bounds!.max[stateY]
526-
527-            const mapX = (x: number) => p.map(x, xMin, xMax, 50, width - 50)
528-            const mapY = (y: number) => p.map(y, yMin, yMax, height - 200, 50)