     1â†’# Data Visualization Platform - Next.js Edition
     2â†’
     3â†’## Project Overview
     4â†’A modern data visualization platform built with Next.js 15, React 18, TypeScript, and P5.js. Provides interactive data visualizations including heat maps, scatter plots, particle systems, and more. Configured for static export to GitHub Pages.
     5â†’
     6â†’## Tech Stack
     7â†’
     8â†’### Frontend Framework
     9â†’- **Next.js 15** - React framework with App Router
    10â†’- **React 18** - UI library with hooks and modern patterns
    11â†’- **TypeScript** - Type-safe development
    12â†’- **Tailwind CSS** - Utility-first styling
    13â†’
    14â†’### Visualization
    15â†’- **P5.js** - Creative coding library for visualizations
    16â†’- **Client-side rendering** - All visualizations render in browser
    17â†’
    18â†’### Build & Deploy
    19â†’- **Static Export** - `output: 'export'` for GitHub Pages
    20â†’- **GitHub Pages** - Static hosting with CDN
    21â†’- **No server-side dependencies** - Pure client-side application
    22â†’
    23â†’## Core Features
    24â†’
    25â†’### 1. Interactive Visualizations
    26â†’- **Heat Maps** - `/heatmap` - 2D data matrices with color-coded intensity
    27â†’- **Scatter Plots** - `/scatter` - Plot relationships between variables
    28â†’- **Geospatial Data** - `/geospatial` - Map-based visualizations
    29â†’- **Time Series** - `/timeseries` - Data changes over time
    30â†’- **Network Graphs** - `/network` - Connections and relationships
    31â†’- **Bar Charts** - `/barchart` - Categorical data comparison
    32â†’
    33â†’### 2. System Models & Simulations
    34â†’- **State-Space System** - `/systemmodel` - Discrete-time system simulation with stocks and flows
    35â†’- **Vector Field Visualizer** - `/vectorfield` - 2D/3D vector field visualization with trajectory integration
    36â†’- **State Space Visualizer** - `/statespace` - Phase portraits and trajectory visualization
    37â†’- **Particle System** - `/particles` - Physics-based particle simulation
    38â†’- **Flocking behaviour** - `/flocking` - Emergent group behavior simulation
    39â†’
    40â†’### 3. Data Input Methods
    41â†’1. **URL Parameters** - JSON data encoded in query string
    42â†’2. **File Upload** - Drag & drop JSON files with validation
    43â†’3. **PostMessage API** - For iframe embedding and external communication
    44â†’4. **Demo Data** - Built-in example datasets for each visualization
    45â†’
    46â†’### 4. Theming & Customization
    47â†’- **Color Palettes** - Multiple built-in palettes (Viridis, Plasma, Inferno, etc.)
    48â†’- **Typography** - Theme-based font sizing from `color-palettes.json`
    49â†’- **Responsive Design** - Adapts to different screen sizes
    50â†’
    51â†’## Architecture
    52â†’
    53â†’### Directory Structure
    54â†’```
    55â†’/simulator
    56â†’â”œâ”€â”€ src/
    57â†’â”‚   â”œâ”€â”€ app/                    # Next.js App Router pages
    58â†’â”‚   â”‚   â”œâ”€â”€ page.tsx           # Home page / visualization gallery
    59â†’â”‚   â”‚   â”œâ”€â”€ layout.tsx         # Root layout with metadata
    60â†’â”‚   â”‚   â”œâ”€â”€ heatmap/
    61â†’â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # Heat map visualization page
    62â†’â”‚   â”‚   â”œâ”€â”€ systemmodel/
    63â†’â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # System model simulator page
    64â†’â”‚   â”‚   â”œâ”€â”€ vectorfield/
    65â†’â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # Vector field visualizer page
    66â†’â”‚   â”‚   â”œâ”€â”€ statespace/
    67â†’â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # State space/phase portrait page
    68â†’â”‚   â”‚   â””â”€â”€ globals.css        # Global styles + Tailwind
    69â†’â”‚   â”œâ”€â”€ components/
    70â†’â”‚   â”‚   â”œâ”€â”€ visualizations/
    71â†’â”‚   â”‚   â”‚   â”œâ”€â”€ HeatMap.tsx    # P5.js heat map component
    72â†’â”‚   â”‚   â”‚   â”œâ”€â”€ SystemModel.tsx # System simulator with stocks & flows
    73â†’â”‚   â”‚   â”‚   â””â”€â”€ StateSpaceVisualization.tsx # Phase portrait viewer
    74â†’â”‚   â”‚   â””â”€â”€ ui/
    75â†’â”‚   â”‚       â”œâ”€â”€ VisualizationLayout.tsx
    76â†’â”‚   â”‚       â”œâ”€â”€ ColorPaletteSelector.tsx
    77â†’â”‚   â”‚       â”œâ”€â”€ FileUploadZone.tsx
    78â†’â”‚   â”‚       â””â”€â”€ MessageDisplay.tsx
    79â†’â”‚   â”œâ”€â”€ lib/
    80â†’â”‚   â”‚   â””â”€â”€ utils.ts           # Utilities (ColorUtils, DataParser, etc.)
    81â†’â”‚   â”œâ”€â”€ types/
    82â†’â”‚   â”‚   â””â”€â”€ index.ts           # TypeScript type definitions
    83â†’â”‚   â””â”€â”€ public/
    84â†’â”‚       â””â”€â”€ data/
    85â†’â”‚           â””â”€â”€ color-palettes.json  # Theme configuration
    86â†’â”œâ”€â”€ backup/                     # Legacy vanilla JS version
    87â†’â”œâ”€â”€ next.config.js             # Next.js configuration
    88â†’â”œâ”€â”€ tailwind.config.ts         # Tailwind CSS configuration
    89â†’â””â”€â”€ package.json
    90â†’```
    91â†’
    92â†’### Component Architecture
    93â†’
    94â†’#### HeatMap Component (`/src/components/visualizations/HeatMap.tsx`)
    95â†’
    96â†’**Key Implementation Details:**
    97â†’- Uses P5.js in instance mode within React
    98â†’- Loads theme configuration asynchronously for font sizes
    99â†’- Uses `paletteRef` for color palette to avoid re-renders
   100â†’- Implements `p.noLoop()` for static visualizations
   101â†’- Properly cleans up P5 instances on unmount
   102â†’
   103â†’**Memory Leak Fix (Dec 2025):**
   104â†’The component previously had an infinite loop caused by including `fontSizes` state in the useEffect dependency array while also modifying it within the effect. This created:
   105â†’- Thousands of P5.js instances per second
   106â†’- Runaway memory consumption (94+ GB observed)
   107â†’- Browser crashes
   108â†’
   109â†’**Solution:**
   110â†’- Removed `fontSizes` state entirely
   111â†’- Font sizes loaded as local variables in the effect
   112â†’- P5 sketch captures these variables in closure
   113â†’- useEffect dependencies: `[data, width, height, onError]` only
   114â†’- No circular dependency = no infinite loop
   115â†’
   116â†’**Code Pattern:**
   117â†’```typescript
   118â†’useEffect(() => {
   119â†’  let p5: any
   120â†’  let isMounted = true
   121â†’
   122â†’  const loadP5 = async () => {
   123â†’    // Load font sizes as local variables (not state)
   124â†’    let labelSize = 12
   125â†’    let valueSize = 10
   126â†’
   127â†’    try {
   128â†’      const [loadedLabelSize, loadedValueSize] = await Promise.all([
   129â†’        TypographyUtils.getVisualizationFontSize('heatmap', 'labelSize'),
   130â†’        TypographyUtils.getVisualizationFontSize('heatmap', 'fontSize')
   131â†’      ])
   132â†’      labelSize = loadedLabelSize
   133â†’      valueSize = loadedValueSize
   134â†’    } catch (error) {
   135â†’      console.warn('Using default font sizes')
   136â†’    }
   137â†’
   138â†’    // Create P5 sketch using local variables
   139â†’    const sketch = (p: any) => {
   140â†’      p.setup = () => {
   141â†’        // ... setup code
   142â†’        p.noLoop() // Static visualization
   143â†’      }
   144â†’
   145â†’      p.draw = () => {
   146â†’        // Uses labelSize and valueSize from closure
   147â†’      }
   148â†’    }
   149â†’
   150â†’    p5 = new P5(sketch)
   151â†’  }
   152â†’
   153â†’  loadP5()
   154â†’
   155â†’  return () => {
   156â†’    isMounted = false
   157â†’    if (p5) p5.remove()
   158â†’  }
   159â†’}, [data, width, height, onError]) // No fontSizes!
   160â†’```
   161â†’
   162â†’#### SystemModel Component (`/src/components/visualizations/SystemModel.tsx`)
   163â†’
   164â†’**Purpose**: Simulates discrete-time state-space systems and visualizes them as stocks-and-flows diagrams with animated particles.
   165â†’
   166â†’**Key Features:**
   167â†’- **Force-directed graph layout** - States positioned based on A matrix structure
   168â†’- **Draggable nodes** - Click and drag any node to reposition
   169â†’- **Interactive hover info** - Shows connectivity metrics, flow rates, and connections
   170â†’- **Animated flow particles** - Variable velocity based on flow magnitude
   171â†’- **Bidirectional edge handling** - Parallel pipes for reverse connections
   172â†’- **Export capabilities** - CSV, JSON, copy current state
   173â†’- **Direct navigation** - "View Phase Portrait" button to State Space Visualizer
   174â†’
   175â†’**Implementation Patterns:**
   176â†’```typescript
   177â†’// Use refs to avoid P5 re-mounting on state changes
   178â†’const currentTimeIndexRef = useRef(0)
   179â†’const [currentTimeIndex, setCurrentTimeIndex] = useState(0)
   180â†’
   181â†’useEffect(() => {
   182â†’  currentTimeIndexRef.current = currentTimeIndex
   183â†’}, [currentTimeIndex])
   184â†’
   185â†’// P5 reads from ref instead of state
   186â†’p.draw = () => {
   187â†’  const idx = currentTimeIndexRef.current // No re-mount!
   188â†’  // ... use idx
   189â†’}
   190â†’```
   191â†’
   192â†’**Force-Directed Layout:**
   193â†’- Initializes states in circle
   194â†’- Spring forces between connected nodes (proportional to |A[i][j]|)
   195â†’- Repulsion forces prevent overlap
   196â†’- Centering force keeps layout bounded
   197â†’- 300 iterations for stable configuration
   198â†’
   199â†’**Bidirectional Edge Detection:**
   200â†’```typescript
   201â†’// Build adjacency map
   202â†’const edgeMap = new Map<string, Edge>()
   203â†’edges.forEach(edge => {
   204â†’  edgeMap.set(`${edge.from.id}->${edge.to.id}`, edge)
   205â†’})
   206â†’
   207â†’// Detect reverse edges
   208â†’edges.forEach(edge => {
   209â†’  if (edge.from.id === edge.to.id) return // Skip self-loops
   210â†’
   211â†’  const reverseKey = `${edge.to.id}->${edge.from.id}`
   212â†’  if (edgeMap.get(reverseKey)) {
   213â†’    // Mark as bidirectional with parallel offset
   214â†’    edge.bidirectional = true
   215â†’    edge.parallelOffset = BIDIRECTIONAL_OFFSET
   216â†’  }
   217â†’})
   218â†’```
   219â†’
   220â†’**Critical Learning - Conditional Rendering vs Disabled:**
   221â†’Initially used `disabled={!hasData}` for export buttons. Problem: buttons visible but unusable created confusion.
   222â†’
   223â†’Solution: Conditional rendering for primary actions
   224â†’```typescript
   225â†’{hasSimulationData && (
   226â†’  <button onClick={openInStateSpaceVisualizer}>
   227â†’    ğŸ¨ View Phase Portrait
   228â†’  </button>
   229â†’)}
   230â†’```
   231â†’
   232â†’Benefits:
   233â†’- Clearer UI - button only appears when functional
   234â†’- Prevents errors - no risk of clicking when no data
   235â†’- Better UX - users see what's available
   236â†’
   237â†’#### StateSpaceVisualization Component (`/src/components/visualizations/StateSpaceVisualization.tsx`)
   238â†’
   239â†’**Purpose**: Displays phase portraits (state vs state plots) from time series data.
   240â†’
   241â†’**Key Features:**
   242â†’- **Multi-plot grid** - Shows all state pairs (upper triangle only)
   243â†’- **Interactive state selection** - Toggle which states to visualize
   244â†’- **Trajectory trails** - Adjustable length showing recent history
   245â†’- **Current point tracking** - Red dot shows current position
   246â†’- **Complete trajectory** - Faint gray line shows full path
   247â†’- **Dual format support** - Accepts simple JSON or System Simulator exports
   248â†’
   249â†’**Data Integration:**
   250â†’```typescript
   251â†’// Accepts System Simulator export format
   252â†’interface SystemSimulatorExport {
   253â†’  metadata?: { title, dt, timeHorizon }
   254â†’  system?: { A, B, C, D, labels }
   255â†’  results: { t, x, u, y }  // Extract x and t for phase portrait
   256â†’}
   257â†’
   258â†’// Or simple format
   259â†’interface StateSpaceData {
   260â†’  t: number[]
   261â†’  x: number[][]  // [timeStep][stateIndex]
   262â†’  labels?: string[]
   263â†’  title?: string
   264â†’}
   265â†’```
   266â†’
   267â†’**SessionStorage Integration:**
   268â†’Seamless navigation from System Simulator:
   269â†’```typescript
   270â†’// In SystemModel.tsx
   271â†’const openInStateSpaceVisualizer = () => {
   272â†’  const stateSpaceData = {
   273â†’    t: simulationRef.current.t,
   274â†’    x: simulationRef.current.x,
   275â†’    labels: data.labels?.states,
   276â†’    title: data.title
   277â†’  }
   278â†’  sessionStorage.setItem('stateSpaceData', JSON.stringify(stateSpaceData))
   279â†’  router.push('/statespace')
   280â†’}
   281â†’
   282â†’// In statespace/page.tsx
   283â†’useEffect(() => {
   284â†’  const sessionData = sessionStorage.getItem('stateSpaceData')
   285â†’  if (sessionData) {
   286â†’    const parsedData = JSON.parse(sessionData)
   287â†’    setStateSpaceData(parsedData)
   288â†’    sessionStorage.removeItem('stateSpaceData') // Clear after use
   289â†’  }
   290â†’}, [])
   291â†’```
   292â†’
   293â†’**Grid Layout Calculation:**
   294â†’For n selected states, shows n(n-1)/2 plots (upper triangle):
   295â†’```typescript
   296â†’const plotsPerRow = Math.ceil(Math.sqrt(gridSize * (gridSize - 1) / 2))
   297â†’const plotWidth = width / plotsPerRow
   298â†’const plotHeight = height / Math.ceil((gridSize * (gridSize - 1) / 2) / plotsPerRow)
   299â†’
   300â†’// Draw only i < j pairs
   301â†’for (let i = 0; i < selected.length; i++) {
   302â†’  for (let j = i + 1; j < selected.length; j++) {
   303â†’    drawPhasePlot(stateI, stateJ, ...)
   304â†’  }
   305â†’}
   306â†’```
   307â†’
   308â†’#### VectorField Component (`/src/components/visualizations/VectorField.tsx`)
   309â†’
   310â†’**Purpose**: Visualizes 2D and 3D vector fields with trajectory integration for linear and nonlinear dynamical systems.
   311â†’
   312â†’**Key Features:**
   313â†’- **2D/3D rendering** - Automatic mode selection based on system dimension
   314â†’- **Vector field display** - Normalized arrows color-coded by magnitude (blue=low, red=high)
   315â†’- **Interactive trajectory addition** - Click (2D) or input fields (3D) to add trajectories
   316â†’- **RK4 integration** - Accurate trajectory computation using 4th-order Runge-Kutta
   317â†’- **Configurable simulation time** - User-adjustable from 5-60 seconds
   318â†’- **Playback controls** - Animation with timeline scrubber
   319â†’- **Color legend** - Visual (2D) or text (3D) explanation of magnitude colors
   320â†’- **Cross-page navigation** - Integrated with System Simulator and State Space Visualizer
   321â†’
   322â†’**Data Format:**
   323â†’```typescript
   324â†’interface VectorFieldData {
   325â†’  // System definition (choose one)
   326â†’  A?: number[][]                    // Linear: dx/dt = Ax
   327â†’  f?: (x: number[]) => number[]     // Nonlinear: dx/dt = f(x)
   328â†’
   329â†’  // Metadata
   330â†’  labels?: string[]                 // State labels
   331â†’  title?: string
   332â†’
   333â†’  // Display options
   334â†’  dimension?: 2 | 3                 // 2D or 3D visualization
   335â†’  selectedStates?: number[]         // Which states to visualize
   336â†’
   337â†’  // Bounds (auto-calculated if not provided)
   338â†’  bounds?: {
   339â†’    min: number[]
   340â†’    max: number[]
   341â†’  }
   342â†’}
   343â†’
   344â†’interface VectorFieldTrajectory {
   345â†’  id: string
   346â†’  x0: number[]                      // Initial condition
   347â†’  points: number[][]                // Trajectory points [time][state]
   348â†’  t: number[]                       // Time points
   349â†’  color: string                     // Display color
   350â†’}
   351â†’```
   352â†’
   353â†’**Implementation Highlights:**
   354â†’
   355â†’1. **2D Click-to-Add Trajectories:**
   356â†’```typescript
   357â†’p.mousePressed = () => {
   358â†’  if (!is3D && p.mouseX > 50 && p.mouseX < width - 50) {
   359â†’    // Inverse map with Y-axis flip for mathematical convention
   360â†’    const x = p.map(p.mouseX, 50, width - 50, xMin, xMax)
   361â†’    const y = p.map(p.mouseY, height - 200, 50, yMin, yMax)  // Note: inverted!
   362â†’
   363â†’    integrateTrajectory([x, y])
   364â†’  }
   365â†’}
   366â†’```
   367â†’
   368â†’2. **3D Input Fields:**
   369â†’```typescript
   370â†’const handleAdd3DTrajectory = () => {
   371â†’  // Parse and validate input coordinates
   372â†’  const x = parseFloat(ic3DX)
   373â†’  const y = parseFloat(ic3DY)
   374â†’  const z = parseFloat(ic3DZ)
   375â†’
   376â†’  // Build full state vector
   377â†’  const fullState = new Array(n).fill(0)
   378â†’  fullState[selectedStates[0]] = x
   379â†’  fullState[selectedStates[1]] = y
   380â†’  fullState[selectedStates[2]] = z
   381â†’
   382â†’  // Integrate using RK4
   383â†’  integrateTrajectory(fullState)
   384â†’}
   385â†’```
   386â†’
   387â†’3. **RK4 Integration:**
   388â†’```typescript
   389â†’for (let i = 0; i < steps; i++) {
   390â†’  t.push(i * dt)
   391â†’  points.push([...state])
   392â†’
   393â†’  // 4th-order Runge-Kutta
   394â†’  const k1 = evaluateSystem(state)
   395â†’  const k2 = evaluateSystem(state.map((si, j) => si + 0.5 * dt * k1[j]))
   396â†’  const k3 = evaluateSystem(state.map((si, j) => si + 0.5 * dt * k2[j]))
   397â†’  const k4 = evaluateSystem(state.map((si, j) => si + dt * k3[j]))
   398â†’
   399â†’  state = state.map((si, j) =>
   400â†’    si + (dt / 6) * (k1[j] + 2 * k2[j] + 2 * k3[j] + k4[j])
   401â†’  )
   402â†’}
   403â†’```
   404â†’
   405â†’4. **Color Coding by Magnitude:**
   406â†’```typescript
   407â†’function magnitudeToColor(mag: number, maxMag: number): [number, number, number] {
   408â†’  const normalized = Math.min(mag / (maxMag || 1), 1)
   409â†’  const r = Math.floor(normalized * 255)  // Red for high
   410â†’  const b = Math.floor((1 - normalized) * 255)  // Blue for low
   411â†’  return [r, 100, b]
   412â†’}
   413â†’```
   414â†’
   415â†’5. **Auto-Calculated Bounds:**
   416â†’```typescript
   417â†’function calculateBounds(data: VectorFieldData) {
   418â†’  if (data.A) {
   419â†’    // For linear systems: estimate from A matrix magnitude
   420â†’    let maxVal = 0
   421â†’    for (let i = 0; i < n; i++) {
   422â†’      for (let j = 0; j < n; j++) {
   423â†’        maxVal = Math.max(maxVal, Math.abs(data.A[i][j]))
   424â†’      }
   425â†’    }
   426â†’    const bound = Math.max(5, maxVal * 3)
   427â†’    return {
   428â†’      min: new Array(n).fill(-bound),
   429â†’      max: new Array(n).fill(bound)
   430â†’    }
   431â†’  }
   432â†’  // Default for nonlinear systems
   433â†’  return { min: [-10, -10, -10], max: [10, 10, 10] }
   434â†’}
   435â†’```
   436â†’
   437â†’**SessionStorage Integration:**
   438â†’```typescript
   439â†’// From System Simulator
   440â†’const openInVectorField = () => {
   441â†’  const vectorFieldData = {
   442â†’    A: data.A,
   443â†’    labels: data.labels?.states,
   444â†’    title: data.title || 'System Vector Field',
   445â†’    dimension: data.A.length <= 2 ? 2 : 3
   446â†’  }
   447â†’  sessionStorage.setItem('vectorFieldData', JSON.stringify(vectorFieldData))
   448â†’  router.push('/vectorfield')
   449â†’}
   450â†’
   451â†’// Also stores system matrix when navigating to State Space
   452â†’sessionStorage.setItem('systemMatrix', JSON.stringify({ A, labels, title }))
   453â†’```
   454â†’
   455â†’**Demo Systems:**
   456â†’
   457â†’1. **Mass-Spring-Damper (2D):**
   458â†’```typescript
   459â†’const k = 4, m = 1, c = 0.5
   460â†’const A = [
   461â†’  [0, 1],
   462â†’  [-k/m, -c/m]
   463â†’]
   464â†’// Shows spiral convergence to equilibrium
   465â†’```
   466â†’
   467â†’2. **Lorenz Attractor (3D):**
   468â†’```typescript
   469â†’const sigma = 10, rho = 28, beta = 8/3
   470â†’const f = (x: number[]) => {
   471â†’  const [x1, x2, x3] = x
   472â†’  return [
   473â†’    sigma * (x2 - x1),
   474â†’    x1 * (rho - x3) - x2,
   475â†’    x1 * x2 - beta * x3
   476â†’  ]
   477â†’}
   478â†’// Famous chaotic system with butterfly attractor
   479â†’```
   480â†’
   481â†’**Key Learnings:**
   482â†’
   483â†’1. **Y-Axis Inversion Bug** âš ï¸
   484â†’   - P5.js coordinates: y increases downward
   485â†’   - Math convention: y increases upward
   486â†’   - **Fix**: Inverse mapping must flip both directions
   487â†’   ```typescript
   488â†’   // Forward: state â†’ canvas
   489â†’   const mapY = (y: number) => p.map(y, yMin, yMax, height-200, 50)
   490â†’
   491â†’   // Inverse: canvas â†’ state (MUST match forward flip!)
   492â†’   const y = p.map(p.mouseY, height-200, 50, yMin, yMax)  // Correct!
   493â†’   // NOT: p.map(p.mouseY, 50, height-200, yMin, yMax)     // Wrong - reflects on x-axis!
   494â†’   ```
   495â†’
   496â†’2. **WEBGL Limitations** âš ï¸
   497â†’   - `p.hint()` not available in WEBGL mode
   498â†’   - Can't easily draw 2D overlays on 3D canvas
   499â†’   - **Solution**: Skip visual legend in 3D, use text description instead
   500â†’   ```typescript
   501â†’   // Don't do this in WEBGL:
   502â†’   p.hint(p.DISABLE_DEPTH_TEST)  // Error: hint is not a function
   503â†’
   504â†’   // Instead: conditional rendering
   505â†’   if (data.dimension === 2) {
   506â†’     drawColorLegend(p)  // Works fine in 2D mode
   507â†’   } else {
   508â†’     // Show text description in UI controls
   509â†’   }
   510â†’   ```
   511â†’
   512â†’3. **3D Click Input Challenges**
   513â†’   - Can't reliably map 2D click â†’ 3D position
   514â†’   - **Solution**: Input fields with bounds validation
   515â†’   ```typescript
   516â†’   // Check if coordinates are within bounds
   517â†’   if (x < xMin || x > xMax || y < yMin || y > yMax || z < zMin || z > zMax) {
   518â†’     alert(`Coordinates out of bounds! Use:\nx âˆˆ [${xMin}, ${xMax}]...`)
   519â†’   }
   520â†’   ```
   521â†’
   522â†’4. **Optional Chaining for Bounds Safety**
   523â†’   - Bounds may not be loaded when component first renders
   524â†’   - **Fix**: Use optional chaining and fallbacks
   525â†’   ```typescript
   526â†’   {bounds.min[stateIdx]?.toFixed(1) || '?'}  // Safe
   527â†’   // NOT: bounds.min[stateIdx].toFixed(1)     // Can crash!
   528â†’   ```
   529â†’
   530â†’5. **Simulation Time as User Control**
   531â†’   - Hardcoded time (20s) not flexible for all systems
   532â†’   - **Solution**: Slider with sensible limits (5-60s)
   533â†’   - Chaotic systems need longer time to show full dynamics
   534â†’   - Damped systems converge quickly, shorter time sufficient
   535â†’
   536â†’**Navigation Flow:**
   537â†’```
   538â†’System Simulator â†’ [View Vector Field] â†’ Vector Field (with A matrix)
   539â†’                â†’ [View Phase Portrait] â†’ State Space (with trajectories)
   540â†’                                        â†’ [View Vector Field] â†’ Vector Field (if system matrix available)
   541â†’
   542â†’Vector Field â†’ [System Simulator] â†’ System Model page
   543â†’            â†’ [Phase Portrait] â†’ State Space page
   544â†’```
   545â†’
   546â†’### Utility Classes (`/src/lib/utils.ts`)
   547â†’
   548â†’#### ColorUtils
   549â†’- **Static color palette generation** - Viridis, Plasma, Inferno, Magma, etc.
   550â†’- **Theme configuration loading** - Loads from `/data/color-palettes.json`
   551â†’- **Caching** - Static properties cache theme config (bounded size, safe)
   552â†’
   553â†’#### TypographyUtils
   554â†’- **Font size management** - Loads visualization-specific font sizes from theme
   555â†’- **Fallback handling** - Returns defaults if theme loading fails
   556â†’
   557â†’#### DataParser
   558â†’- **URL parameter parsing** - Extracts and validates JSON from query strings
   559â†’- **Error handling** - Graceful fallbacks for malformed data
   560â†’
   561â†’#### FileHandler
   562â†’- **Drag & drop support** - File upload with validation
   563â†’- **JSON parsing** - Client-side JSON validation
   564â†’- **Cleanup functions** - Returns cleanup function for event listeners
   565â†’
   566â†’### Data Flow
   567â†’
   568â†’1. **Page Load**
   569â†’   - Next.js renders page component
   570â†’   - Checks URL parameters via `DataParser.parseURLParams()`
   571â†’   - Loads demo data if no URL data provided
   572â†’
   573â†’2. **User Uploads File**
   574â†’   - `FileUploadZone` handles drag/drop or click to upload
   575â†’   - Validates JSON structure
   576â†’   - Calls `onFileUpload` callback with parsed data
   577â†’
   578â†’3. **Visualization Renders**
   579â†’   - React component receives data prop
   580â†’   - useEffect loads P5.js dynamically (code splitting)
   581â†’   - Loads theme config (fonts, colors)
   582â†’   - Creates P5 instance with sketch
   583â†’   - P5 renders visualization on canvas
   584â†’
   585â†’4. **Palette Change**
   586â†’   - Separate useEffect watches `colorPalette` prop
   587â†’   - Loads new palette data
   588â†’   - Updates `paletteRef.current`
   589â†’   - Calls `p5Instance.updateDisplay()` to redraw
   590â†’
   591â†’## JSON Data Formats
   592â†’
   593â†’### Heat Map Data
   594â†’```json
   595â†’{
   596â†’  "data": [[1, 2, 3], [4, 5, 6], [7, 8, 9]],
   597â†’  "labels": {
   598â†’    "x": ["A", "B", "C"],
   599â†’    "y": ["Row 1", "Row 2", "Row 3"]
   600â†’  },
   601â†’  "colorScale": "viridis",
   602â†’  "title": "Sample Heat Map"
   603â†’}
   604â†’```
   605â†’
   606â†’### Color Palette Theme Config
   607â†’Located at `/public/data/color-palettes.json`:
   608â†’```json
   609â†’{
   610â†’  "palettes": {
   611â†’    "viridis": { "type": "sequential", "colors": 256 },
   612â†’    "plasma": { "type": "sequential", "colors": 256 }
   613â†’  },
   614â†’  "typography": {
   615â†’    "heatmap": {
   616â†’      "titleSize": 24,
   617â†’      "labelSize": 14,
   618â†’      "fontSize": 12
   619â†’    }
   620â†’  }
   621â†’}
   622â†’```
   623â†’
   624â†’## Performance Considerations
   625â†’
   626â†’### Memory Management
   627â†’- **P5 Instance Cleanup** - Always call `p5.remove()` in useEffect cleanup
   628â†’- **Avoid State in Dependencies** - Don't include state that's modified within the effect
   629â†’- **Use Refs for Mutable Data** - `paletteRef` used instead of state to prevent re-renders
   630â†’- **Static Visualizations** - Call `p.noLoop()` for non-animated visualizations
   631â†’
   632â†’### Best Practices
   633â†’1. **Load P5 dynamically** - `await import('p5')` for code splitting
   634â†’2. **Use local variables** - For data that doesn't need to trigger re-renders
   635â†’3. **Cleanup event listeners** - Remove all listeners in useEffect return function
   636â†’4. **Monitor dependencies** - Only include values that should trigger re-creation
   637â†’
   638â†’### Common Pitfalls
   639â†’
   640â†’#### Pitfall 1: State in Effect Dependencies
   641â†’âŒ **DON'T**: Include state in dependencies if you modify it in the effect
   642â†’```typescript
   643â†’useEffect(() => {
   644â†’  setFontSize(20) // Modifies state
   645â†’}, [fontSize]) // Depends on it = INFINITE LOOP
   646â†’```
   647â†’
   648â†’âœ… **DO**: Use local variables or refs
   649â†’```typescript
   650â†’useEffect(() => {
   651â†’  let fontSize = 20
   652â†’  // Load async...
   653â†’  fontSize = loadedSize
   654â†’  // Use in sketch closure
   655â†’}, [data]) // Only depends on data
   656â†’```
   657â†’
   658â†’#### Pitfall 2: P5 Reading from State
   659â†’âŒ **DON'T**: Read state directly in P5 draw loop (causes re-mount on every state change)
   660â†’```typescript
   661â†’const [currentIndex, setCurrentIndex] = useState(0)
   662â†’
   663â†’useEffect(() => {
   664â†’  const sketch = (p) => {
   665â†’    p.draw = () => {
   666â†’      const idx = currentIndex // Causes re-mount!
   667â†’    }
   668â†’  }
   669â†’  p5 = new P5(sketch)
   670â†’}, [currentIndex]) // P5 recreated every frame!
   671â†’```
   672â†’
   673â†’âœ… **DO**: Use refs for values P5 needs to read
   674â†’```typescript
   675â†’const currentIndexRef = useRef(0)
   676â†’const [currentIndex, setCurrentIndex] = useState(0)
   677â†’
   678â†’useEffect(() => {
   679â†’  currentIndexRef.current = currentIndex
   680â†’}, [currentIndex])
   681â†’
   682â†’useEffect(() => {
   683â†’  const sketch = (p) => {
   684â†’    p.draw = () => {
   685â†’      const idx = currentIndexRef.current // No re-mount!
   686â†’    }
   687â†’  }
   688â†’  p5 = new P5(sketch)
   689â†’}, [data]) // Only re-create when data changes
   690â†’```
   691â†’
   692â†’#### Pitfall 3: Disabled vs Hidden Buttons
   693â†’âŒ **DON'T**: Leave buttons visible when they can't function
   694â†’```typescript
   695â†’<button disabled={!hasData}>Export</button>
   696â†’// Button visible but grayed out - confusing UX
   697â†’```
   698â†’
   699â†’âœ… **DO**: Conditionally render buttons that require preconditions
   700â†’```typescript
   701â†’{hasData && <button>Export</button>}
   702â†’// Button only appears when it can actually work
   703â†’```
   704â†’
   705â†’Exception: Use `disabled` for buttons that should always be visible but temporarily inactive (e.g., "Next" button at end of list).
   706â†’
   707â†’## Development Workflow
   708â†’
   709â†’### Local Development
   710â†’```bash
   711â†’npm run dev       # Start dev server on localhost:3000
   712â†’npm run build     # Build for production
   713â†’npm run lint      # Run ESLint
   714â†’```
   715â†’
   716â†’### Static Export
   717â†’```bash
   718â†’npm run build     # Creates /out directory
   719â†’npm run export    # Alias for build (configured in next.config.js)
   720â†’```
   721â†’
   722â†’### Deployment
   723â†’- **GitHub Pages** - Push to `gh-pages` branch or use GitHub Actions
   724â†’- **Static hosting** - All files in `/out` can be served from any static host
   725â†’- **Base path** - Configure `basePath` in `next.config.js` for subdirectory hosting
   726â†’
   727â†’## Browser Compatibility
   728â†’- **Modern browsers** - Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
   729â†’- **ES modules** - Native ESM support required
   730â†’- **Canvas/WebGL** - P5.js requires canvas API
   731â†’- **Async/await** - Modern JavaScript features throughout
   732â†’
   733â†’## Known Issues & Solutions
   734â†’
   735â†’### Issue: Memory Leak in P5 Components
   736â†’**Symptom**: Browser memory grows to 10s of GB
   737â†’**Cause**: Infinite useEffect loop creating P5 instances
   738â†’**Solution**: Remove state variables from dependencies if modified within effect
   739â†’
   740â†’### Issue: Font Sizes Not Loading
   741â†’**Symptom**: Default font sizes used instead of theme values
   742â†’**Cause**: Async loading completes after P5 instance created
   743â†’**Solution**: Load theme config before creating sketch, use local variables
   744â†’
   745â†’### Issue: Palette Not Updating
   746â†’**Symptom**: Changing palette doesn't update visualization
   747â†’**Cause**: P5 sketch doesn't re-run on palette change
   748â†’**Solution**: Separate useEffect watches palette, calls `p5Instance.updateDisplay()`
   749â†’
   750â†’## Recent Additions (December 2025)
   751â†’
   752â†’### System Model Simulator
   753â†’- Force-directed graph layout based on A matrix structure
   754â†’- Draggable nodes with visual feedback
   755â†’- Interactive node info panels showing connectivity and flow metrics
   756â†’- Bidirectional edge detection with parallel pipe rendering
   757â†’- Export to CSV, JSON, and clipboard
   758â†’- One-click navigation to State Space Visualizer
   759â†’
   760â†’### State Space Visualizer
   761â†’- Phase portrait grid showing all state pairs
   762â†’- Interactive state selection (minimum 2 states)
   763â†’- Adjustable trajectory trail length
   764â†’- Dual format support (simple JSON + System Simulator exports)
   765â†’- SessionStorage integration for seamless navigation
   766â†’- Real-time playback with timeline scrubbing
   767â†’
   768â†’### Integration Pattern
   769â†’```
   770â†’System Simulator â†’ "View Phase Portrait" â†’ State Space Visualizer
   771â†’                    â†“ sessionStorage â†“
   772â†’              Automatic data transfer, zero friction
   773â†’```
   774â†’
   775â†’## Future Enhancements
   776â†’- [ ] Vector field visualization (see planning section below)
   777â†’- [ ] PNG/SVG export for visualizations
   778â†’- [ ] Real-time data streaming via WebSocket
   779â†’- [ ] Collaborative features with shareable URLs
   780â†’- [ ] 3D phase portraits with WebGL
   781â†’- [ ] Accessibility improvements (ARIA labels, keyboard navigation)
   782â†’- [ ] WebAssembly for intensive computations
   783â†’- [ ] Bifurcation diagrams for parameter studies
   784â†’
   785â†’## Contributing
   786â†’When modifying P5.js components:
   787â†’1. Always test memory usage in browser DevTools
   788â†’2. Ensure useEffect dependencies are correct
   789â†’3. Call `p.remove()` in cleanup function
   790â†’4. Use refs for data that shouldn't trigger re-renders
   791â†’5. Document async loading patterns
   792â†’
   793â†’## Resources
   794â†’- [Next.js Documentation](https://nextjs.org/docs)
   795â†’- [P5.js Reference](https://p5js.org/reference/)
   796â†’- [React Hooks](https://react.dev/reference/react)
   797â†’- [Tailwind CSS](https://tailwindcss.com/docs)
   798â†’
   799â†’---
   800â†’
   801â†’## PLANNING: Vector Field Visualizer
   802â†’
   803â†’### Design Decisions Required
   804â†’
   805â†’**Instructions**: Fill in your requirements below. Once complete, notify Claude to review this section and implement.
   806â†’
   807â†’#### 1. System Definition & Input
   808â†’**Question**: What type of systems should it support?
   809â†’- [ ] Linear only: `dx/dt = Ax` (2Ã—2 or 3Ã—3 matrix)?
   810â†’- [ ] Linear with input: `dx/dt = Ax + Bu`?
   811â†’- [ ] Nonlinear: `dx/dt = f(x)` with custom functions?
   812â†’
   813â†’**Your Answer**:
   814â†’Requirements: 
   815â†’- the visualiser shall accept only linear systems of any dimension. However, Claude should keep in mind that future changes might consider extending this to non-linear systems. 
   816â†’
   817â†’**Question**: How should users input the system?
   818â†’- [ ] Manual matrix entry (text fields)?
   819â†’- [ ] JSON upload (from System Simulator)?
   820â†’- [ ] Predefined examples?
   821â†’- [ ] Connection to System Simulator (import A matrix directly)?
   822â†’
   823â†’**Your Answer**:
   824â†’Requirements: 
   825â†’1. The visualiser shall accept user input in the following manner:
   826â†’   1. JSON upload via a standardised JSON format analogous to the phase-portrait visualiser. 
   827â†’   2. Via taking the data output from the system simulator, analogous to the phase-portrait visualiser. 
   828â†’   3. The system shall contain a predefined example, the same default system as the system simulator (mass spring damper). 
   829â†’2. Future changes may warrant direct matrix design, but this is not the priority. 
   830â†’---
   831â†’
   832â†’#### 2. Dimensionality & Projection
   833â†’**Question**: Which dimensions to visualize?
   834â†’- [ ] 2D only (x1 vs x2)?
   835â†’- [ ] 3D vector fields?
   836â†’- [ ] For higher-dimensional systems (n>2), select which 2 states to plot?
   837â†’
   838â†’**Your Answer**:
   839â†’Requirements:
   840â†’
   841â†’1. General capabilities:
   842â†’   1. The user shall have the capability to switch the axes on which the states sit. 
   843â†’      1. In the context of a 2D vector field, this means inversion, or a flipping of the axes.
   844â†’      2. In the context of a 3D vector field, this means rotating the selected states. 
   845â†’   2. The user shall have the capability to open a number of windows. For example, the user can have two windows of 2D fields next to one another OR one windows of 3D and one windows of 2D field next to one another OR two windows of 3D visualisations next to one another. 
   846â†’   3. The user shall have the capability to place a 'ball' in the vector field, and simulate the system over a defined time period. 
   847â†’      1. The user shall have the capability to view the ball progress through the simulation on all the different visualisation windows. 
   848â†’
   849â†’
   850â†’2. For systems that contain up to two states:
   851â†’   1. The user shall have the capability to view ONLY a 2D visualisations of vector fields. 
   852â†’   2. Systems of a single state shall return an error explaining that the minimum number of states is two. 
   853â†’   3. For systems that only contain two states, the 3D visualisation shall NOT be visible, and should return an error to the user. 
   854â†’
   855â†’3. For systems that contain three or more states:
   856â†’   1. The user shall have the capability to view either 2D or 3D vector fields. 
   857â†’   2. The user shall be able to select which states to view in each visualisation window, with a maximum of three states viewable for any given window. 
   858â†’
   859â†’
   860â†’**Question**: For 3+ state systems, how to handle other states?
   861â†’- [ ] Fix them at zero?
   862â†’- [ ] Fix at equilibrium values?
   863â†’- [ ] User-specified slice through state space?
   864â†’
   865â†’**Your Answer**:
   866â†’Requirements:
   867â†’1. The user shall have the option to toggle between:
   868â†’   1. Fix all other states at zero. 
   869â†’   2. Fix all other states at equilibrium values. 
   870â†’   3. Fix all other states at other predefined values, given by the user. 
   871â†’   4. Default to fixing all other states at zero. 
   872â†’2. Claude shall consider best practice UI & UX design when considering how to implement this. 
   873â†’
   874â†’---
   875â†’
   876â†’#### 3. Vector Field Representation
   877â†’**Question**: How to display the field?
   878â†’- [ ] Arrow grid (classic)?
   879â†’- [ ] Streamlines/flow lines?
   880â†’- [ ] Both options (user toggle)?
   881â†’- [ ] Color coding by magnitude?
   882â†’
   883â†’**Your Answer**:
   884â†’Requirements:
   885â†’1. The user shall have the option to switch between:
   886â†’   1. Arrow grid
   887â†’   2. Streamlines
   888â†’2. The colour coding shall be done by magnitude. 
   889â†’
   890â†’**Question**: Arrow scaling?
   891â†’- [ ] Normalized (all same length, shows direction only)?
   892â†’- [ ] Proportional to magnitude (shows speed)?
   893â†’- [ ] Log-scaled for large dynamic ranges?
   894â†’
   895â†’**Your Answer**:
   896â†’Requirements:
   897â†’1. The visualiser shall only utilise normalized arrows. 
   898â†’2. The visualiser shall show magnitude through colour. 
   899â†’3. The visualiser shall user a log-scale only under circumstances where they are warranted. 
   900â†’
   901â†’---
   902â†’
   903â†’#### 4. Grid & Bounds
   904â†’**Question**: State space range?
   905â†’- [ ] Fixed (e.g., -10 to 10)?
   906â†’- [ ] User-adjustable?
   907â†’- [ ] Auto-calculated from eigenvalues/system characteristics?
   908â†’
   909â†’**Your Answer**:
   910â†’Requirements:
   911â†’1. The visualiser shall:
   912â†’   1. Autocalculate the grid and bounds based on eigenvalue characteristics. 
   913â†’   2. Based on the autocalculated values, the user shall have the capability to adjust these values. 
   914â†’
   915â†’**Question**: Grid density?
   916â†’- [ ] Fixed grid (e.g., 20Ã—20)?
   917â†’- [ ] User-adjustable slider?
   918â†’- [ ] Adaptive (denser near interesting features)?
   919â†’
   920â†’**Your Answer**:
   921â†’Requirements:
   922â†’1. The grid shall be fixed and consistent, based on the state space range.
   923â†’2. The user may change the grid bounds.
   924â†’   1. In the case the user decides to alter the grid bounds, a button shall appear, giving the user the option to recalculate the grid. 
   925â†’
   926â†’---
   927â†’
   928â†’#### 5. Trajectory Integration
   929â†’**Question**: Should users be able to plot solution trajectories?
   930â†’- [ ] Click to add initial condition â†’ show trajectory?
   931â†’- [ ] Multiple trajectories simultaneously?
   932â†’- [ ] Forward time, backward time, or both?
   933â†’- [ ] Integration method (Euler, RK4)?
   934â†’
   935â†’**Your Answer**:
   936â†’Requirements:
   937â†’1. The visualiser shall have the capability to plot a solution trajectory. 
   938â†’   1. The visualiser shall allow a maximum two simultaneous trajectories to be plotted. 
   939â†’   2. The visualiser shall only calculate forward time trajectories. 
   940â†’   3. The visualiser shall store data on forward time trajectories, and the user shall have the capability to go backwards through the calculated trajectory. 
   941â†’      1. The user shall go backwards through the calculated trajectory using a scrubber. 
   942â†’2. The integration method used shall be the most computationally efficient. 
   943â†’
   944â†’**Question**: Trajectory visualization?
   945â†’- [ ] Animated point moving along path?
   946â†’- [ ] Full path drawn?
   947â†’- [ ] Fading trail?
   948â†’
   949â†’**Your Answer**:
   950â†’Requirements:
   951â†’1. The trajectory visualisation shall contain:
   952â†’   1. An animated point moving along a path. 
   953â†’2. The user shall have the option to select between a fading trail and the full path up to the point calculated. 
   954â†’
   955â†’---
   956â†’
   957â†’#### 6. Analysis Features
   958â†’**Question**: What analytical tools to include?
   959â†’- [ ] Equilibrium points (where dx/dt = 0)?
   960â†’- [ ] Nullclines (isoclines where one state doesn't change)?
   961â†’- [ ] Eigenvectors of A matrix?
   962â†’- [ ] Stability classification (saddle, stable node, unstable spiral, etc.)?
   963â†’- [ ] Lyapunov function contours?
   964â†’
   965â†’**Your Answer**:
   966â†’Requirements:
   967â†’1. The visualiser shall contain toggles for the following analysis features:
   968â†’   1. Equilibrium points
   969â†’   2. Nullclines and isoclines. 
   970â†’   3. Stability classifiers. 
   971â†’   4. Lyapunov function contours. 
   972â†’
   973â†’---
   974â†’
   975â†’#### 7. Interactivity
   976â†’**Question**: What interactions should be supported?
   977â†’- [ ] Click to add trajectories?
   978â†’- [ ] Drag matrix sliders to see real-time changes?
   979â†’- [ ] Zoom/pan the view?
   980â†’- [ ] Toggle nullclines/eigenvectors on/off?
   981â†’
   982â†’**Your Answer**:
   983â†’Requirements:
   984â†’1. The user shall have the ability to:
   985â†’   1. Click to add a trajectory. 
   986â†’   2. Pan and zoom. 
   987â†’   3. Toggle the analysis features off individually. 
   988â†’
   989â†’---
   990â†’
   991â†’#### 8. Integration with Existing Pages
   992â†’**Question**: How should it connect to other tools?
   993â†’- [ ] "View Vector Field" button in System Simulator (like Phase Portrait)?
   994â†’- [ ] Only for 2-state systems?
   995â†’- [ ] Extract 2D subsystems from higher-dimensional systems?
   996â†’
   997â†’**Your Answer**:
   998â†’Requirements:
   999â†’1. There shall be a button in the system simulator page that links to the vector field page. 
  1000â†’2. There shall be a button in the phase portrait page that links to the vector field page. 
  1001â†’3. There shall be two buttons in the vector field page that link to both the system simulator page and the phase portrait page. 
  1002â†’
  1003â†’---
  1004â†’
  1005â†’#### 9. Predefined Examples
  1006â†’**Question**: What examples to include?
  1007â†’
  1008â†’**Your Answer**:
  1009â†’Requirements:
  1010â†’1. The predefined example to include shall be a mass-spring-damper system for a 2D vector field. 
  1011â†’2. The predefined example to include shall be a lorenz attrctor for a 3D vector field. 
  1012â†’
  1013â†’---
  1014â†’
  1015â†’#### 10. Performance & Rendering
  1016â†’**Question**: Technology choice?
  1017â†’- [ ] P5.js (consistent with other visualizations)?
  1018â†’- [ ] Canvas API directly (better performance)?
  1019â†’- [ ] WebGL for 3D?
  1020â†’
  1021â†’**Your Answer**:
  1022â†’Claude shall decide what the best technologies are to implement this page. 
  1023â†’Claude should factor in extensibility when considering the technologies to use. 
  1024â†’
  1025â†’---
  1026â†’
  1027â†’### Summary of Requirements
  1028â†’Once you've filled in the sections above, provide a brief summary here:
  1029â†’
  1030â†’**Must-have features for v1**:
  1031â†’1. 2D/3D switch, switching from mass spring damper to lorenz attractor. 
  1032â†’2. extensible technology choice.
  1033â†’
  1034â†’**Nice-to-have features for later**:
  1035â†’All the rest shall be implemented step by step. 
  1036â†’
  1037â†’**Special considerations**:
  1038â†’
  1039â†’
  1040â†’---
  1041â†’**STATUS**: â³ Awaiting user input. Notify Claude when ready to implement.
  1042â†’
  1043â†’---
  1044â†’---
  1045â†’
  1046â†’## PLANNING: Agent-Based Modeling (ABM) Simulator
  1047â†’
  1048â†’**Vision Statement:**
  1049â†’Create a general-purpose agent-based modeling platform that can simulate diverse systems (social, transport, ecological, etc.) from JSON configuration files. Support both visualized and non-visualized (fast) execution modes. Use a flexible framework based on: Environment + Agents + Interaction Rules.
  1050â†’
  1051â†’The ABM simulator is strictly 2D. 
  1052â†’
  1053â†’Thinking:
  1054â†’1. Should use ODD protocol: [examples](https://jasss.soc.surrey.ac.uk/23/2/7/S2-ODD.pdf)
  1055â†’
  1056â†’
  1057â†’---
  1058â†’
  1059â†’### 1. Framework Architecture & Design Philosophy
  1060â†’
  1061â†’**Question**: How should we structure the ABM framework to maximize generality while remaining practical?
  1062â†’
  1063â†’**Considerations**:
  1064â†’- Object-oriented approach (Agent class, Environment class, Simulation class)?
  1065â†’- Entity-Component-System (ECS) pattern for maximum flexibility?
  1066â†’- behaviour composition (agents have pluggable behaviors)?
  1067â†’- Event-driven vs tick-based simulation loop?
  1068â†’- How to balance ease of use vs extensibility?
  1069â†’
  1070â†’**Your Answer**:
  1071â†’Requirements:
  1072â†’1. The framework shall utilize the Entity-Component-System (ECS) pattern.
  1073â†’   1. **Entities** are unique identifiers with no intrinsic data or behaviour.
  1074â†’   2. **Components** are pure data containers, serializable to/from JSON.
  1075â†’   3. **Systems** are stateless processors that operate on entities possessing specific component combinations.
  1076â†’
  1077â†’2. The framework shall implement a three-layer architecture:
  1078â†’   1. **Layer 1 - JSON Model Definition**: Declarative specification of entities, components, behaviours, and rules following the ODD protocol.
  1079â†’   2. **Layer 2 - Primitives Library**: Domain-agnostic operations (spatial queries, vector math, state transitions, aggregations) that behaviours compose from.
  1080â†’   3. **Layer 3 - Interpreter Systems**: Execute composed behaviours by evaluating primitive operations against entity data.
  1081â†’
  1082â†’3. Behaviours shall emerge from **primitive composition**, not custom code.
  1083â†’   1. The framework shall provide primitives in these categories:
  1084â†’      - **Spatial**: `withinRadius`, `nearestN`, `inRegion`, `distance`
  1085â†’      - **Aggregation**: `average`, `sum`, `count`, `min`, `max`
  1086â†’      - **Steering**: `seek`, `flee`, `arrive`, `wander`, `separation`, `alignment`, `cohesion`
  1087â†’      - **Filters**: component presence, property comparisons, logical combinators
  1088â†’      - **State**: `transition`, `timer`, `counter`, `set`, `increment`
  1089â†’      - **Math**: `lerp`, `clamp`, `noise`, `sampleDistribution`, `arithmetic`
  1090â†’   2. New behaviours shall be created by composing existing primitives in JSON, not by writing code.
  1091â†’
  1092â†’---
  1093â†’
  1094â†’### 2. Agent Definition & Properties
  1095â†’
  1096â†’**Question**: What properties and capabilities should agents have? How are they specified in JSON?
  1097â†’
  1098â†’**Considerations**:
  1099â†’- Core properties: position, state, type, unique ID?
  1100â†’- Custom properties per agent type (e.g., "hunger" for predator, "speed" for vehicle)?
  1101â†’- Agent behaviours: movement, sensing, decision-making, communication?
  1102â†’- Agent lifecycle: birth, death, reproduction?
  1103â†’- Memory/history: do agents remember past states or interactions?
  1104â†’- Heterogeneous agents: can different agent types coexist in one simulation?
  1105â†’
  1106â†’**Your Answer**:
  1107â†’Requirements:
  1108â†’1. Agent definitions shall follow the ODD protocol's "Entities, State Variables, and Scales" section.
  1109â†’
  1110â†’2. The JSON shall define **component types** (schemas for data containers):
  1111â†’   1. Each component type shall declare its properties and their data types.
  1112â†’   2. Supported data types: `number`, `string`, `boolean`, `enum`, `vector2D`, `entityRef`, `entityRefArray`.
  1113â†’
  1114â†’3. The JSON shall define **archetypes** (templates for entity creation):
  1115â†’   1. An archetype specifies which components an entity has and their default values.
  1116â†’   2. Archetypes may inherit from other archetypes.
  1117â†’
  1118â†’4. Entity instantiation shall support:
  1119â†’   1. Explicit individual entities with specific property values.
  1120â†’   2. Bulk spawning with count, spatial distribution, and statistical variation on properties.
  1121â†’
  1122â†’5. Agent lifecycle events shall be declaratively specified:
  1123â†’   1. Creation conditions (spawning rules).
  1124â†’   2. Destruction conditions (death/removal criteria).
  1125â†’   3. Lifecycle events shall be defined as rules with conditions and effects.
  1126â†’
  1127â†’6. All agents shall automatically have:
  1128â†’   1. A unique ID (auto-generated).
  1129â†’   2. A `Position` component if spatial simulation is enabled.
  1130â†’
  1131â†’---
  1132â†’
  1133â†’### 3. Environment Representation
  1134â†’
  1135â†’**Question**: How should the environment be structured? What types of spatial models should we support?
  1136â†’
  1137â†’**Considerations**:
  1138â†’- Continuous 2D/3D space (x, y, z coordinates)?
  1139â†’- Discrete grid (cellular automata style)?
  1140â†’- Network/graph topology (nodes and edges)?
  1141â†’- Toroidal boundaries (wrap-around) vs hard boundaries?
  1142â†’- Environmental properties: resources, terrain, obstacles, zones?
  1143â†’- Multi-layer environments (e.g., ground + air layers)?
  1144â†’- Environment dynamics: does the environment change over time?
  1145â†’
  1146â†’**Your Answer**:
  1147â†’Requirements:
  1148â†’1. The JSON shall define spatial structure under an `environment` or `scales.spatial` key.
  1149â†’
  1150â†’2. Supported spatial types:
  1151â†’   1. `continuous2D`: Continuous x, y coordinates within bounds.
  1152â†’   2. `grid2D`: Discrete cells with integer coordinates.
  1153â†’   3. `network`: Graph topology with nodes and edges (agents occupy nodes or traverse edges).
  1154â†’
  1155â†’3. Boundary conditions:
  1156â†’   1. `toroidal` (default): Agents wrap around edges.
  1157â†’   2. `bounded`: Agents cannot exit; collision or reflection at edges.
  1158â†’   3. `infinite`: No boundaries (use with caution for performance).
  1159â†’
  1160â†’4. The environment shall support **spatial indexing** for efficient neighbour queries:
  1161â†’   1. For `continuous2D`: Quadtree or spatial hash grid (implementation detail, not user-facing).
  1162â†’   2. For `grid2D`: Direct cell lookup.
  1163â†’   3. For `network`: Adjacency list traversal.
  1164â†’
  1165â†’5. The environment may define **static features**:
  1166â†’   1. Obstacles (regions agents cannot enter).
  1167â†’   2. Zones (named regions that affect behaviour or are queryable).
  1168â†’   3. Resource fields (scalar values at positions, e.g., food density).
  1169â†’
  1170â†’6. Environment dynamics:
  1171â†’   1. Static features may have update rules (e.g., resource regeneration).
  1172â†’   2. Environment rules follow the same primitive composition as agent behaviours.
  1173â†’
  1174â†’---
  1175â†’
  1176â†’### 4. Interaction Rules & Behaviours
  1177â†’
  1178â†’**Question**: How do agents interact with each other and the environment? How are these rules specified?
  1179â†’
  1180â†’**Considerations**:
  1181â†’- Sensing radius: how far can agents "see"?
  1182â†’- Interaction types: collision, communication, resource transfer, reproduction?
  1183â†’- Rule specification: hard-coded behaviours vs user-defined rules?
  1184â†’- Probabilistic vs deterministic interactions?
  1185â†’- Local vs global interactions (neighborhood vs broadcast)?
  1186â†’- Force-based interactions (attraction/repulsion like flocking)?
  1187â†’- Conditional behaviours: if-then rules, state machines, decision trees?
  1188â†’- Scripting language for custom behaviours (e.g., JavaScript expressions in JSON)?
  1189â†’
  1190â†’**Your Answer**:
  1191â†’Requirements:
  1192â†’1. No scripting or executable code shall be permitted in JSON. All logic shall be expressed as **structured rule definitions**.
  1193â†’
  1194â†’2. Rules shall follow a **condition â†’ effect** structure:
  1195â†’```
  1196â†’   {
  1197â†’     "name": "ruleName",
  1198â†’     "trigger": { ... },      // when to evaluate
  1199â†’     "condition": { ... },    // predicate tree (must be true to fire)
  1200â†’     "effect": { ... }        // what happens
  1201â†’   }
  1202â†’```
  1203â†’
  1204â†’3. **Conditions** shall be expressed as predicate trees, not strings:
  1205â†’   1. Comparison operators: `eq`, `neq`, `gt`, `gte`, `lt`, `lte`
  1206â†’   2. Logical operators: `and`, `or`, `not`
  1207â†’   3. Property access: `{ "prop": "self.ComponentName.property" }`
  1208â†’   4. Literal values: numbers, strings, booleans directly
  1209â†’   
  1210â†’   Example:
  1211â†’```json
  1212â†’   {
  1213â†’     "and": [
  1214â†’       { "gt": [{ "prop": "self.Energy.value" }, 50] },
  1215â†’       { "eq": [{ "prop": "self.State.status" }, "hungry"] }
  1216â†’     ]
  1217â†’   }
  1218â†’```
  1219â†’
  1220â†’4. **Effects** shall be expressed as operation trees:
  1221â†’   1. `set`: Assign a value to a property.
  1222â†’   2. `increment` / `decrement`: Modify numeric properties.
  1223â†’   3. `transition`: Change a state machine state.
  1224â†’   4. `spawn`: Create a new entity.
  1225â†’   5. `destroy`: Remove an entity.
  1226â†’   6. `emit`: Emit an event for logging/observation.
  1227â†’
  1228â†’5. **Triggers** define when rules are evaluated:
  1229â†’   1. `everyTick`: Evaluate each timestep.
  1230â†’   2. `onProximity`: Evaluate when entities are within range.
  1231â†’   3. `onStateChange`: Evaluate when a specific property changes.
  1232â†’   4. `onEvent`: Evaluate when a named event is emitted.
  1233â†’
  1234â†’6. **Probabilistic effects** shall be supported:
  1235â†’```json
  1236â†’   {
  1237â†’     "probability": { "mul": [0.03, { "prop": "source.Contagion.infectivity" }] },
  1238â†’     "effect": { "set": { "target": "self.Health.status", "value": "infected" } }
  1239â†’   }
  1240â†’```
  1241â†’
  1242â†’7. **Steering behaviors** shall be composable in JSON:
  1243â†’```json
  1244â†’   {
  1245â†’     "SteeringBehavior": {
  1246â†’       "rules": [
  1247â†’         { "type": "separation", "query": { "radius": 25 }, "weight": 1.5 },
  1248â†’         { "type": "cohesion", "query": { "radius": 50, "filter": { "hasComponent": "Flockmate" } }, "weight": 1.0 },
  1249â†’         { "type": "flee", "query": { "radius": 100, "filter": { "hasComponent": "Predator" } }, "weight": 3.0 }
  1250â†’       ]
  1251â†’     }
  1252â†’   }
  1253â†’```
  1254â†’
  1255â†’---
  1256â†’
  1257â†’### 5. JSON Data Format & Schema
  1258â†’
  1259â†’**Question**: What should the JSON structure look like? How do we make it intuitive yet powerful?
  1260â†’
  1261â†’**Considerations**:
  1262â†’- Top-level keys: simulation metadata, environment config, agent definitions, rules?
  1263â†’- Agent initialization: list of individual agents vs population specifications?
  1264â†’- Rule definitions: array of rule objects with conditions and actions?
  1265â†’- Parameter sweeps: support for multiple runs with varying parameters?
  1266â†’- Validation: JSON schema for type checking?
  1267â†’- Example ABM types to support initially:
  1268â†’  - Predator-prey (Lotka-Volterra)
  1269â†’  - Traffic/transportation
  1270â†’  - Epidemic spread (SIR model)
  1271â†’  - Social networks
  1272â†’  - Flocking/swarming
  1273â†’  - Cellular automata (Conway's Game of Life)
  1274â†’
  1275â†’**Your Answer**:
  1276â†’Requirements:
  1277â†’1. The JSON structure shall align with the ODD protocol:
  1278â†’```
  1279â†’   {
  1280â†’     "overview": { ... },
  1281â†’     "designConcepts": { ... },
  1282â†’     "details": { ... }
  1283â†’   }
  1284â†’```
  1285â†’
  1286â†’2. **Overview** section shall contain:
  1287â†’   1. `purpose`: String describing the model's purpose.
  1288â†’   2. `entities`: Component type definitions and archetypes.
  1289â†’   3. `stateVariables`: Alias for component properties (for ODD compliance).
  1290â†’   4. `scales`: Spatial and temporal configuration.
  1291â†’   5. `processSchedule`: Ordered list of systems to execute each tick.
  1292â†’
  1293â†’3. **Design Concepts** section shall contain:
  1294â†’   1. `sensing`: What information agents can perceive about others.
  1295â†’   2. `interaction`: Rules governing agent-agent and agent-environment interactions.
  1296â†’   3. `stochasticity`: Random seed and which processes use randomness.
  1297â†’   4. `observation`: What data to collect for output/visualization.
  1298â†’
  1299â†’4. **Details** section shall contain:
  1300â†’   1. `initialization`: Entity spawning rules, initial conditions, optional external data files.
  1301â†’   2. `submodels`: Named behavior modules composed from primitives.
  1302â†’   3. `interventions`: Conditional modifications triggered during simulation (optional).
  1303â†’
  1304â†’5. The framework shall validate JSON against a published JSON Schema before execution.
  1305â†’   1. Validation errors shall be reported with line numbers and clear messages.
  1306â†’   2. The schema shall be versioned (e.g., `"schemaVersion": "1.0"`).
  1307â†’
  1308â†’6. The JSON format shall be **LLM-friendly**:
  1309â†’   1. Consistent key naming (camelCase).
  1310â†’   2. No ambiguous overloading of keys.
  1311â†’   3. Explicit type indicators where needed.
  1312â†’   4. Reasonable defaults for optional fields.
  1313â†’
  1314â†’
  1315â†’---
  1316â†’
  1317â†’### 6. Simulation Engine & Execution
  1318â†’
  1319â†’**Question**: How should the simulation loop work? What scheduling and update mechanisms?
  1320â†’
  1321â†’**Considerations**:
  1322â†’- Timestep size: fixed dt vs variable (event-driven)?
  1323â†’- Update order: synchronous (all agents update at once) vs asynchronous (sequential)?
  1324â†’- Random vs deterministic ordering of agent updates?
  1325â†’- Scheduling: should certain agents/events happen at specific times?
  1326â†’- Termination conditions: fixed duration, equilibrium detection, custom criteria?
  1327â†’- Pause/resume/reset capabilities?
  1328â†’- Performance targets: how many agents should we support (100? 1000? 10000+)?
  1329â†’
  1330â†’**Your Answer**:
  1331â†’Requirements:
  1332â†’1. Timestep is a fixed dt determined in the json. 
  1333â†’2. Update order is asynchronous. 
  1334â†’3. Termination condition is a fixed duration of time, determined in the json file, and is an input field in the page. 
  1335â†’4. Buttons on the page shall include:
  1336â†’   1. Pause/resume/reset capabilities. 
  1337â†’5. Performance targets:
  1338â†’   1. The simulation shall support up to 100 agents. 
  1339â†’6. **Process scheduling** shall be explicitly defined in JSON:
  1340â†’   1. Systems execute in the order listed in `processSchedule`.
  1341â†’   2. Each system entry may specify:
  1342â†’      - `order`: `"parallel"` (all entities update simultaneously) or `"sequential"` (one at a time).
  1343â†’      - `shuffle`: If sequential, whether to randomize entity order each tick.
  1344â†’   
  1345â†’   Example:
  1346â†’```json
  1347â†’   {
  1348â†’     "processSchedule": [
  1349â†’       { "system": "Sensing", "order": "parallel" },
  1350â†’       { "system": "Decision", "order": "sequential", "shuffle": true },
  1351â†’       { "system": "Movement", "order": "parallel" },
  1352â†’       { "system": "Interaction", "order": "sequential", "shuffle": true }
  1353â†’     ]
  1354â†’   }
  1355â†’```
  1356â†’
  1357â†’7. **Stochasticity** shall be reproducible:
  1358â†’   1. A `seed` value in JSON determines all random number generation.
  1359â†’   2. If no seed is provided, a random seed is generated and reported.
  1360â†’   3. The UI shall display the current seed and allow the user to input a specific seed.
  1361â†’---
  1362â†’
  1363â†’### 7. Visualization Options
  1364â†’
  1365â†’**Question**: What should be visualized and how? What rendering technologies should we use?
  1366â†’
  1367â†’**Considerations**:
  1368â†’- ~~Rendering library: P5.js (consistency with other visualizations), raw Canvas 2D, WebGL (for 10,000+ agents)?~~
  1369â†’- ~~Visual representation of agents: circles/dots, sprites/images, custom shapes?~~
  1370â†’- ~~Color coding: by agent type, state, property value?~~
  1371â†’- Environment visualization: background, resource density heatmaps, obstacles?
  1372â†’- Trails: show agent movement history?
  1373â†’- Real-time graphs: population over time, resource levels, statistics?
  1374â†’- ~~2D vs 3D visualization (is 3D necessary for any ABM types)?~~
  1375â†’- ~~Zoom and pan controls?~~
  1376â†’- ~~Agent labels/tooltips on hover?~~
  1377â†’
  1378â†’**Your Answer**:
  1379â†’Requirements:
  1380â†’1. There shall be only a 2D visualisation of the model. 
  1381â†’2. There shall be no pan/zoom controls. 
  1382â†’3. The user shall be able to see current individual agent states when clicking on an agent.
  1383â†’4. The visual representation of agents shall be as coloured circles by default. 
  1384â†’   1. The user shall have the capability to define groups of agents, and for each group the json shall have the capability to define what shape is used per group. 
  1385â†’      1. The system shall accept icons from icon libraries to represent agents, referenced via a link to the icon. 
  1386â†’   2. If the json requests multiple groups and no shape is assigned for that group, then a random shape is assigned. 
  1387â†’   3. A legend shall display the groups, if there is more than one group. 
  1388â†’5. The agent-based model simulator is strictly 2D. 
  1389â†’   1. The simulator makes use of WebGL in order to optimise the simulation. 
  1390â†’6. There shall be no zoom or pan controls. The window shall show the full simulation. 
  1391â†’7. Colouring shall be defined as follows:
  1392â†’   1. By default, colouring shall be defined by the agent type. 
  1393â†’   2. The inputted json shall be able to define if the colouring should be determined by a particular agent state. The agent states shall contain a maximum and minimum range, as defined in the ODD. Therefore, the user shall be able to define two colours, representing the maximum and minimum range of the state. 
  1394â†’8. The environment
  1395â†’9. Real-time graphs
  1396â†’   1. The user shall be able to view two timeseries plots in two vertical windows below the simulation. 
  1397â†’   2. The first timeseries plot shall focus on the large-scale simulation, and should have tickboxes which determine which states to visualise. 
  1398â†’   3. The second timeseries plot shall focus on the individual agents. 
  1399â†’      1. The second plot shall have two dropdowns
  1400â†’         1. The first dropdown shall define which agent GROUP the user wishes to view the states for. 
  1401â†’         2. The second dropdown shall define which INDIVIDUAL agent the user wishes to view the states for. 
  1402â†’10. **Graph update frequency**: Time series plots shall update every N ticks (configurable, default 1).
  1403â†’
  1404â†’11. **Color interpolation**: When coloring by state value, interpolation shall be linear in RGB space by default.
  1405â†’
  1406â†’12. **Click-to-inspect**: When a user clicks an agent, a panel shall display:
  1407â†’    1. Entity ID
  1408â†’    2. Archetype name
  1409â†’    3. All component data as key-value pairs
  1410â†’    4. Option to "track" this agent (highlight it persistently)
  1411â†’
  1412â†’
  1413â†’---
  1414â†’
  1415â†’### 8. Non-Visualized Performance Mode
  1416â†’
  1417â†’**Question**: How should the "fast mode" work? What optimizations are needed?
  1418â†’
  1419â†’**Considerations**:
  1420â†’- Skip all rendering, run simulation logic only?
  1421â†’- Use Web Workers to avoid blocking UI?
  1422â†’- Batch processing: run N timesteps then update progress?
  1423â†’- Output options: final state only vs periodic snapshots vs full timeseries?
  1424â†’- Speed comparison target: how much faster should it be (10x? 100x?)?
  1425â†’- Progress reporting: how to show user that simulation is running?
  1426â†’- Memory management for long simulations?
  1427â†’
  1428â†’**Your Answer**:
  1429â†’For now do not implement this, but consider that this may be a feature added later on when architecting the software. 
  1430â†’
  1431â†’Requirements:
  1432â†’1. 
  1433â†’
  1434â†’---
  1435â†’
  1436â†’### 9. Data Output & Analytics
  1437â†’
  1438â†’**Question**: What data should be collected and exported? What analysis tools should be built-in?
  1439â†’
  1440â†’**Considerations**:
  1441â†’- Timeseries data: agent positions, states, population counts?
  1442â†’- Aggregate statistics: mean, variance, spatial density?
  1443â†’- Export formats: JSON (full state), CSV (timeseries), images/video (visualization)?
  1444â†’- Real-time plotting: population dynamics, phase portraits, histograms?
  1445â†’- Metrics specific to ABM type (e.g., clustering coefficient for social networks)?
  1446â†’- Integration with existing visualizers (state space, time series, network graphs)?
  1447â†’
  1448â†’**Your Answer**:
  1449â†’Requirements:
  1450â†’1. The JSON shall define an `observation` section specifying what data to collect:
  1451â†’```json
  1452â†’   {
  1453â†’     "observation": {
  1454â†’       "timeseries": [
  1455â†’         { "name": "susceptible", "query": { "count": { "filter": { "eq": ["Health.status", "S"] } } } },
  1456â†’         { "name": "avgSpeed", "query": { "average": { "property": "Velocity.magnitude" } } }
  1457â†’       ],
  1458â†’       "snapshots": {
  1459â†’         "every": 10,
  1460â†’         "include": ["Position", "Health"]
  1461â†’       },
  1462â†’       "events": ["infection", "death", "birth"]
  1463â†’     }
  1464â†’   }
  1465â†’```
  1466â†’
  1467â†’2. Export formats:
  1468â†’   1. **JSON**: Full simulation state or timeseries.
  1469â†’   2. **CSV**: Timeseries data with columns per observed metric.
  1470â†’
  1471â†’3. Event logging:
  1472â†’   1. Rules may emit named events via the `emit` effect.
  1473â†’   2. Events are logged with tick number, involved entity IDs, and event data.
  1474â†’   3. Event logs can be exported separately.
  1475â†’
  1476â†’---
  1477â†’
  1478â†’### 10. Integration with Existing Platform
  1479â†’
  1480â†’**Question**: How does ABM fit into the current visualization platform?
  1481â†’
  1482â†’**Considerations**:
  1483â†’- Page structure: similar to `/vectorfield` and `/systemmodel`?
  1484â†’- File upload zone for JSON configuration?
  1485â†’- Demo simulations with pre-loaded examples?
  1486â†’- Navigation: how to link from other pages (if at all)?
  1487â†’- Homepage listing: should it be in "System Models" or "Visualizations"?
  1488â†’- Data flow: can ABM results be exported to other visualizers?
  1489â†’
  1490â†’**Your Answer**:
  1491â†’Requirements:
  1492â†’1. The page structure shall be similar to `/vectorfield` and `/systemmodel`.
  1493â†’2. There shall be a file upload zone for the JSON configuration.
  1494â†’3. There shall be a preloaded example, namely Schellings segregation model, Conways game of life, and the predator prey system.
  1495â†’4. The homepage listing shall be under system models.
  1496â†’5. ABM results can be exported to other visualisers.
  1497â†’6. Page layout (top to bottom):
  1498â†’   1. Demo selector and file upload zone
  1499â†’   2. Simulation canvas (full width)
  1500â†’   3. Model Info section (below simulation, showing purpose, agent count, dt)
  1501â†’   4. Two timeseries graphs (aggregate population dynamics and individual agent metrics)
  1502â†’   5. Instructions panel
  1503â†’   6. Expected JSON Format section with example code block (like other visualization pages) 
  1504â†’
  1505â†’---
  1506â†’
  1507â†’### 11. Extensibility & Plugin System
  1508â†’
  1509â†’**Question**: How can users add custom behaviours without modifying core code?
  1510â†’
  1511â†’**Considerations**:
  1512â†’- Plugin architecture: allow users to define custom agent classes?
  1513â†’- behaviour composition: mix-and-match predefined behaviors?
  1514â†’- ~~Custom rules in JSON: support JavaScript expressions (eval) or safe subset?~~
  1515â†’- Template library: common behaviours (seek, flee, wander, flock)?
  1516â†’- Version compatibility: how to handle breaking changes?
  1517â†’
  1518â†’**Your Answer**:
  1519â†’Requirements:
  1520â†’1. No custom code or scripts shall be permitted in JSON (security requirement).
  1521â†’
  1522â†’2. Extensibility shall be achieved through **primitive composition**:
  1523â†’   1. Users create novel behaviors by combining existing primitives in JSON.
  1524â†’   2. The primitives library shall be comprehensive enough that most ABM behaviors are expressible.
  1525â†’
  1526â†’3. **Archetype inheritance** allows building complex agent types from simpler ones:
  1527â†’```json
  1528â†’   {
  1529â†’     "archetypes": {
  1530â†’       "BaseAgent": { "Position": {}, "Velocity": {} },
  1531â†’       "Prey": { "extends": "BaseAgent", "Health": { "value": 100 }, "FleesBehavior": { ... } },
  1532â†’       "SmartPrey": { "extends": "Prey", "Memory": { "capacity": 5 } }
  1533â†’     }
  1534â†’   }
  1535â†’```
  1536â†’
  1537â†’4. **Submodel modularity**: Named behavior modules can be defined once and referenced:
  1538â†’```json
  1539â†’   {
  1540â†’     "submodels": {
  1541â†’       "standardFlocking": {
  1542â†’         "type": "SteeringBehavior",
  1543â†’         "rules": [ ... ]
  1544â†’       }
  1545â†’     },
  1546â†’     "archetypes": {
  1547â†’       "Bird": {
  1548â†’         "Position": {},
  1549â†’         "Velocity": {},
  1550â†’         "SteeringBehavior": { "ref": "standardFlocking" }
  1551â†’       }
  1552â†’     }
  1553â†’   }
  1554â†’```
  1555â†’
  1556â†’5. Future consideration: A curated **behavior library** of pre-built submodels (flocking, SIR, pursuit-evasion) that users can import by name.
  1557â†’
  1558â†’---
  1559â†’
  1560â†’### 12. Demo Examples & Use Cases
  1561â†’
  1562â†’**Question**: What example simulations should we include to demonstrate capabilities?
  1563â†’
  1564â†’**Considerations**:
  1565â†’- Starter examples (must include):
  1566â†’  - Flocking/Boids (already have `/flocking` page - integrate or separate?)
  1567â†’  - Predator-prey dynamics
  1568â†’  - Epidemic spread (SIR/SEIR model)
  1569â†’  - Traffic simulation
  1570â†’  - Conway's Game of Life
  1571â†’- Domain coverage: ensure examples span social, ecological, physical systems
  1572â†’- Complexity gradient: simple â†’ intermediate â†’ advanced examples
  1573â†’- Educational value: can examples teach ABM concepts?
  1574â†’
  1575â†’**Your Answer**:
  1576â†’Requirements:
  1577â†’1. The framework shall ship with these example simulations:
  1578â†’   1. **Schelling's Segregation Model** â€” demonstrates grid-based movement, threshold rules.
  1579â†’   2. **Conway's Game of Life** â€” demonstrates cellular automata, grid environment.
  1580â†’   3. **Predator-Prey (Lotka-Volterra)** â€” demonstrates heterogeneous agents, reproduction, death.
  1581â†’   4. **Flocking (Boids)** â€” demonstrates steering behaviors, continuous space.
  1582â†’   5. **SIR Epidemic** â€” demonstrates state machines, probabilistic transmission.
  1583â†’
  1584â†’2. Examples shall be selectable from a dropdown in the UI.
  1585â†’
  1586â†’3. Each example shall include:
  1587â†’   1. The JSON configuration.
  1588â†’   2. A brief description displayed to the user.
  1589â†’   3. Suggested parameters to experiment with.
  1590â†’
  1591â†’---
  1592â†’
  1593â†’### 13. Performance & Scalability
  1594â†’
  1595â†’**Question**: What performance optimizations are critical? What are acceptable limits?
  1596â†’
  1597â†’**Considerations**:
  1598â†’- Spatial indexing: quadtree/grid for efficient neighbor searches?
  1599â†’- Level of detail: render fewer agents when zoomed out?
  1600â†’- Agent pooling: reuse objects instead of creating/destroying?
  1601â†’- Culling: only update/render agents in viewport?
  1602â†’- WebGL instancing for rendering thousands of similar agents?
  1603â†’- Progressive enhancement: graceful degradation for low-end devices?
  1604â†’- Benchmarking: what metrics to track (FPS, agents/sec, memory)?
  1605â†’
  1606â†’**Your Answer**:
  1607â†’Requirements:
  1608â†’1. The simulation shall support up to 100 agents at 60 FPS (as stated in Q6).
  1609â†’
  1610â†’2. **Spatial indexing** shall be implemented for neighbor queries:
  1611â†’   1. For continuous space: spatial hash grid or quadtree.
  1612â†’   2. Neighbor queries shall be O(k) where k is the number of neighbors, not O(n) where n is total agents.
  1613â†’
  1614â†’3. **Rendering optimization**:
  1615â†’   1. Use WebGL instanced rendering for drawing agents.
  1616â†’   2. Batch draw calls by visual type (shape + color).
  1617â†’
  1618â†’4. **Future consideration**: For non-visualized mode, Web Workers shall be used to avoid blocking the UI thread.
  1619â†’
  1620â†’---
  1621â†’
  1622â†’### 14. User Interface & Controls
  1623â†’
  1624â†’**Question**: What controls should users have during simulation? What parameters should be adjustable in real-time?
  1625â†’
  1626â†’**Considerations**:
  1627â†’- Playback: play, pause, step forward, reset?
  1628â†’- Speed control: 0.1x to 10x simulation speed?
  1629â†’- Live parameter adjustment: change agent behaviours while running?
  1630â†’- Add/remove agents manually (click to add, click to remove)?
  1631â†’- Visualization toggles: show/hide trails, labels, grid, zones?
  1632â†’- Camera controls: pan, zoom, rotate (if 3D)?
  1633â†’- Inspector: click agent to see detailed state?
  1634â†’
  1635â†’**Your Answer**:
  1636â†’Requirements:
  1637â†’1. **Playback controls**:
  1638â†’   1. Play / Pause button.
  1639â†’   2. Step forward (advance one tick while paused).
  1640â†’   3. Reset (return to initial state).
  1641â†’
  1642â†’2. **Speed control**:
  1643â†’   1. Slider or dropdown for simulation speed: 0.5x, 1x, 2x. 
  1644â†’   2. Speed affects ticks per second, not timestep size.
  1645â†’
  1646â†’3. **Parameter adjustment**:
  1647â†’   1. Key simulation parameters (as defined in JSON under a `uiParameters` section) shall be editable in the UI.
  1648â†’   2. Changes take effect immediately (next tick).
  1649â†’   3. Example:
  1650â†’```json
  1651â†’     {
  1652â†’       "uiParameters": [
  1653â†’         { "name": "Transmission Rate", "path": "diseaseParams.transmissionProb", "min": 0, "max": 1, "step": 0.01 }
  1654â†’       ]
  1655â†’     }
  1656â†’```
  1657â†’
  1658â†’4. **Visualization toggles**:
  1659â†’   1. Show/hide trails.
  1660â†’   2. Show/hide grid (if grid environment).
  1661â†’   3. Show/hide zones.
  1662â†’
  1663â†’5. **Inspector panel**: Click an agent to see its state (covered in Q7).
  1664â†’
  1665â†’---
  1666â†’
  1667â†’### 15. Technology Stack Decision
  1668â†’
  1669â†’**Question**: What rendering and computation technologies should we use?
  1670â†’
  1671â†’**Considerations**:
  1672â†’- Visualization: P5.js vs raw Canvas 2D vs WebGL?
  1673â†’  - P5.js: consistent with existing visualizations, easier to use
  1674â†’  - Canvas 2D: lighter weight, more control
  1675â†’  - WebGL: maximum performance for 10,000+ agents
  1676â†’- Web Workers: for non-visualized mode?
  1677â†’- WebAssembly: for compute-intensive simulations (physics, pathfinding)?
  1678â†’- State management: React state vs separate simulation controller?
  1679â†’- Type safety: TypeScript interfaces for all ABM components?
  1680â†’
  1681â†’**Your Answer**:
  1682â†’
  1683â†’Requirements:
  1684â†’
  1685â†’1. **Rendering**: PIXI.js (WebGL-based 2D renderer).
  1686â†’   1. Use `ParticleContainer` for efficient batch rendering of agents.
  1687â†’   2. Automatic fallback to Canvas 2D via PIXI's built-in detection.
  1688â†’   3. Target: 100 agents at 60 FPS (with headroom to 1000+).
  1689â†’
  1690â†’2. **Framework**: Integrate with existing platform (React, TypeScript).
  1691â†’   1. PIXI application shall be encapsulated in a React component.
  1692â†’   2. PIXI canvas lifecycle (create, resize, destroy) shall be managed via React `useEffect`.
  1693â†’
  1694â†’3. **Simulation logic**: Pure TypeScript, decoupled from rendering.
  1695â†’   1. Simulation state shall be serializable (for save/load, export).
  1696â†’   2. The ECS world shall be updated independently of the PIXI render loop.
  1697â†’   3. The renderer shall only read from the ECS world, never mutate it.
  1698â†’
  1699â†’4. **JSON validation**: Use Ajv for JSON Schema validation.
  1700â†’
  1701â†’5. **Expression evaluation**: Custom safe evaluator for predicate/operation trees (no `eval`, no `Function`).
  1702â†’
  1703â†’6. **State management**: 
  1704â†’   1. Simulation state managed by a controller class.
  1705â†’   2. React UI subscribes to state updates via callbacks or a lightweight event emitter.
  1706â†’   3. PIXI renderer subscribes to entity positions/visuals for rendering.
  1707â†’
  1708â†’---
  1709â†’
  1710â†’### Summary of Requirements
  1711â†’
  1712â†’Once you've filled in the sections above, provide a brief summary here:
  1713â†’
  1714â†’**Must-have features for v1**:
  1715â†’1.
  1716â†’2.
  1717â†’3.
  1718â†’
  1719â†’**Nice-to-have features for later**:
  1720â†’-
  1721â†’-
  1722â†’
  1723â†’**Special considerations**:
  1724â†’1. In creating this, consider that a LLM will be generating the json files. 
  1725â†’2. I want you to create a separate markdown file that describes how an LLM should generate the json. 
  1726â†’3. Define the system prompt for the LLM, and the user prompt. The user prompt will contain summarised text from a newspaper article, defined {{ $json.newsTextBody }}. 
  1727â†’
  1728â†’---
  1729â†’**STATUS**: â³ Awaiting user input. Notify Claude when ready to implement.
  1730â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
