The file /Users/sebastianozuddas/Programming/Website/simulator/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   152â†’  return () => {
   153â†’    isMounted = false
   154â†’    if (p5) p5.remove()
   155â†’  }
   156â†’}, [data, width, height, onError]) // No fontSizes!
   157â†’```
   158â†’
   159â†’#### SystemModel Component (`/src/components/visualizations/SystemModel.tsx`)
   160â†’
   161â†’**Purpose**: Simulates discrete-time state-space systems and visualizes them as stocks-and-flows diagrams with animated particles.
   162â†’
   163â†’**Key Features:**
   164â†’- **Force-directed graph layout** - States positioned based on A matrix structure
   165â†’- **Draggable nodes** - Click and drag any node to reposition
   166â†’- **Interactive hover info** - Shows connectivity metrics, flow rates, and connections
   167â†’- **Animated flow particles** - Variable velocity based on flow magnitude
   168â†’- **Bidirectional edge handling** - Parallel pipes for reverse connections
   169â†’- **Export capabilities** - CSV, JSON, copy current state
   170â†’- **Direct navigation** - "View Phase Portrait" button to State Space Visualizer
   171â†’
   172â†’**Implementation Patterns:**
   173â†’```typescript
   174â†’// Use refs to avoid P5 re-mounting on state changes
   175â†’const currentTimeIndexRef = useRef(0)
   176â†’const [currentTimeIndex, setCurrentTimeIndex] = useState(0)
   177â†’
   178â†’useEffect(() => {
   179â†’  currentTimeIndexRef.current = currentTimeIndex
   180â†’}, [currentTimeIndex])
   181â†’
   182â†’// P5 reads from ref instead of state
   183â†’p.draw = () => {
   184â†’  const idx = currentTimeIndexRef.current // No re-mount!
   185â†’  // ... use idx
   186â†’}
   187â†’```
   188â†’
   189â†’**Force-Directed Layout:**
   190â†’- Initializes states in circle
   191â†’- Spring forces between connected nodes (proportional to |A[i][j]|)
   192â†’- Repulsion forces prevent overlap
   193â†’- Centering force keeps layout bounded
   194â†’- 300 iterations for stable configuration
   195â†’
   196â†’**Bidirectional Edge Detection:**
   197â†’```typescript
   198â†’// Build adjacency map
   199â†’const edgeMap = new Map<string, Edge>()
   200â†’edges.forEach(edge => {
   201â†’  edgeMap.set(`${edge.from.id}->${edge.to.id}`, edge)
   202â†’})
   203â†’
   204â†’// Detect reverse edges
   205â†’edges.forEach(edge => {
   206â†’  if (edge.from.id === edge.to.id) return // Skip self-loops
   207â†’
   208â†’  const reverseKey = `${edge.to.id}->${edge.from.id}`
   209â†’  if (edgeMap.get(reverseKey)) {
   210â†’    // Mark as bidirectional with parallel offset
   211â†’    edge.bidirectional = true
   212â†’    edge.parallelOffset = BIDIRECTIONAL_OFFSET
   213â†’  }
   214â†’})
   215â†’```
   216â†’
   217â†’**Critical Learning - Conditional Rendering vs Disabled:**
   218â†’Initially used `disabled={!hasData}` for export buttons. Problem: buttons visible but unusable created confusion.
   219â†’
   220â†’Solution: Conditional rendering for primary actions
   221â†’```typescript
   222â†’{hasSimulationData && (
   223â†’  <button onClick={openInStateSpaceVisualizer}>
   224â†’    ðŸŽ¨ View Phase Portrait
   225â†’  </button>
   226â†’)}
   227â†’```
   228â†’
   229â†’Benefits:
   230â†’- Clearer UI - button only appears when functional
   231â†’- Prevents errors - no risk of clicking when no data
   232â†’- Better UX - users see what's available
   233â†’
   234â†’#### StateSpaceVisualization Component (`/src/components/visualizations/StateSpaceVisualization.tsx`)
   235â†’
   236â†’**Purpose**: Displays phase portraits (state vs state plots) from time series data.
   237â†’
   238â†’**Key Features:**
   239â†’- **Multi-plot grid** - Shows all state pairs (upper triangle only)
   240â†’- **Interactive state selection** - Toggle which states to visualize
   241â†’- **Trajectory trails** - Adjustable length showing recent history
   242â†’- **Current point tracking** - Red dot shows current position
   243â†’- **Complete trajectory** - Faint gray line shows full path
   244â†’- **Dual format support** - Accepts simple JSON or System Simulator exports
   245â†’
   246â†’**Data Integration:**
   247â†’```typescript
   248â†’// Accepts System Simulator export format
   249â†’interface SystemSimulatorExport {
   250â†’  metadata?: { title, dt, timeHorizon }
   251â†’  system?: { A, B, C, D, labels }
   252â†’  results: { t, x, u, y }  // Extract x and t for phase portrait
   253â†’}
   254â†’
   255â†’// Or simple format
   256â†’interface StateSpaceData {
   257â†’  t: number[]
   258â†’  x: number[][]  // [timeStep][stateIndex]
   259â†’  labels?: string[]
   260â†’  title?: string
   261â†’}
   262â†’```
   263â†’
   264â†’**SessionStorage Integration:**
   265â†’Seamless navigation from System Simulator:
   266â†’```typescript
   267â†’// In SystemModel.tsx
   268â†’const openInStateSpaceVisualizer = () => {
   269â†’  const stateSpaceData = {
   270â†’    t: simulationRef.current.t,
   271â†’    x: simulationRef.current.x,
   272â†’    labels: data.labels?.states,
   273â†’    title: data.title
   274â†’  }
   275â†’  sessionStorage.setItem('stateSpaceData', JSON.stringify(stateSpaceData))
   276â†’  router.push('/statespace')
   277â†’}
   278â†’
   279â†’// In statespace/page.tsx
   280â†’useEffect(() => {
   281â†’  const sessionData = sessionStorage.getItem('stateSpaceData')
   282â†’  if (sessionData) {
   283â†’    const parsedData = JSON.parse(sessionData)
   284â†’    setStateSpaceData(parsedData)
   285â†’    sessionStorage.removeItem('stateSpaceData') // Clear after use
   286â†’  }
   287â†’}, [])
   288â†’```
   289â†’
   290â†’**Grid Layout Calculation:**
   291â†’For n selected states, shows n(n-1)/2 plots (upper triangle):
   292â†’```typescript
   293â†’const plotsPerRow = Math.ceil(Math.sqrt(gridSize * (gridSize - 1) / 2))
   294â†’const plotWidth = width / plotsPerRow
   295â†’const plotHeight = height / Math.ceil((gridSize * (gridSize - 1) / 2) / plotsPerRow)
   296â†’
   297â†’// Draw only i < j pairs
   298â†’for (let i = 0; i < selected.length; i++) {
   299â†’  for (let j = i + 1; j < selected.length; j++) {
   300â†’    drawPhasePlot(stateI, stateJ, ...)
   301â†’  }
   302â†’}
   303â†’```
   304â†’
   305â†’### Utility Classes (`/src/lib/utils.ts`)
   306â†’
   307â†’#### ColorUtils