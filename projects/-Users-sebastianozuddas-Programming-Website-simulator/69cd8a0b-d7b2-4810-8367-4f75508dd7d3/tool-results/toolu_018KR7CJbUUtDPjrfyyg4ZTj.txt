     1→'use client'
     2→
     3→import { useEffect, useRef, useState } from 'react'
     4→import type { SystemModelData, VisualizationProps } from '@/types'
     5→
     6→interface SystemModelProps extends VisualizationProps {
     7→  data: SystemModelData
     8→}
     9→
    10→// Simulation result storing all time steps
    11→interface SimulationResult {
    12→  t: number[]      // Time points
    13→  x: number[][]    // State trajectories [timeStep][stateIndex]
    14→  u: number[][]    // Input trajectories [timeStep][inputIndex]
    15→  y: number[][]    // Output trajectories [timeStep][outputIndex]
    16→}
    17→
    18→// Node for visualization
    19→interface Node {
    20→  id: string
    21→  type: 'input' | 'state' | 'output'
    22→  index: number
    23→  label: string
    24→  x: number
    25→  y: number
    26→  value: number
    27→}
    28→
    29→// Edge for visualization
    30→interface Edge {
    31→  from: Node
    32→  to: Node
    33→  weight: number
    34→  flowRate: number
    35→}
    36→
    37→// Particle for flow animation
    38→interface Particle {
    39→  edge: Edge
    40→  progress: number  // 0 to 1
    41→  active: boolean
    42→}
    43→
    44→export default function SystemModel({
    45→  data,
    46→  width = 1200,
    47→  height = 800,
    48→  onError
    49→}: SystemModelProps) {
    50→  const canvasRef = useRef<HTMLDivElement>(null)
    51→  const controlsRef = useRef<HTMLDivElement>(null)
    52→  const [p5Instance, setP5Instance] = useState<any>(null)
    53→  const simulationRef = useRef<SimulationResult | null>(null)
    54→  const [currentTimeIndex, setCurrentTimeIndex] = useState(0)
    55→  const [isPlaying, setIsPlaying] = useState(false)
    56→  const [simulationError, setSimulationError] = useState<string | null>(null)
    57→
    58→  // Run simulation when data changes
    59→  useEffect(() => {
    60→    if (!data) return
    61→
    62→    try {
    63→      const result = runSimulation(data)
    64→      simulationRef.current = result
    65→      setCurrentTimeIndex(0)
    66→      setSimulationError(null)
    67→    } catch (error) {
    68→      const errorMsg = error instanceof Error ? error.message : 'Simulation failed'
    69→      setSimulationError(errorMsg)
    70→      onError?.(errorMsg)
    71→    }
    72→  }, [data, onError])
    73→
    74→  // Auto-play animation
    75→  useEffect(() => {
    76→    if (!isPlaying || !simulationRef.current) return
    77→
    78→    const interval = setInterval(() => {
    79→      setCurrentTimeIndex((prev) => {
    80→        if (!simulationRef.current) return prev

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
