488-
489-          function evaluateSystem(state: number[]): number[] {
490-            if (data.f) {
491-              // Nonlinear system
492-              return data.f(state)
493-            } else if (data.A) {
494-              / Linear system: dx/dt = Ax
495-              const n = state.length
496-              const dState = new Array(n).fill(0)
497-              for (let i = 0; i < n; i++) {
498-                for (let j = 0; j < n; j++) {
499-                  dState[i] += data.A[i][j] * state[j]
500-                }
501-              }
502-              return dState
503-            }
504-            return new Array(state.length).fill(0)
505-          }
506-
507-          function magnitudeToColor(mag: number, maxMag: number): [number, number, number] {
508-            // Map magnitude to color (blue = low, red = high)
509-            const normalized = Math.min(mag / (maxMag || 1), 1)
510-            const r = Math.floor(normalized * 255)
511-            const b = Math.floor((1 - normalized) * 255)
512-            return [r, 100, b]
513-          }
514-
515-          // Mouse click to add trajectory
516-          p.mousePressed = () => {
517-            if (!is3D && p.mouseX > 50 && p.mouseX < width - 50 && p.mouseY > 50 && p.mouseY < height - 200) {
518:              addTrajectoryFromClick(p)
519-              return false
520-            }
521-          }
522-
523:          function addTrajectoryFromClick(p: any) {
524-            if (trajectories.length >= 2) return // Max 2 trajectories
525-
526-            const selectedStates = data.selectedStates || [0, 1]
527-            const stateX = selectedStates[0]
528-            const stateY = selectedStates[1]
529-
530-            const xMin = bounds!.min[stateX]
531-            const xMax = bounds!.max[stateX]
532-            const yMin = bounds!.min[stateY]
533-            const yMax = bounds!.max[stateY]
534-
535-            const mapX = (x: number) => p.map(x, xMin, xMax, 50, width - 50)
536-            const mapY = (y: number) => p.map(y, yMin, yMax, height - 200, 50)
537-
538-            // Inverse map
539-            const x = p.map(p.mouseX, 50, width - 50, xMin, xMax)
540-            const y = p.map(p.mouseY, 50, height - 200, yMin, yMax)
541-
542-            // Build initial condition
543-            const n = data.A?.length || 2
544-            const x0 = new Array(n).fill(0)
545-            x0[stateX] = x
546-            x0[stateY] = y
547-
548-            // Integrate trajectory
549-            const traj = integrateTrajectory(x0)
550-            setTrajectories(prev => [...prev, traj])
551-            setCurrentTimeIndex(0)
552-          }
553-