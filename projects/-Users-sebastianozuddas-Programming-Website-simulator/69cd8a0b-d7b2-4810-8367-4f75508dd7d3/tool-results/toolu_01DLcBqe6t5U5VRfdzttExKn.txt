     1â†’# Data Visualization Platform - Next.js Edition
     2â†’
     3â†’## Project Overview
     4â†’A modern data visualization platform built with Next.js 15, React 18, TypeScript, and P5.js. Provides interactive data visualizations including heat maps, scatter plots, particle systems, and more. Configured for static export to GitHub Pages.
     5â†’
     6â†’## Tech Stack
     7â†’
     8â†’### Frontend Framework
     9â†’- **Next.js 15** - React framework with App Router
    10â†’- **React 18** - UI library with hooks and modern patterns
    11â†’- **TypeScript** - Type-safe development
    12â†’- **Tailwind CSS** - Utility-first styling
    13â†’
    14â†’### Visualization
    15â†’- **P5.js** - Creative coding library for visualizations
    16â†’- **Client-side rendering** - All visualizations render in browser
    17â†’
    18â†’### Build & Deploy
    19â†’- **Static Export** - `output: 'export'` for GitHub Pages
    20â†’- **GitHub Pages** - Static hosting with CDN
    21â†’- **No server-side dependencies** - Pure client-side application
    22â†’
    23â†’## Core Features
    24â†’
    25â†’### 1. Interactive Visualizations
    26â†’- **Heat Maps** - `/heatmap` - 2D data matrices with color-coded intensity
    27â†’- **Scatter Plots** - `/scatter` - Plot relationships between variables
    28â†’- **Geospatial Data** - `/geospatial` - Map-based visualizations
    29â†’- **Time Series** - `/timeseries` - Data changes over time
    30â†’- **Network Graphs** - `/network` - Connections and relationships
    31â†’- **Bar Charts** - `/barchart` - Categorical data comparison
    32â†’
    33â†’### 2. System Models & Simulations
    34â†’- **State-Space System** - `/systemmodel` - Discrete-time system simulation with stocks and flows
    35â†’- **Vector Field Visualizer** - `/vectorfield` - 2D/3D vector field visualization with trajectory integration
    36â†’- **State Space Visualizer** - `/statespace` - Phase portraits and trajectory visualization
    37â†’- **Agent-Based Modeling** - `/abm` - General-purpose ABM platform with ECS architecture
    38â†’- **Particle System** - `/particles` - Physics-based particle simulation
    39â†’- **Flocking behaviour** - `/flocking` - Emergent group behavior simulation
    40â†’
    41â†’### 3. Data Input Methods
    42â†’1. **URL Parameters** - JSON data encoded in query string
    43â†’2. **File Upload** - Drag & drop JSON files with validation
    44â†’3. **PostMessage API** - For iframe embedding and external communication
    45â†’4. **Demo Data** - Built-in example datasets for each visualization
    46â†’
    47â†’### 4. Theming & Customization
    48â†’- **Color Palettes** - Multiple built-in palettes (Viridis, Plasma, Inferno, etc.)
    49â†’- **Typography** - Theme-based font sizing from `color-palettes.json`
    50â†’- **Responsive Design** - Adapts to different screen sizes
    51â†’
    52â†’## Architecture
    53â†’
    54â†’### Directory Structure
    55â†’```
    56â†’/simulator
    57â†’â”œâ”€â”€ src/
    58â†’â”‚   â”œâ”€â”€ app/                    # Next.js App Router pages
    59â†’â”‚   â”‚   â”œâ”€â”€ page.tsx           # Home page / visualization gallery
    60â†’â”‚   â”‚   â”œâ”€â”€ layout.tsx         # Root layout with metadata
    61â†’â”‚   â”‚   â”œâ”€â”€ heatmap/
    62â†’â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # Heat map visualization page
    63â†’â”‚   â”‚   â”œâ”€â”€ systemmodel/
    64â†’â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # System model simulator page
    65â†’â”‚   â”‚   â”œâ”€â”€ vectorfield/
    66â†’â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # Vector field visualizer page
    67â†’â”‚   â”‚   â”œâ”€â”€ statespace/
    68â†’â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # State space/phase portrait page
    69â†’â”‚   â”‚   â”œâ”€â”€ abm/               # Agent-Based Modeling
    70â†’â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx       # ABM main page
    71â†’â”‚   â”‚   â”‚   â””â”€â”€ demos/         # Demo model definitions
    72â†’â”‚   â”‚   â”‚       â”œâ”€â”€ flocking.ts
    73â†’â”‚   â”‚   â”‚       â”œâ”€â”€ sir.ts
    74â†’â”‚   â”‚   â”‚       â””â”€â”€ predatorPrey.ts
    75â†’â”‚   â”‚   â””â”€â”€ globals.css        # Global styles + Tailwind
    76â†’â”‚   â”œâ”€â”€ components/
    77â†’â”‚   â”‚   â”œâ”€â”€ visualizations/
    78â†’â”‚   â”‚   â”‚   â”œâ”€â”€ HeatMap.tsx    # P5.js heat map component
    79â†’â”‚   â”‚   â”‚   â”œâ”€â”€ SystemModel.tsx # System simulator with stocks & flows
    80â†’â”‚   â”‚   â”‚   â””â”€â”€ StateSpaceVisualization.tsx # Phase portrait viewer
    81â†’â”‚   â”‚   â””â”€â”€ ui/
    82â†’â”‚   â”‚       â”œâ”€â”€ VisualizationLayout.tsx
    83â†’â”‚   â”‚       â”œâ”€â”€ ColorPaletteSelector.tsx
    84â†’â”‚   â”‚       â”œâ”€â”€ FileUploadZone.tsx
    85â†’â”‚   â”‚       â””â”€â”€ MessageDisplay.tsx
    86â†’â”‚   â”œâ”€â”€ lib/
    87â†’â”‚   â”‚   â”œâ”€â”€ utils.ts           # Utilities (ColorUtils, DataParser, etc.)
    88â†’â”‚   â”‚   â””â”€â”€ abm/               # Agent-Based Modeling library
    89â†’â”‚   â”‚       â”œâ”€â”€ index.ts       # Module exports barrel file
    90â†’â”‚   â”‚       â”œâ”€â”€ types.ts       # Type definitions (ODD protocol)
    91â†’â”‚   â”‚       â”œâ”€â”€ core/
    92â†’â”‚   â”‚       â”‚   â”œâ”€â”€ ecs.ts     # Entity-Component-System engine
    93â†’â”‚   â”‚       â”‚   â”œâ”€â”€ evaluator.ts  # Safe expression evaluator
    94â†’â”‚   â”‚       â”‚   â”œâ”€â”€ primitives.ts # Behavior building blocks
    95â†’â”‚   â”‚       â”‚   â””â”€â”€ simulation.ts # Simulation controller
    96â†’â”‚   â”‚       â””â”€â”€ renderer/
    97â†’â”‚   â”‚           â””â”€â”€ pixiRenderer.ts # PIXI.js WebGL renderer
    98â†’â”‚   â”œâ”€â”€ types/
    99â†’â”‚   â”‚   â””â”€â”€ index.ts           # TypeScript type definitions
   100â†’â”‚   â””â”€â”€ public/
   101â†’â”‚       â”œâ”€â”€ data/
   102â†’â”‚       â”‚   â””â”€â”€ color-palettes.json  # Theme configuration
   103â†’â”‚       â””â”€â”€ docs/
   104â†’â”‚           â””â”€â”€ abm-json-guide.md    # ABM JSON spec for LLMs
   105â†’â”œâ”€â”€ backup/                     # Legacy vanilla JS version
   106â†’â”œâ”€â”€ next.config.js             # Next.js configuration
   107â†’â”œâ”€â”€ tailwind.config.ts         # Tailwind CSS configuration
   108â†’â””â”€â”€ package.json
   109â†’```
   110â†’
   111â†’### Component Architecture
   112â†’
   113â†’#### HeatMap Component (`/src/components/visualizations/HeatMap.tsx`)
   114â†’
   115â†’**Key Implementation Details:**
   116â†’- Uses P5.js in instance mode within React
   117â†’- Loads theme configuration asynchronously for font sizes
   118â†’- Uses `paletteRef` for color palette to avoid re-renders
   119â†’- Implements `p.noLoop()` for static visualizations
   120â†’- Properly cleans up P5 instances on unmount
   121â†’
   122â†’**Memory Leak Fix (Dec 2025):**
   123â†’The component previously had an infinite loop caused by including `fontSizes` state in the useEffect dependency array while also modifying it within the effect. This created:
   124â†’- Thousands of P5.js instances per second
   125â†’- Runaway memory consumption (94+ GB observed)
   126â†’- Browser crashes
   127â†’
   128â†’**Solution:**
   129â†’- Removed `fontSizes` state entirely
   130â†’- Font sizes loaded as local variables in the effect
   131â†’- P5 sketch captures these variables in closure
   132â†’- useEffect dependencies: `[data, width, height, onError]` only
   133â†’- No circular dependency = no infinite loop
   134â†’
   135â†’**Code Pattern:**
   136â†’```typescript
   137â†’useEffect(() => {
   138â†’  let p5: any
   139â†’  let isMounted = true
   140â†’
   141â†’  const loadP5 = async () => {
   142â†’    // Load font sizes as local variables (not state)
   143â†’    let labelSize = 12
   144â†’    let valueSize = 10
   145â†’
   146â†’    try {
   147â†’      const [loadedLabelSize, loadedValueSize] = await Promise.all([
   148â†’        TypographyUtils.getVisualizationFontSize('heatmap', 'labelSize'),
   149â†’        TypographyUtils.getVisualizationFontSize('heatmap', 'fontSize')
   150â†’      ])
   151â†’      labelSize = loadedLabelSize
   152â†’      valueSize = loadedValueSize
   153â†’    } catch (error) {
   154â†’      console.warn('Using default font sizes')
   155â†’    }
   156â†’
   157â†’    // Create P5 sketch using local variables
   158â†’    const sketch = (p: any) => {
   159â†’      p.setup = () => {
   160â†’        // ... setup code
   161â†’        p.noLoop() // Static visualization
   162â†’      }
   163â†’
   164â†’      p.draw = () => {
   165â†’        // Uses labelSize and valueSize from closure
   166â†’      }
   167â†’    }
   168â†’
   169â†’    p5 = new P5(sketch)
   170â†’  }
   171â†’
   172â†’  loadP5()
   173â†’
   174â†’  return () => {
   175â†’    isMounted = false
   176â†’    if (p5) p5.remove()
   177â†’  }
   178â†’}, [data, width, height, onError]) // No fontSizes!
   179â†’```
   180â†’
   181â†’#### SystemModel Component (`/src/components/visualizations/SystemModel.tsx`)
   182â†’
   183â†’**Purpose**: Simulates discrete-time state-space systems and visualizes them as stocks-and-flows diagrams with animated particles.
   184â†’
   185â†’**Key Features:**
   186â†’- **Force-directed graph layout** - States positioned based on A matrix structure
   187â†’- **Draggable nodes** - Click and drag any node to reposition
   188â†’- **Interactive hover info** - Shows connectivity metrics, flow rates, and connections
   189â†’- **Animated flow particles** - Variable velocity based on flow magnitude
   190â†’- **Bidirectional edge handling** - Parallel pipes for reverse connections
   191â†’- **Export capabilities** - CSV, JSON, copy current state
   192â†’- **Direct navigation** - "View Phase Portrait" button to State Space Visualizer
   193â†’
   194â†’**Implementation Patterns:**
   195â†’```typescript
   196â†’// Use refs to avoid P5 re-mounting on state changes
   197â†’const currentTimeIndexRef = useRef(0)
   198â†’const [currentTimeIndex, setCurrentTimeIndex] = useState(0)
   199â†’
   200â†’useEffect(() => {
   201â†’  currentTimeIndexRef.current = currentTimeIndex
   202â†’}, [currentTimeIndex])
   203â†’
   204â†’// P5 reads from ref instead of state
   205â†’p.draw = () => {
   206â†’  const idx = currentTimeIndexRef.current // No re-mount!
   207â†’  // ... use idx
   208â†’}
   209â†’```
   210â†’
   211â†’**Force-Directed Layout:**
   212â†’- Initializes states in circle
   213â†’- Spring forces between connected nodes (proportional to |A[i][j]|)
   214â†’- Repulsion forces prevent overlap
   215â†’- Centering force keeps layout bounded
   216â†’- 300 iterations for stable configuration
   217â†’
   218â†’**Bidirectional Edge Detection:**
   219â†’```typescript
   220â†’// Build adjacency map
   221â†’const edgeMap = new Map<string, Edge>()
   222â†’edges.forEach(edge => {
   223â†’  edgeMap.set(`${edge.from.id}->${edge.to.id}`, edge)
   224â†’})
   225â†’
   226â†’// Detect reverse edges
   227â†’edges.forEach(edge => {
   228â†’  if (edge.from.id === edge.to.id) return // Skip self-loops
   229â†’
   230â†’  const reverseKey = `${edge.to.id}->${edge.from.id}`
   231â†’  if (edgeMap.get(reverseKey)) {
   232â†’    // Mark as bidirectional with parallel offset
   233â†’    edge.bidirectional = true
   234â†’    edge.parallelOffset = BIDIRECTIONAL_OFFSET
   235â†’  }
   236â†’})
   237â†’```
   238â†’
   239â†’**Critical Learning - Conditional Rendering vs Disabled:**
   240â†’Initially used `disabled={!hasData}` for export buttons. Problem: buttons visible but unusable created confusion.
   241â†’
   242â†’Solution: Conditional rendering for primary actions
   243â†’```typescript
   244â†’{hasSimulationData && (
   245â†’  <button onClick={openInStateSpaceVisualizer}>
   246â†’    ğŸ¨ View Phase Portrait
   247â†’  </button>
   248â†’)}
   249â†’```
   250â†’
   251â†’Benefits:
   252â†’- Clearer UI - button only appears when functional
   253â†’- Prevents errors - no risk of clicking when no data
   254â†’- Better UX - users see what's available
   255â†’
   256â†’#### StateSpaceVisualization Component (`/src/components/visualizations/StateSpaceVisualization.tsx`)
   257â†’
   258â†’**Purpose**: Displays phase portraits (state vs state plots) from time series data.
   259â†’
   260â†’**Key Features:**
   261â†’- **Multi-plot grid** - Shows all state pairs (upper triangle only)
   262â†’- **Interactive state selection** - Toggle which states to visualize
   263â†’- **Trajectory trails** - Adjustable length showing recent history
   264â†’- **Current point tracking** - Red dot shows current position
   265â†’- **Complete trajectory** - Faint gray line shows full path
   266â†’- **Dual format support** - Accepts simple JSON or System Simulator exports
   267â†’
   268â†’**Data Integration:**
   269â†’```typescript
   270â†’// Accepts System Simulator export format
   271â†’interface SystemSimulatorExport {
   272â†’  metadata?: { title, dt, timeHorizon }
   273â†’  system?: { A, B, C, D, labels }
   274â†’  results: { t, x, u, y }  // Extract x and t for phase portrait
   275â†’}
   276â†’
   277â†’// Or simple format
   278â†’interface StateSpaceData {
   279â†’  t: number[]
   280â†’  x: number[][]  // [timeStep][stateIndex]
   281â†’  labels?: string[]
   282â†’  title?: string
   283â†’}
   284â†’```
   285â†’
   286â†’**SessionStorage Integration:**
   287â†’Seamless navigation from System Simulator:
   288â†’```typescript
   289â†’// In SystemModel.tsx
   290â†’const openInStateSpaceVisualizer = () => {
   291â†’  const stateSpaceData = {
   292â†’    t: simulationRef.current.t,
   293â†’    x: simulationRef.current.x,
   294â†’    labels: data.labels?.states,
   295â†’    title: data.title
   296â†’  }
   297â†’  sessionStorage.setItem('stateSpaceData', JSON.stringify(stateSpaceData))
   298â†’  router.push('/statespace')
   299â†’}
   300â†’
   301â†’// In statespace/page.tsx
   302â†’useEffect(() => {
   303â†’  const sessionData = sessionStorage.getItem('stateSpaceData')
   304â†’  if (sessionData) {
   305â†’    const parsedData = JSON.parse(sessionData)
   306â†’    setStateSpaceData(parsedData)
   307â†’    sessionStorage.removeItem('stateSpaceData') // Clear after use
   308â†’  }
   309â†’}, [])
   310â†’```
   311â†’
   312â†’**Grid Layout Calculation:**
   313â†’For n selected states, shows n(n-1)/2 plots (upper triangle):
   314â†’```typescript
   315â†’const plotsPerRow = Math.ceil(Math.sqrt(gridSize * (gridSize - 1) / 2))
   316â†’const plotWidth = width / plotsPerRow
   317â†’const plotHeight = height / Math.ceil((gridSize * (gridSize - 1) / 2) / plotsPerRow)
   318â†’
   319â†’// Draw only i < j pairs
   320â†’for (let i = 0; i < selected.length; i++) {
   321â†’  for (let j = i + 1; j < selected.length; j++) {
   322â†’    drawPhasePlot(stateI, stateJ, ...)
   323â†’  }
   324â†’}
   325â†’```
   326â†’
   327â†’#### VectorField Component (`/src/components/visualizations/VectorField.tsx`)
   328â†’
   329â†’**Purpose**: Visualizes 2D and 3D vector fields with trajectory integration for linear and nonlinear dynamical systems.
   330â†’
   331â†’**Key Features:**
   332â†’- **2D/3D rendering** - Automatic mode selection based on system dimension
   333â†’- **Vector field display** - Normalized arrows color-coded by magnitude (blue=low, red=high)
   334â†’- **Interactive trajectory addition** - Click (2D) or input fields (3D) to add trajectories
   335â†’- **RK4 integration** - Accurate trajectory computation using 4th-order Runge-Kutta
   336â†’- **Configurable simulation time** - User-adjustable from 5-60 seconds
   337â†’- **Playback controls** - Animation with timeline scrubber
   338â†’- **Color legend** - Visual (2D) or text (3D) explanation of magnitude colors
   339â†’- **Cross-page navigation** - Integrated with System Simulator and State Space Visualizer
   340â†’
   341â†’**Data Format:**
   342â†’```typescript
   343â†’interface VectorFieldData {
   344â†’  // System definition (choose one)
   345â†’  A?: number[][]                    // Linear: dx/dt = Ax
   346â†’  f?: (x: number[]) => number[]     // Nonlinear: dx/dt = f(x)
   347â†’
   348â†’  // Metadata
   349â†’  labels?: string[]                 // State labels
   350â†’  title?: string
   351â†’
   352â†’  // Display options
   353â†’  dimension?: 2 | 3                 // 2D or 3D visualization
   354â†’  selectedStates?: number[]         // Which states to visualize
   355â†’
   356â†’  // Bounds (auto-calculated if not provided)
   357â†’  bounds?: {
   358â†’    min: number[]
   359â†’    max: number[]
   360â†’  }
   361â†’}
   362â†’
   363â†’interface VectorFieldTrajectory {
   364â†’  id: string
   365â†’  x0: number[]                      // Initial condition
   366â†’  points: number[][]                // Trajectory points [time][state]
   367â†’  t: number[]                       // Time points
   368â†’  color: string                     // Display color
   369â†’}
   370â†’```
   371â†’
   372â†’**Implementation Highlights:**
   373â†’
   374â†’1. **2D Click-to-Add Trajectories:**
   375â†’```typescript
   376â†’p.mousePressed = () => {
   377â†’  if (!is3D && p.mouseX > 50 && p.mouseX < width - 50) {
   378â†’    // Inverse map with Y-axis flip for mathematical convention
   379â†’    const x = p.map(p.mouseX, 50, width - 50, xMin, xMax)
   380â†’    const y = p.map(p.mouseY, height - 200, 50, yMin, yMax)  // Note: inverted!
   381â†’
   382â†’    integrateTrajectory([x, y])
   383â†’  }
   384â†’}
   385â†’```
   386â†’
   387â†’2. **3D Input Fields:**
   388â†’```typescript
   389â†’const handleAdd3DTrajectory = () => {
   390â†’  // Parse and validate input coordinates
   391â†’  const x = parseFloat(ic3DX)
   392â†’  const y = parseFloat(ic3DY)
   393â†’  const z = parseFloat(ic3DZ)
   394â†’
   395â†’  // Build full state vector
   396â†’  const fullState = new Array(n).fill(0)
   397â†’  fullState[selectedStates[0]] = x
   398â†’  fullState[selectedStates[1]] = y
   399â†’  fullState[selectedStates[2]] = z
   400â†’
   401â†’  // Integrate using RK4
   402â†’  integrateTrajectory(fullState)
   403â†’}
   404â†’```
   405â†’
   406â†’3. **RK4 Integration:**
   407â†’```typescript
   408â†’for (let i = 0; i < steps; i++) {
   409â†’  t.push(i * dt)
   410â†’  points.push([...state])
   411â†’
   412â†’  // 4th-order Runge-Kutta
   413â†’  const k1 = evaluateSystem(state)
   414â†’  const k2 = evaluateSystem(state.map((si, j) => si + 0.5 * dt * k1[j]))
   415â†’  const k3 = evaluateSystem(state.map((si, j) => si + 0.5 * dt * k2[j]))
   416â†’  const k4 = evaluateSystem(state.map((si, j) => si + dt * k3[j]))
   417â†’
   418â†’  state = state.map((si, j) =>
   419â†’    si + (dt / 6) * (k1[j] + 2 * k2[j] + 2 * k3[j] + k4[j])
   420â†’  )
   421â†’}
   422â†’```
   423â†’
   424â†’4. **Color Coding by Magnitude:**
   425â†’```typescript
   426â†’function magnitudeToColor(mag: number, maxMag: number): [number, number, number] {
   427â†’  const normalized = Math.min(mag / (maxMag || 1), 1)
   428â†’  const r = Math.floor(normalized * 255)  // Red for high
   429â†’  const b = Math.floor((1 - normalized) * 255)  // Blue for low
   430â†’  return [r, 100, b]
   431â†’}
   432â†’```
   433â†’
   434â†’5. **Auto-Calculated Bounds:**
   435â†’```typescript
   436â†’function calculateBounds(data: VectorFieldData) {
   437â†’  if (data.A) {
   438â†’    // For linear systems: estimate from A matrix magnitude
   439â†’    let maxVal = 0
   440â†’    for (let i = 0; i < n; i++) {
   441â†’      for (let j = 0; j < n; j++) {
   442â†’        maxVal = Math.max(maxVal, Math.abs(data.A[i][j]))
   443â†’      }
   444â†’    }
   445â†’    const bound = Math.max(5, maxVal * 3)
   446â†’    return {
   447â†’      min: new Array(n).fill(-bound),
   448â†’      max: new Array(n).fill(bound)
   449â†’    }
   450â†’  }
   451â†’  // Default for nonlinear systems
   452â†’  return { min: [-10, -10, -10], max: [10, 10, 10] }
   453â†’}
   454â†’```
   455â†’
   456â†’**SessionStorage Integration:**
   457â†’```typescript
   458â†’// From System Simulator
   459â†’const openInVectorField = () => {
   460â†’  const vectorFieldData = {
   461â†’    A: data.A,
   462â†’    labels: data.labels?.states,
   463â†’    title: data.title || 'System Vector Field',
   464â†’    dimension: data.A.length <= 2 ? 2 : 3
   465â†’  }
   466â†’  sessionStorage.setItem('vectorFieldData', JSON.stringify(vectorFieldData))
   467â†’  router.push('/vectorfield')
   468â†’}
   469â†’
   470â†’// Also stores system matrix when navigating to State Space
   471â†’sessionStorage.setItem('systemMatrix', JSON.stringify({ A, labels, title }))
   472â†’```
   473â†’
   474â†’**Demo Systems:**
   475â†’
   476â†’1. **Mass-Spring-Damper (2D):**
   477â†’```typescript
   478â†’const k = 4, m = 1, c = 0.5
   479â†’const A = [
   480â†’  [0, 1],
   481â†’  [-k/m, -c/m]
   482â†’]
   483â†’// Shows spiral convergence to equilibrium
   484â†’```
   485â†’
   486â†’2. **Lorenz Attractor (3D):**
   487â†’```typescript
   488â†’const sigma = 10, rho = 28, beta = 8/3
   489â†’const f = (x: number[]) => {
   490â†’  const [x1, x2, x3] = x
   491â†’  return [
   492â†’    sigma * (x2 - x1),
   493â†’    x1 * (rho - x3) - x2,
   494â†’    x1 * x2 - beta * x3
   495â†’  ]
   496â†’}
   497â†’// Famous chaotic system with butterfly attractor
   498â†’```
   499â†’
   500â†’**Key Learnings:**
   501â†’
   502â†’1. **Y-Axis Inversion Bug** âš ï¸
   503â†’   - P5.js coordinates: y increases downward
   504â†’   - Math convention: y increases upward
   505â†’   - **Fix**: Inverse mapping must flip both directions
   506â†’   ```typescript
   507â†’   // Forward: state â†’ canvas
   508â†’   const mapY = (y: number) => p.map(y, yMin, yMax, height-200, 50)
   509â†’
   510â†’   // Inverse: canvas â†’ state (MUST match forward flip!)
   511â†’   const y = p.map(p.mouseY, height-200, 50, yMin, yMax)  // Correct!
   512â†’   // NOT: p.map(p.mouseY, 50, height-200, yMin, yMax)     // Wrong - reflects on x-axis!
   513â†’   ```
   514â†’
   515â†’2. **WEBGL Limitations** âš ï¸
   516â†’   - `p.hint()` not available in WEBGL mode
   517â†’   - Can't easily draw 2D overlays on 3D canvas
   518â†’   - **Solution**: Skip visual legend in 3D, use text description instead
   519â†’   ```typescript
   520â†’   // Don't do this in WEBGL:
   521â†’   p.hint(p.DISABLE_DEPTH_TEST)  // Error: hint is not a function
   522â†’
   523â†’   // Instead: conditional rendering
   524â†’   if (data.dimension === 2) {
   525â†’     drawColorLegend(p)  // Works fine in 2D mode
   526â†’   } else {
   527â†’     // Show text description in UI controls
   528â†’   }
   529â†’   ```
   530â†’
   531â†’3. **3D Click Input Challenges**
   532â†’   - Can't reliably map 2D click â†’ 3D position
   533â†’   - **Solution**: Input fields with bounds validation
   534â†’   ```typescript
   535â†’   // Check if coordinates are within bounds
   536â†’   if (x < xMin || x > xMax || y < yMin || y > yMax || z < zMin || z > zMax) {
   537â†’     alert(`Coordinates out of bounds! Use:\nx âˆˆ [${xMin}, ${xMax}]...`)
   538â†’   }
   539â†’   ```
   540â†’
   541â†’4. **Optional Chaining for Bounds Safety**
   542â†’   - Bounds may not be loaded when component first renders
   543â†’   - **Fix**: Use optional chaining and fallbacks
   544â†’   ```typescript
   545â†’   {bounds.min[stateIdx]?.toFixed(1) || '?'}  // Safe
   546â†’   // NOT: bounds.min[stateIdx].toFixed(1)     // Can crash!
   547â†’   ```
   548â†’
   549â†’5. **Simulation Time as User Control**
   550â†’   - Hardcoded time (20s) not flexible for all systems
   551â†’   - **Solution**: Slider with sensible limits (5-60s)
   552â†’   - Chaotic systems need longer time to show full dynamics
   553â†’   - Damped systems converge quickly, shorter time sufficient
   554â†’
   555â†’**Navigation Flow:**
   556â†’```
   557â†’System Simulator â†’ [View Vector Field] â†’ Vector Field (with A matrix)
   558â†’                â†’ [View Phase Portrait] â†’ State Space (with trajectories)
   559â†’                                        â†’ [View Vector Field] â†’ Vector Field (if system matrix available)
   560â†’
   561â†’Vector Field â†’ [System Simulator] â†’ System Model page
   562â†’            â†’ [Phase Portrait] â†’ State Space page
   563â†’```
   564â†’
   565â†’---
   566â†’
   567â†’## Agent-Based Modeling (ABM) System
   568â†’
   569â†’### Overview
   570â†’
   571â†’The ABM system is a general-purpose agent-based modeling platform following the ODD (Overview, Design concepts, Details) protocol. It supports diverse simulations (epidemiological, ecological, social) from declarative JSON configuration files.
   572â†’
   573â†’**Key Architecture Decisions:**
   574â†’- **Entity-Component-System (ECS)** pattern for maximum flexibility
   575â†’- **Safe expression evaluation** - no `eval()` or `Function`, all logic as predicate/operation trees
   576â†’- **PIXI.js WebGL rendering** for efficient 2D visualization
   577â†’- **Seeded RNG** for reproducible simulations using Mulberry32 algorithm
   578â†’
   579â†’### Core Files
   580â†’
   581â†’| File | Lines | Purpose |
   582â†’|------|-------|---------|
   583â†’| `types.ts` | 464 | Type system following ODD protocol |
   584â†’| `ecs.ts` | 625 | Entity-Component-System engine with spatial indexing |
   585â†’| `evaluator.ts` | ~400 | Safe expression evaluator for conditions/effects |
   586â†’| `primitives.ts` | ~500 | Domain-agnostic behavior building blocks |
   587â†’| `simulation.ts` | 930 | Main simulation controller and lifecycle |
   588â†’| `pixiRenderer.ts` | ~550 | PIXI.js WebGL-based 2D renderer |
   589â†’
   590â†’### ECS Architecture (`/src/lib/abm/core/ecs.ts`)
   591â†’
   592â†’**Entity Class:**
   593â†’```typescript
   594â†’class Entity {
   595â†’  readonly id: EntityId
   596â†’  archetype: string
   597â†’
   598â†’  hasComponent(type: ComponentType): boolean
   599â†’  getComponent<T>(type: ComponentType): T | undefined
   600â†’  setComponent(type: ComponentType, data: ComponentData): void
   601â†’  getProperty(path: string): unknown  // e.g., "Health.status"
   602â†’  setProperty(path: string, value: unknown): boolean
   603â†’  serialize(): object
   604â†’  static deserialize(data: object): Entity
   605â†’}
   606â†’```
   607â†’
   608â†’**SpatialHashGrid** - Efficient neighbor queries for continuous 2D space:
   609â†’- Cell-based grid with configurable cell size
   610â†’- O(k) neighbor queries where k = neighbors found
   611â†’- Toroidal/bounded/infinite boundary handling
   612â†’- Distance calculation with wraparound support
   613â†’
   614â†’**World Class** - Container for all entities:
   615â†’```typescript
   616â†’class World {
   617â†’  createEntity(archetypeName: string): Entity
   618â†’  destroyEntity(id: EntityId): void
   619â†’  queryRadius(position: Vector2D, radius: number): EntityId[]
   620â†’  getEntitiesWithComponent(type: ComponentType): Entity[]
   621â†’  getEntitiesByArchetype(name: string): Entity[]
   622â†’  flush(): void  // Process pending additions/removals
   623â†’}
   624â†’```
   625â†’
   626â†’### Safe Expression Evaluator (`/src/lib/abm/core/evaluator.ts`)
   627â†’
   628â†’**Zero JavaScript code execution** - all logic expressed as structured trees:
   629â†’
   630â†’**Condition Expressions:**
   631â†’```typescript
   632â†’// Predicate tree - no strings to eval
   633â†’{
   634â†’  "and": [
   635â†’    { "gt": [{ "prop": "self.Health.value" }, 50] },
   636â†’    { "eq": [{ "prop": "other.Health.status" }, "I"] }
   637â†’  ]
   638â†’}
   639â†’```
   640â†’
   641â†’**Value Expressions:**
   642â†’- Property access: `{ "prop": "self.ComponentName.property" }`
   643â†’- Arithmetic: `add`, `sub`, `mul`, `div`, `mod`
   644â†’- Math functions: `abs`, `floor`, `ceil`, `round`, `min`, `max`, `lerp`, `clamp`, `sqrt`
   645â†’- Aggregations: `count`, `average`, `sum` with filters
   646â†’- Random: `uniform`, `normal` distributions
   647â†’- Spatial: `distance`, `nearest`
   648â†’
   649â†’**Effect Expressions:**
   650â†’```typescript
   651â†’// Operations that modify state
   652â†’{ "set": { "target": "self.Health.status", "value": "I" } }
   653â†’{ "increment": { "target": "self.Energy.value", "amount": -10 } }
   654â†’{ "spawn": { "archetype": "Prey", "position": { "prop": "self.Position" } } }
   655â†’{ "destroy": { "target": "self" } }
   656â†’{ "emit": { "event": "infection", "data": { "victim": { "prop": "self.id" } } } }
   657â†’{ "probability": { "chance": 0.05, "effect": { ... } } }
   658â†’```
   659â†’
   660â†’### Primitives Library (`/src/lib/abm/core/primitives.ts`)
   661â†’
   662â†’**VectorMath:**
   663â†’- Basic: `add`, `sub`, `mul`, `div`, `normalize`, `magnitude`
   664â†’- Advanced: `distance`, `angle`, `rotate`, `lerp`, `setMagnitude`, `limit`
   665â†’
   666â†’**SteeringPrimitives:**
   667â†’```typescript
   668â†’seek(position, target, maxSpeed): Vector2D
   669â†’flee(position, target, maxSpeed): Vector2D
   670â†’arrive(position, target, maxSpeed, slowingRadius): Vector2D
   671â†’wander(position, velocity, wanderRadius, wanderDistance, wanderJitter): Vector2D
   672â†’separation(entity, neighbors, radius): Vector2D
   673â†’alignment(entity, neighbors): Vector2D
   674â†’cohesion(entity, neighbors): Vector2D
   675â†’calculateCombinedSteering(entity, rules, world): Vector2D
   676â†’```
   677â†’
   678â†’**AggregationPrimitives:**
   679â†’- `count(world, filter)`, `average(world, property, filter)`, `sum(world, property, filter)`
   680â†’
   681â†’### PIXI Renderer (`/src/lib/abm/renderer/pixiRenderer.ts`)
   682â†’
   683â†’**Key Features:**
   684â†’- Dynamic PIXI.js import for code splitting
   685â†’- Multi-layer containers: environment, trails, agents, UI
   686â†’- Shape support: circle, square, triangle, diamond, icon
   687â†’- Color-by-state with both numeric interpolation and enum colorMap
   688â†’
   689â†’**Critical Pattern - Proper Canvas Cleanup:**
   690â†’```typescript
   691â†’destroy(): void {
   692â†’  if (this.app) {
   693â†’    // CRITICAL: Remove canvas from DOM before destroying
   694â†’    if (this.app.canvas && this.app.canvas.parentNode) {
   695â†’      this.app.canvas.parentNode.removeChild(this.app.canvas)
   696â†’    }
   697â†’    this.app.destroy(true, { children: true, texture: true })
   698â†’    this.app = null
   699â†’  }
   700â†’  // Clear all state
   701â†’  this.agentGraphics.clear()
   702â†’  this.trailPoints.clear()
   703â†’  this.archetypeColors.clear()
   704â†’  this.archetypeVisuals.clear()
   705â†’  this.initialized = false
   706â†’}
   707â†’
   708â†’async initialize(container: HTMLElement): Promise<void> {
   709â†’  if (this.initialized) return
   710â†’
   711â†’  // Safety: clear any existing canvases
   712â†’  const existingCanvases = container.querySelectorAll('canvas')
   713â†’  existingCanvases.forEach(canvas => canvas.remove())
   714â†’
   715â†’  // ... create new PIXI app
   716â†’}
   717â†’```
   718â†’
   719â†’**Color-by-State with Enum Support:**
   720â†’```typescript
   721â†’if (visual.colorByState) {
   722â†’  const value = entityObj.getProperty(visual.colorByState.property)
   723â†’
   724â†’  if (typeof value === 'number') {
   725â†’    // Numeric interpolation between min/max colors
   726â†’    const t = Math.max(0, Math.min(1, value / 100))
   727â†’    color = interpolateColor(visual.colorByState.minColor, visual.colorByState.maxColor, t)
   728â†’  } else if (typeof value === 'string' && visual.colorByState.colorMap) {
   729â†’    // Enum/string value: use colorMap lookup
   730â†’    const mappedColor = visual.colorByState.colorMap[value]
   731â†’    if (mappedColor) {
   732â†’      color = hexToNumber(mappedColor)
   733â†’    }
   734â†’  }
   735â†’}
   736â†’```
   737â†’
   738â†’### Simulation Controller (`/src/lib/abm/core/simulation.ts`)
   739â†’
   740â†’**Lifecycle Methods:**
   741â†’```typescript
   742â†’initialize(modelDef: ABMModelDefinition): void
   743â†’play(): void
   744â†’pause(): void
   745â†’reset(): void  // Restores initial state
   746â†’step(): void   // Advance one tick
   747â†’setSpeed(speed: number): void
   748â†’setSeed(seed: number): void
   749â†’setParameter(path: string, value: unknown): void
   750â†’```
   751â†’
   752â†’**Boundary Handling with Velocity Reflection:**
   753â†’```typescript
   754â†’if (this.environmentConfig.boundary === 'bounded') {
   755â†’  let newVel = { ...velocity }
   756â†’
   757â†’  // Reflect velocity when hitting boundaries
   758â†’  if (newPos.x <= 0 || newPos.x >= width) {
   759â†’    newVel.x = -velocity.x * 0.8  // Reverse and dampen
   760â†’  }
   761â†’  if (newPos.y <= 0 || newPos.y >= height) {
   762â†’    newVel.y = -velocity.y * 0.8
   763â†’  }
   764â†’
   765â†’  if (newVel.x !== velocity.x || newVel.y !== velocity.y) {
   766â†’    entityObj.setComponent('Velocity', newVel)
   767â†’  }
   768â†’
   769â†’  // Clamp position to bounds
   770â†’  newPos.x = MathPrimitives.clamp(newPos.x, 0, width)
   771â†’  newPos.y = MathPrimitives.clamp(newPos.y, 0, height)
   772â†’}
   773â†’```
   774â†’
   775â†’### Demo Models
   776â†’
   777â†’**1. Flocking (Boids)** - `flocking.ts`
   778â†’- Demonstrates: Steering behaviors, emergent patterns
   779â†’- Components: Position, Velocity, SteeringBehavior
   780â†’- Rules: Separation (weight 1.5), Alignment (weight 1.0), Cohesion (weight 1.0)
   781â†’
   782â†’**2. SIR Epidemic** - `sir.ts`
   783â†’- Demonstrates: State machines, probabilistic rules
   784â†’- Components: Position, Velocity, Health (S/I/R status), SteeringBehavior
   785â†’- Rules: Infection on proximity, recovery after time
   786â†’- Visual: colorByState with colorMap for enum values
   787â†’
   788â†’**3. Predator-Prey** - `predatorPrey.ts`
   789â†’- Demonstrates: Heterogeneous agents, reproduction, death
   790â†’- Archetypes: Prey (flee behavior), Predator (seek behavior)
   791â†’- Components: Position, Velocity, Energy, ReproductionCooldown
   792â†’
   793â†’### ABM Key Learnings & Pitfalls
   794â†’
   795â†’#### Pitfall 1: PIXI Canvas Not Cleaned Up âš ï¸
   796â†’**Symptom**: Duplicate simulations appearing when switching demos
   797â†’**Cause**: PIXI `destroy()` doesn't remove canvas from DOM
   798â†’**Solution**: Explicitly remove canvas before destroying:
   799â†’```typescript
   800â†’if (this.app.canvas?.parentNode) {
   801â†’  this.app.canvas.parentNode.removeChild(this.app.canvas)
   802â†’}
   803â†’```
   804â†’
   805â†’#### Pitfall 2: colorByState Only Handling Numbers âš ï¸
   806â†’**Symptom**: SIR agents not changing color when status changes (Sâ†’Iâ†’R)
   807â†’**Cause**: Only numeric interpolation was implemented
   808â†’**Solution**: Add colorMap support for string/enum values:
   809â†’```typescript
   810â†’colorByState: {
   811â†’  property: 'Health.status',
   812â†’  minColor: '#34a853',
   813â†’  maxColor: '#ea4335',
   814â†’  colorMap: {
   815â†’    'S': '#34a853',  // Green
   816â†’    'I': '#ea4335',  // Red
   817â†’    'R': '#4285f4'   // Blue
   818â†’  }
   819â†’}
   820â†’```
   821â†’
   822â†’#### Pitfall 3: Agents Drifting to Edges âš ï¸
   823â†’**Symptom**: Agents accumulate at boundaries in bounded mode
   824â†’**Cause**: Position clamping without velocity reflection
   825â†’**Solution**: Reflect velocity with dampening when hitting edges:
   826â†’```typescript
   827â†’if (newPos.x <= 0 || newPos.x >= width) {
   828â†’  newVel.x = -velocity.x * 0.8  // Reverse and dampen
   829â†’}
   830â†’```
   831â†’
   832â†’#### Pitfall 4: Infinite Re-renders in React âš ï¸
   833â†’**Symptom**: Simulation stuttering or memory leak
   834â†’**Cause**: Including simulation state in useEffect dependencies
   835â†’**Solution**: Use refs for values the render loop reads:
   836â†’```typescript
   837â†’const tickRef = useRef(0)
   838â†’const [tick, setTick] = useState(0)
   839â†’
   840â†’useEffect(() => {
   841â†’  tickRef.current = tick
   842â†’}, [tick])
   843â†’
   844â†’// PIXI render loop reads from ref, not state
   845â†’p.draw = () => {
   846â†’  const currentTick = tickRef.current
   847â†’}
   848â†’```
   849â†’
   850â†’#### Pitfall 5: Archetype Visuals Override colorByState âš ï¸
   851â†’**Symptom**: Agents don't change color when state changes (e.g., SIR model)
   852â†’**Cause**: Child archetypes override `visual` with static color, losing `colorByState`
   853â†’**Root Issue**: Renderer looks up visuals by archetype name. If "Susceptible" archetype has `color: '#green'` (no colorByState), it stays green even when `Health.status` changes to 'I'.
   854â†’
   855â†’**Wrong approach** - separate archetypes with static colors:
   856â†’```typescript
   857â†’// Susceptible/Infected archetypes override visual with static color
   858â†’archetypes: [
   859â†’  { name: 'Susceptible', visual: { color: '#34a853' } },  // Static!
   860â†’  { name: 'Infected', visual: { color: '#ea4335' } }      // Static!
   861â†’]
   862â†’initialization: [
   863â†’  { archetype: 'Susceptible', count: 95 },  // Won't change color
   864â†’  { archetype: 'Infected', count: 5 }
   865â†’]
   866â†’```
   867â†’
   868â†’**Solution** - use base archetype with colorByState for all:
   869â†’```typescript
   870â†’archetypes: [
   871â†’  { name: 'Person', visual: { colorByState: { property: 'Health.status', colorMap: {...} } } }
   872â†’]
   873â†’initialization: [
   874â†’  { archetype: 'Person', count: 95 },  // Health.status defaults to 'S'
   875â†’  { archetype: 'Person', count: 5, propertyVariation: { 'Health.status': { distribution: 'fixed', value: 'I' } } }
   876â†’]
   877â†’```
   878â†’
   879â†’#### Pitfall 6: Property Path Defaults to Self in Filters âš ï¸
   880â†’**Symptom**: Steering behaviors don't find neighbors (seek, flee, etc. have no effect)
   881â†’**Cause**: Property paths without prefix default to `self`, not `other` (the neighbor being filtered)
   882â†’
   883â†’**Wrong approach** - filter checks self's species instead of neighbor's:
   884â†’```typescript
   885â†’// Predator trying to seek prey
   886â†’{ type: 'seek', query: { filter: { eq: [{ prop: 'Species.type' }, 'prey'] } } }
   887â†’// This checks if SELF (predator) is prey = always false!
   888â†’```
   889â†’
   890â†’**Solution** - use `other.` prefix to check neighbor's property:
   891â†’```typescript
   892â†’{ type: 'seek', query: { filter: { eq: [{ prop: 'other.Species.type' }, 'prey'] } } }
   893â†’// Now checks if NEIGHBOR is prey = correct!
   894â†’```
   895â†’
   896â†’**Property path resolution rules:**
   897â†’- `self.Component.property` â†’ current entity
   898â†’- `other.Component.property` â†’ neighbor/interaction partner
   899â†’- `Component.property` (no prefix) â†’ **defaults to self**
   900â†’- `tick` â†’ current simulation tick
   901â†’- `dt` â†’ timestep
   902â†’- `params.name` â†’ simulation parameters
   903â†’
   904â†’### ABM JSON Format
   905â†’
   906â†’The JSON follows the ODD protocol structure:
   907â†’
   908â†’```json
   909â†’{
   910â†’  "schemaVersion": "1.0",
   911â†’  "overview": {
   912â†’    "purpose": "Model description",
   913â†’    "entities": {
   914â†’      "componentTypes": [...],
   915â†’      "archetypes": [...]
   916â†’    },
   917â†’    "scales": {
   918â†’      "spatial": { "type": "continuous2D", "width": 600, "height": 400 },
   919â†’      "temporal": { "dt": 0.1, "maxTicks": 5000 }
   920â†’    },
   921â†’    "processSchedule": [
   922â†’      { "system": "Steering", "order": "parallel" },
   923â†’      { "system": "Movement", "order": "parallel" },
   924â†’      { "system": "Interaction", "order": "sequential", "shuffle": true }
   925â†’    ]
   926â†’  },
   927â†’  "designConcepts": {
   928â†’    "sensing": { "defaultRadius": 20 },
   929â†’    "interaction": { "rules": [...] },
   930â†’    "stochasticity": { "description": "..." },
   931â†’    "observation": { "timeseries": [...], "events": [...] }
   932â†’  },
   933â†’  "details": {
   934â†’    "initialization": { "entities": [...] }
   935â†’  },
   936â†’  "uiParameters": [...]
   937â†’}
   938â†’```
   939â†’
   940â†’See `/public/docs/abm-json-guide.md` for complete specification.
   941â†’
   942â†’---
   943â†’
   944â†’### Utility Classes (`/src/lib/utils.ts`)
   945â†’
   946â†’#### ColorUtils
   947â†’- **Static color palette generation** - Viridis, Plasma, Inferno, Magma, etc.
   948â†’- **Theme configuration loading** - Loads from `/data/color-palettes.json`
   949â†’- **Caching** - Static properties cache theme config (bounded size, safe)
   950â†’
   951â†’#### TypographyUtils
   952â†’- **Font size management** - Loads visualization-specific font sizes from theme
   953â†’- **Fallback handling** - Returns defaults if theme loading fails
   954â†’
   955â†’#### DataParser
   956â†’- **URL parameter parsing** - Extracts and validates JSON from query strings
   957â†’- **Error handling** - Graceful fallbacks for malformed data
   958â†’
   959â†’#### FileHandler
   960â†’- **Drag & drop support** - File upload with validation
   961â†’- **JSON parsing** - Client-side JSON validation
   962â†’- **Cleanup functions** - Returns cleanup function for event listeners
   963â†’
   964â†’### Data Flow
   965â†’
   966â†’1. **Page Load**
   967â†’   - Next.js renders page component
   968â†’   - Checks URL parameters via `DataParser.parseURLParams()`
   969â†’   - Loads demo data if no URL data provided
   970â†’
   971â†’2. **User Uploads File**
   972â†’   - `FileUploadZone` handles drag/drop or click to upload
   973â†’   - Validates JSON structure
   974â†’   - Calls `onFileUpload` callback with parsed data
   975â†’
   976â†’3. **Visualization Renders**
   977â†’   - React component receives data prop
   978â†’   - useEffect loads P5.js dynamically (code splitting)
   979â†’   - Loads theme config (fonts, colors)
   980â†’   - Creates P5 instance with sketch
   981â†’   - P5 renders visualization on canvas
   982â†’
   983â†’4. **Palette Change**
   984â†’   - Separate useEffect watches `colorPalette` prop
   985â†’   - Loads new palette data
   986â†’   - Updates `paletteRef.current`
   987â†’   - Calls `p5Instance.updateDisplay()` to redraw
   988â†’
   989â†’## JSON Data Formats
   990â†’
   991â†’### Heat Map Data
   992â†’```json
   993â†’{
   994â†’  "data": [[1, 2, 3], [4, 5, 6], [7, 8, 9]],
   995â†’  "labels": {
   996â†’    "x": ["A", "B", "C"],
   997â†’    "y": ["Row 1", "Row 2", "Row 3"]
   998â†’  },
   999â†’  "colorScale": "viridis",
  1000â†’  "title": "Sample Heat Map"
  1001â†’}
  1002â†’```
  1003â†’
  1004â†’### Color Palette Theme Config
  1005â†’Located at `/public/data/color-palettes.json`:
  1006â†’```json
  1007â†’{
  1008â†’  "palettes": {
  1009â†’    "viridis": { "type": "sequential", "colors": 256 },
  1010â†’    "plasma": { "type": "sequential", "colors": 256 }
  1011â†’  },
  1012â†’  "typography": {
  1013â†’    "heatmap": {
  1014â†’      "titleSize": 24,
  1015â†’      "labelSize": 14,
  1016â†’      "fontSize": 12
  1017â†’    }
  1018â†’  }
  1019â†’}
  1020â†’```
  1021â†’
  1022â†’## Performance Considerations
  1023â†’
  1024â†’### Memory Management
  1025â†’- **P5 Instance Cleanup** - Always call `p5.remove()` in useEffect cleanup
  1026â†’- **Avoid State in Dependencies** - Don't include state that's modified within the effect
  1027â†’- **Use Refs for Mutable Data** - `paletteRef` used instead of state to prevent re-renders
  1028â†’- **Static Visualizations** - Call `p.noLoop()` for non-animated visualizations
  1029â†’
  1030â†’### Best Practices
  1031â†’1. **Load P5 dynamically** - `await import('p5')` for code splitting
  1032â†’2. **Use local variables** - For data that doesn't need to trigger re-renders
  1033â†’3. **Cleanup event listeners** - Remove all listeners in useEffect return function
  1034â†’4. **Monitor dependencies** - Only include values that should trigger re-creation
  1035â†’
  1036â†’### Common Pitfalls
  1037â†’
  1038â†’#### Pitfall 1: State in Effect Dependencies
  1039â†’âŒ **DON'T**: Include state in dependencies if you modify it in the effect
  1040â†’```typescript
  1041â†’useEffect(() => {
  1042â†’  setFontSize(20) // Modifies state
  1043â†’}, [fontSize]) // Depends on it = INFINITE LOOP
  1044â†’```
  1045â†’
  1046â†’âœ… **DO**: Use local variables or refs
  1047â†’```typescript
  1048â†’useEffect(() => {
  1049â†’  let fontSize = 20
  1050â†’  // Load async...
  1051â†’  fontSize = loadedSize
  1052â†’  // Use in sketch closure
  1053â†’}, [data]) // Only depends on data
  1054â†’```
  1055â†’
  1056â†’#### Pitfall 2: P5 Reading from State
  1057â†’âŒ **DON'T**: Read state directly in P5 draw loop (causes re-mount on every state change)
  1058â†’```typescript
  1059â†’const [currentIndex, setCurrentIndex] = useState(0)
  1060â†’
  1061â†’useEffect(() => {
  1062â†’  const sketch = (p) => {
  1063â†’    p.draw = () => {
  1064â†’      const idx = currentIndex // Causes re-mount!
  1065â†’    }
  1066â†’  }
  1067â†’  p5 = new P5(sketch)
  1068â†’}, [currentIndex]) // P5 recreated every frame!
  1069â†’```
  1070â†’
  1071â†’âœ… **DO**: Use refs for values P5 needs to read
  1072â†’```typescript
  1073â†’const currentIndexRef = useRef(0)
  1074â†’const [currentIndex, setCurrentIndex] = useState(0)
  1075â†’
  1076â†’useEffect(() => {
  1077â†’  currentIndexRef.current = currentIndex
  1078â†’}, [currentIndex])
  1079â†’
  1080â†’useEffect(() => {
  1081â†’  const sketch = (p) => {
  1082â†’    p.draw = () => {
  1083â†’      const idx = currentIndexRef.current // No re-mount!
  1084â†’    }
  1085â†’  }
  1086â†’  p5 = new P5(sketch)
  1087â†’}, [data]) // Only re-create when data changes
  1088â†’```
  1089â†’
  1090â†’#### Pitfall 3: Disabled vs Hidden Buttons
  1091â†’âŒ **DON'T**: Leave buttons visible when they can't function
  1092â†’```typescript
  1093â†’<button disabled={!hasData}>Export</button>
  1094â†’// Button visible but grayed out - confusing UX
  1095â†’```
  1096â†’
  1097â†’âœ… **DO**: Conditionally render buttons that require preconditions
  1098â†’```typescript
  1099â†’{hasData && <button>Export</button>}
  1100â†’// Button only appears when it can actually work
  1101â†’```
  1102â†’
  1103â†’Exception: Use `disabled` for buttons that should always be visible but temporarily inactive (e.g., "Next" button at end of list).
  1104â†’
  1105â†’## Development Workflow
  1106â†’
  1107â†’### Local Development
  1108â†’```bash
  1109â†’npm run dev       # Start dev server on localhost:3000
  1110â†’npm run build     # Build for production
  1111â†’npm run lint      # Run ESLint
  1112â†’```
  1113â†’
  1114â†’### Static Export
  1115â†’```bash
  1116â†’npm run build     # Creates /out directory
  1117â†’npm run export    # Alias for build (configured in next.config.js)
  1118â†’```
  1119â†’
  1120â†’### Deployment
  1121â†’- **GitHub Pages** - Push to `gh-pages` branch or use GitHub Actions
  1122â†’- **Static hosting** - All files in `/out` can be served from any static host
  1123â†’- **Base path** - Configure `basePath` in `next.config.js` for subdirectory hosting
  1124â†’
  1125â†’## Browser Compatibility
  1126â†’- **Modern browsers** - Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
  1127â†’- **ES modules** - Native ESM support required
  1128â†’- **Canvas/WebGL** - P5.js requires canvas API
  1129â†’- **Async/await** - Modern JavaScript features throughout
  1130â†’
  1131â†’## Known Issues & Solutions
  1132â†’
  1133â†’### Issue: Memory Leak in P5 Components
  1134â†’**Symptom**: Browser memory grows to 10s of GB
  1135â†’**Cause**: Infinite useEffect loop creating P5 instances
  1136â†’**Solution**: Remove state variables from dependencies if modified within effect
  1137â†’
  1138â†’### Issue: Font Sizes Not Loading
  1139â†’**Symptom**: Default font sizes used instead of theme values
  1140â†’**Cause**: Async loading completes after P5 instance created
  1141â†’**Solution**: Load theme config before creating sketch, use local variables
  1142â†’
  1143â†’### Issue: Palette Not Updating
  1144â†’**Symptom**: Changing palette doesn't update visualization
  1145â†’**Cause**: P5 sketch doesn't re-run on palette change
  1146â†’**Solution**: Separate useEffect watches palette, calls `p5Instance.updateDisplay()`
  1147â†’
  1148â†’## Recent Additions (December 2025)
  1149â†’
  1150â†’### Agent-Based Modeling (ABM) System
  1151â†’- **ECS Architecture**: Entity-Component-System pattern for maximum flexibility
  1152â†’- **Safe Expression Evaluation**: No `eval()` - all logic as structured predicate/operation trees
  1153â†’- **PIXI.js WebGL Rendering**: Efficient 2D visualization with multi-layer containers
  1154â†’- **ODD Protocol Compliance**: JSON schema follows standard ABM documentation format
  1155â†’- **Demo Models**: Flocking (Boids), SIR Epidemic, Predator-Prey
  1156â†’- **Interactive Features**: Click-to-inspect agents, timeseries graphs, playback controls
  1157â†’- **Spatial Indexing**: O(k) neighbor queries via spatial hash grid
  1158â†’- **Reproducible Simulations**: Seeded RNG using Mulberry32 algorithm
  1159â†’- **Color-by-State**: Supports both numeric interpolation and enum colorMap for state visualization
  1160â†’
  1161â†’### System Model Simulator
  1162â†’- Force-directed graph layout based on A matrix structure
  1163â†’- Draggable nodes with visual feedback
  1164â†’- Interactive node info panels showing connectivity and flow metrics
  1165â†’- Bidirectional edge detection with parallel pipe rendering
  1166â†’- Export to CSV, JSON, and clipboard
  1167â†’- One-click navigation to State Space Visualizer
  1168â†’
  1169â†’### State Space Visualizer
  1170â†’- Phase portrait grid showing all state pairs
  1171â†’- Interactive state selection (minimum 2 states)
  1172â†’- Adjustable trajectory trail length
  1173â†’- Dual format support (simple JSON + System Simulator exports)
  1174â†’- SessionStorage integration for seamless navigation
  1175â†’- Real-time playback with timeline scrubbing
  1176â†’
  1177â†’### Integration Pattern
  1178â†’```
  1179â†’System Simulator â†’ "View Phase Portrait" â†’ State Space Visualizer
  1180â†’                    â†“ sessionStorage â†“
  1181â†’              Automatic data transfer, zero friction
  1182â†’```
  1183â†’
  1184â†’## Future Enhancements
  1185â†’- [ ] PNG/SVG export for visualizations
  1186â†’- [ ] Real-time data streaming via WebSocket
  1187â†’- [ ] Collaborative features with shareable URLs
  1188â†’- [ ] 3D phase portraits with WebGL
  1189â†’- [ ] Accessibility improvements (ARIA labels, keyboard navigation)
  1190â†’- [ ] WebAssembly for intensive computations
  1191â†’- [ ] Bifurcation diagrams for parameter studies
  1192â†’- [ ] ABM non-visualized "fast mode" with Web Workers
  1193â†’- [ ] Additional ABM demo models (Schelling's Segregation, Conway's Game of Life)
  1194â†’- [ ] ABM parameter sweep functionality
  1195â†’
  1196â†’## Contributing
  1197â†’When modifying P5.js components:
  1198â†’1. Always test memory usage in browser DevTools
  1199â†’2. Ensure useEffect dependencies are correct
  1200â†’3. Call `p.remove()` in cleanup function
  1201â†’4. Use refs for data that shouldn't trigger re-renders
  1202â†’5. Document async loading patterns
  1203â†’
  1204â†’## Resources
  1205â†’- [Next.js Documentation](https://nextjs.org/docs)
  1206â†’- [P5.js Reference](https://p5js.org/reference/)
  1207â†’- [React Hooks](https://react.dev/reference/react)
  1208â†’- [Tailwind CSS](https://tailwindcss.com/docs)
  1209â†’
  1210â†’---
  1211â†’
  1212â†’## PLANNING: Vector Field Visualizer
  1213â†’
  1214â†’### Design Decisions Required
  1215â†’
  1216â†’**Instructions**: Fill in your requirements below. Once complete, notify Claude to review this section and implement.
  1217â†’
  1218â†’#### 1. System Definition & Input
  1219â†’**Question**: What type of systems should it support?
  1220â†’- [ ] Linear only: `dx/dt = Ax` (2Ã—2 or 3Ã—3 matrix)?
  1221â†’- [ ] Linear with input: `dx/dt = Ax + Bu`?
  1222â†’- [ ] Nonlinear: `dx/dt = f(x)` with custom functions?
  1223â†’
  1224â†’**Your Answer**:
  1225â†’Requirements: 
  1226â†’- the visualiser shall accept only linear systems of any dimension. However, Claude should keep in mind that future changes might consider extending this to non-linear systems. 
  1227â†’
  1228â†’**Question**: How should users input the system?
  1229â†’- [ ] Manual matrix entry (text fields)?
  1230â†’- [ ] JSON upload (from System Simulator)?
  1231â†’- [ ] Predefined examples?
  1232â†’- [ ] Connection to System Simulator (import A matrix directly)?
  1233â†’
  1234â†’**Your Answer**:
  1235â†’Requirements: 
  1236â†’1. The visualiser shall accept user input in the following manner:
  1237â†’   1. JSON upload via a standardised JSON format analogous to the phase-portrait visualiser. 
  1238â†’   2. Via taking the data output from the system simulator, analogous to the phase-portrait visualiser. 
  1239â†’   3. The system shall contain a predefined example, the same default system as the system simulator (mass spring damper). 
  1240â†’2. Future changes may warrant direct matrix design, but this is not the priority. 
  1241â†’---
  1242â†’
  1243â†’#### 2. Dimensionality & Projection
  1244â†’**Question**: Which dimensions to visualize?
  1245â†’- [ ] 2D only (x1 vs x2)?
  1246â†’- [ ] 3D vector fields?
  1247â†’- [ ] For higher-dimensional systems (n>2), select which 2 states to plot?
  1248â†’
  1249â†’**Your Answer**:
  1250â†’Requirements:
  1251â†’
  1252â†’1. General capabilities:
  1253â†’   1. The user shall have the capability to switch the axes on which the states sit. 
  1254â†’      1. In the context of a 2D vector field, this means inversion, or a flipping of the axes.
  1255â†’      2. In the context of a 3D vector field, this means rotating the selected states. 
  1256â†’   2. The user shall have the capability to open a number of windows. For example, the user can have two windows of 2D fields next to one another OR one windows of 3D and one windows of 2D field next to one another OR two windows of 3D visualisations next to one another. 
  1257â†’   3. The user shall have the capability to place a 'ball' in the vector field, and simulate the system over a defined time period. 
  1258â†’      1. The user shall have the capability to view the ball progress through the simulation on all the different visualisation windows. 
  1259â†’
  1260â†’
  1261â†’2. For systems that contain up to two states:
  1262â†’   1. The user shall have the capability to view ONLY a 2D visualisations of vector fields. 
  1263â†’   2. Systems of a single state shall return an error explaining that the minimum number of states is two. 
  1264â†’   3. For systems that only contain two states, the 3D visualisation shall NOT be visible, and should return an error to the user. 
  1265â†’
  1266â†’3. For systems that contain three or more states:
  1267â†’   1. The user shall have the capability to view either 2D or 3D vector fields. 
  1268â†’   2. The user shall be able to select which states to view in each visualisation window, with a maximum of three states viewable for any given window. 
  1269â†’
  1270â†’
  1271â†’**Question**: For 3+ state systems, how to handle other states?
  1272â†’- [ ] Fix them at zero?
  1273â†’- [ ] Fix at equilibrium values?
  1274â†’- [ ] User-specified slice through state space?
  1275â†’
  1276â†’**Your Answer**:
  1277â†’Requirements:
  1278â†’1. The user shall have the option to toggle between:
  1279â†’   1. Fix all other states at zero. 
  1280â†’   2. Fix all other states at equilibrium values. 
  1281â†’   3. Fix all other states at other predefined values, given by the user. 
  1282â†’   4. Default to fixing all other states at zero. 
  1283â†’2. Claude shall consider best practice UI & UX design when considering how to implement this. 
  1284â†’
  1285â†’---
  1286â†’
  1287â†’#### 3. Vector Field Representation
  1288â†’**Question**: How to display the field?
  1289â†’- [ ] Arrow grid (classic)?
  1290â†’- [ ] Streamlines/flow lines?
  1291â†’- [ ] Both options (user toggle)?
  1292â†’- [ ] Color coding by magnitude?
  1293â†’
  1294â†’**Your Answer**:
  1295â†’Requirements:
  1296â†’1. The user shall have the option to switch between:
  1297â†’   1. Arrow grid
  1298â†’   2. Streamlines
  1299â†’2. The colour coding shall be done by magnitude. 
  1300â†’
  1301â†’**Question**: Arrow scaling?
  1302â†’- [ ] Normalized (all same length, shows direction only)?
  1303â†’- [ ] Proportional to magnitude (shows speed)?
  1304â†’- [ ] Log-scaled for large dynamic ranges?
  1305â†’
  1306â†’**Your Answer**:
  1307â†’Requirements:
  1308â†’1. The visualiser shall only utilise normalized arrows. 
  1309â†’2. The visualiser shall show magnitude through colour. 
  1310â†’3. The visualiser shall user a log-scale only under circumstances where they are warranted. 
  1311â†’
  1312â†’---
  1313â†’
  1314â†’#### 4. Grid & Bounds
  1315â†’**Question**: State space range?
  1316â†’- [ ] Fixed (e.g., -10 to 10)?
  1317â†’- [ ] User-adjustable?
  1318â†’- [ ] Auto-calculated from eigenvalues/system characteristics?
  1319â†’
  1320â†’**Your Answer**:
  1321â†’Requirements:
  1322â†’1. The visualiser shall:
  1323â†’   1. Autocalculate the grid and bounds based on eigenvalue characteristics. 
  1324â†’   2. Based on the autocalculated values, the user shall have the capability to adjust these values. 
  1325â†’
  1326â†’**Question**: Grid density?
  1327â†’- [ ] Fixed grid (e.g., 20Ã—20)?
  1328â†’- [ ] User-adjustable slider?
  1329â†’- [ ] Adaptive (denser near interesting features)?
  1330â†’
  1331â†’**Your Answer**:
  1332â†’Requirements:
  1333â†’1. The grid shall be fixed and consistent, based on the state space range.
  1334â†’2. The user may change the grid bounds.
  1335â†’   1. In the case the user decides to alter the grid bounds, a button shall appear, giving the user the option to recalculate the grid. 
  1336â†’
  1337â†’---
  1338â†’
  1339â†’#### 5. Trajectory Integration
  1340â†’**Question**: Should users be able to plot solution trajectories?
  1341â†’- [ ] Click to add initial condition â†’ show trajectory?
  1342â†’- [ ] Multiple trajectories simultaneously?
  1343â†’- [ ] Forward time, backward time, or both?
  1344â†’- [ ] Integration method (Euler, RK4)?
  1345â†’
  1346â†’**Your Answer**:
  1347â†’Requirements:
  1348â†’1. The visualiser shall have the capability to plot a solution trajectory. 
  1349â†’   1. The visualiser shall allow a maximum two simultaneous trajectories to be plotted. 
  1350â†’   2. The visualiser shall only calculate forward time trajectories. 
  1351â†’   3. The visualiser shall store data on forward time trajectories, and the user shall have the capability to go backwards through the calculated trajectory. 
  1352â†’      1. The user shall go backwards through the calculated trajectory using a scrubber. 
  1353â†’2. The integration method used shall be the most computationally efficient. 
  1354â†’
  1355â†’**Question**: Trajectory visualization?
  1356â†’- [ ] Animated point moving along path?
  1357â†’- [ ] Full path drawn?
  1358â†’- [ ] Fading trail?
  1359â†’
  1360â†’**Your Answer**:
  1361â†’Requirements:
  1362â†’1. The trajectory visualisation shall contain:
  1363â†’   1. An animated point moving along a path. 
  1364â†’2. The user shall have the option to select between a fading trail and the full path up to the point calculated. 
  1365â†’
  1366â†’---
  1367â†’
  1368â†’#### 6. Analysis Features
  1369â†’**Question**: What analytical tools to include?
  1370â†’- [ ] Equilibrium points (where dx/dt = 0)?
  1371â†’- [ ] Nullclines (isoclines where one state doesn't change)?
  1372â†’- [ ] Eigenvectors of A matrix?
  1373â†’- [ ] Stability classification (saddle, stable node, unstable spiral, etc.)?
  1374â†’- [ ] Lyapunov function contours?
  1375â†’
  1376â†’**Your Answer**:
  1377â†’Requirements:
  1378â†’1. The visualiser shall contain toggles for the following analysis features:
  1379â†’   1. Equilibrium points
  1380â†’   2. Nullclines and isoclines. 
  1381â†’   3. Stability classifiers. 
  1382â†’   4. Lyapunov function contours. 
  1383â†’
  1384â†’---
  1385â†’
  1386â†’#### 7. Interactivity
  1387â†’**Question**: What interactions should be supported?
  1388â†’- [ ] Click to add trajectories?
  1389â†’- [ ] Drag matrix sliders to see real-time changes?
  1390â†’- [ ] Zoom/pan the view?
  1391â†’- [ ] Toggle nullclines/eigenvectors on/off?
  1392â†’
  1393â†’**Your Answer**:
  1394â†’Requirements:
  1395â†’1. The user shall have the ability to:
  1396â†’   1. Click to add a trajectory. 
  1397â†’   2. Pan and zoom. 
  1398â†’   3. Toggle the analysis features off individually. 
  1399â†’
  1400â†’---
  1401â†’
  1402â†’#### 8. Integration with Existing Pages
  1403â†’**Question**: How should it connect to other tools?
  1404â†’- [ ] "View Vector Field" button in System Simulator (like Phase Portrait)?
  1405â†’- [ ] Only for 2-state systems?
  1406â†’- [ ] Extract 2D subsystems from higher-dimensional systems?
  1407â†’
  1408â†’**Your Answer**:
  1409â†’Requirements:
  1410â†’1. There shall be a button in the system simulator page that links to the vector field page. 
  1411â†’2. There shall be a button in the phase portrait page that links to the vector field page. 
  1412â†’3. There shall be two buttons in the vector field page that link to both the system simulator page and the phase portrait page. 
  1413â†’
  1414â†’---
  1415â†’
  1416â†’#### 9. Predefined Examples
  1417â†’**Question**: What examples to include?
  1418â†’
  1419â†’**Your Answer**:
  1420â†’Requirements:
  1421â†’1. The predefined example to include shall be a mass-spring-damper system for a 2D vector field. 
  1422â†’2. The predefined example to include shall be a lorenz attrctor for a 3D vector field. 
  1423â†’
  1424â†’---
  1425â†’
  1426â†’#### 10. Performance & Rendering
  1427â†’**Question**: Technology choice?
  1428â†’- [ ] P5.js (consistent with other visualizations)?
  1429â†’- [ ] Canvas API directly (better performance)?
  1430â†’- [ ] WebGL for 3D?
  1431â†’
  1432â†’**Your Answer**:
  1433â†’Claude shall decide what the best technologies are to implement this page. 
  1434â†’Claude should factor in extensibility when considering the technologies to use. 
  1435â†’
  1436â†’---
  1437â†’
  1438â†’### Summary of Requirements
  1439â†’Once you've filled in the sections above, provide a brief summary here:
  1440â†’
  1441â†’**Must-have features for v1**:
  1442â†’1. 2D/3D switch, switching from mass spring damper to lorenz attractor. 
  1443â†’2. extensible technology choice.
  1444â†’
  1445â†’**Nice-to-have features for later**:
  1446â†’All the rest shall be implemented step by step. 
  1447â†’
  1448â†’**Special considerations**:
  1449â†’
  1450â†’
  1451â†’---
  1452â†’**STATUS**: â³ Awaiting user input. Notify Claude when ready to implement.
  1453â†’
  1454â†’---
  1455â†’---
  1456â†’
  1457â†’## PLANNING: Agent-Based Modeling (ABM) Simulator
  1458â†’
  1459â†’**Vision Statement:**
  1460â†’Create a general-purpose agent-based modeling platform that can simulate diverse systems (social, transport, ecological, etc.) from JSON configuration files. Support both visualized and non-visualized (fast) execution modes. Use a flexible framework based on: Environment + Agents + Interaction Rules.
  1461â†’
  1462â†’The ABM simulator is strictly 2D. 
  1463â†’
  1464â†’Thinking:
  1465â†’1. Should use ODD protocol: [examples](https://jasss.soc.surrey.ac.uk/23/2/7/S2-ODD.pdf)
  1466â†’
  1467â†’
  1468â†’---
  1469â†’
  1470â†’### 1. Framework Architecture & Design Philosophy
  1471â†’
  1472â†’**Question**: How should we structure the ABM framework to maximize generality while remaining practical?
  1473â†’
  1474â†’**Considerations**:
  1475â†’- Object-oriented approach (Agent class, Environment class, Simulation class)?
  1476â†’- Entity-Component-System (ECS) pattern for maximum flexibility?
  1477â†’- behaviour composition (agents have pluggable behaviors)?
  1478â†’- Event-driven vs tick-based simulation loop?
  1479â†’- How to balance ease of use vs extensibility?
  1480â†’
  1481â†’**Your Answer**:
  1482â†’Requirements:
  1483â†’1. The framework shall utilize the Entity-Component-System (ECS) pattern.
  1484â†’   1. **Entities** are unique identifiers with no intrinsic data or behaviour.
  1485â†’   2. **Components** are pure data containers, serializable to/from JSON.
  1486â†’   3. **Systems** are stateless processors that operate on entities possessing specific component combinations.
  1487â†’
  1488â†’2. The framework shall implement a three-layer architecture:
  1489â†’   1. **Layer 1 - JSON Model Definition**: Declarative specification of entities, components, behaviours, and rules following the ODD protocol.
  1490â†’   2. **Layer 2 - Primitives Library**: Domain-agnostic operations (spatial queries, vector math, state transitions, aggregations) that behaviours compose from.
  1491â†’   3. **Layer 3 - Interpreter Systems**: Execute composed behaviours by evaluating primitive operations against entity data.
  1492â†’
  1493â†’3. Behaviours shall emerge from **primitive composition**, not custom code.
  1494â†’   1. The framework shall provide primitives in these categories:
  1495â†’      - **Spatial**: `withinRadius`, `nearestN`, `inRegion`, `distance`
  1496â†’      - **Aggregation**: `average`, `sum`, `count`, `min`, `max`
  1497â†’      - **Steering**: `seek`, `flee`, `arrive`, `wander`, `separation`, `alignment`, `cohesion`
  1498â†’      - **Filters**: component presence, property comparisons, logical combinators
  1499â†’      - **State**: `transition`, `timer`, `counter`, `set`, `increment`
  1500â†’      - **Math**: `lerp`, `clamp`, `noise`, `sampleDistribution`, `arithmetic`
  1501â†’   2. New behaviours shall be created by composing existing primitives in JSON, not by writing code.
  1502â†’
  1503â†’---
  1504â†’
  1505â†’### 2. Agent Definition & Properties
  1506â†’
  1507â†’**Question**: What properties and capabilities should agents have? How are they specified in JSON?
  1508â†’
  1509â†’**Considerations**:
  1510â†’- Core properties: position, state, type, unique ID?
  1511â†’- Custom properties per agent type (e.g., "hunger" for predator, "speed" for vehicle)?
  1512â†’- Agent behaviours: movement, sensing, decision-making, communication?
  1513â†’- Agent lifecycle: birth, death, reproduction?
  1514â†’- Memory/history: do agents remember past states or interactions?
  1515â†’- Heterogeneous agents: can different agent types coexist in one simulation?
  1516â†’
  1517â†’**Your Answer**:
  1518â†’Requirements:
  1519â†’1. Agent definitions shall follow the ODD protocol's "Entities, State Variables, and Scales" section.
  1520â†’
  1521â†’2. The JSON shall define **component types** (schemas for data containers):
  1522â†’   1. Each component type shall declare its properties and their data types.
  1523â†’   2. Supported data types: `number`, `string`, `boolean`, `enum`, `vector2D`, `entityRef`, `entityRefArray`.
  1524â†’
  1525â†’3. The JSON shall define **archetypes** (templates for entity creation):
  1526â†’   1. An archetype specifies which components an entity has and their default values.
  1527â†’   2. Archetypes may inherit from other archetypes.
  1528â†’
  1529â†’4. Entity instantiation shall support:
  1530â†’   1. Explicit individual entities with specific property values.
  1531â†’   2. Bulk spawning with count, spatial distribution, and statistical variation on properties.
  1532â†’
  1533â†’5. Agent lifecycle events shall be declaratively specified:
  1534â†’   1. Creation conditions (spawning rules).
  1535â†’   2. Destruction conditions (death/removal criteria).
  1536â†’   3. Lifecycle events shall be defined as rules with conditions and effects.
  1537â†’
  1538â†’6. All agents shall automatically have:
  1539â†’   1. A unique ID (auto-generated).
  1540â†’   2. A `Position` component if spatial simulation is enabled.
  1541â†’
  1542â†’---
  1543â†’
  1544â†’### 3. Environment Representation
  1545â†’
  1546â†’**Question**: How should the environment be structured? What types of spatial models should we support?
  1547â†’
  1548â†’**Considerations**:
  1549â†’- Continuous 2D/3D space (x, y, z coordinates)?
  1550â†’- Discrete grid (cellular automata style)?
  1551â†’- Network/graph topology (nodes and edges)?
  1552â†’- Toroidal boundaries (wrap-around) vs hard boundaries?
  1553â†’- Environmental properties: resources, terrain, obstacles, zones?
  1554â†’- Multi-layer environments (e.g., ground + air layers)?
  1555â†’- Environment dynamics: does the environment change over time?
  1556â†’
  1557â†’**Your Answer**:
  1558â†’Requirements:
  1559â†’1. The JSON shall define spatial structure under an `environment` or `scales.spatial` key.
  1560â†’
  1561â†’2. Supported spatial types:
  1562â†’   1. `continuous2D`: Continuous x, y coordinates within bounds.
  1563â†’   2. `grid2D`: Discrete cells with integer coordinates.
  1564â†’   3. `network`: Graph topology with nodes and edges (agents occupy nodes or traverse edges).
  1565â†’
  1566â†’3. Boundary conditions:
  1567â†’   1. `toroidal` (default): Agents wrap around edges.
  1568â†’   2. `bounded`: Agents cannot exit; collision or reflection at edges.
  1569â†’   3. `infinite`: No boundaries (use with caution for performance).
  1570â†’
  1571â†’4. The environment shall support **spatial indexing** for efficient neighbour queries:
  1572â†’   1. For `continuous2D`: Quadtree or spatial hash grid (implementation detail, not user-facing).
  1573â†’   2. For `grid2D`: Direct cell lookup.
  1574â†’   3. For `network`: Adjacency list traversal.
  1575â†’
  1576â†’5. The environment may define **static features**:
  1577â†’   1. Obstacles (regions agents cannot enter).
  1578â†’   2. Zones (named regions that affect behaviour or are queryable).
  1579â†’   3. Resource fields (scalar values at positions, e.g., food density).
  1580â†’
  1581â†’6. Environment dynamics:
  1582â†’   1. Static features may have update rules (e.g., resource regeneration).
  1583â†’   2. Environment rules follow the same primitive composition as agent behaviours.
  1584â†’
  1585â†’---
  1586â†’
  1587â†’### 4. Interaction Rules & Behaviours
  1588â†’
  1589â†’**Question**: How do agents interact with each other and the environment? How are these rules specified?
  1590â†’
  1591â†’**Considerations**:
  1592â†’- Sensing radius: how far can agents "see"?
  1593â†’- Interaction types: collision, communication, resource transfer, reproduction?
  1594â†’- Rule specification: hard-coded behaviours vs user-defined rules?
  1595â†’- Probabilistic vs deterministic interactions?
  1596â†’- Local vs global interactions (neighborhood vs broadcast)?
  1597â†’- Force-based interactions (attraction/repulsion like flocking)?
  1598â†’- Conditional behaviours: if-then rules, state machines, decision trees?
  1599â†’- Scripting language for custom behaviours (e.g., JavaScript expressions in JSON)?
  1600â†’
  1601â†’**Your Answer**:
  1602â†’Requirements:
  1603â†’1. No scripting or executable code shall be permitted in JSON. All logic shall be expressed as **structured rule definitions**.
  1604â†’
  1605â†’2. Rules shall follow a **condition â†’ effect** structure:
  1606â†’```
  1607â†’   {
  1608â†’     "name": "ruleName",
  1609â†’     "trigger": { ... },      // when to evaluate
  1610â†’     "condition": { ... },    // predicate tree (must be true to fire)
  1611â†’     "effect": { ... }        // what happens
  1612â†’   }
  1613â†’```
  1614â†’
  1615â†’3. **Conditions** shall be expressed as predicate trees, not strings:
  1616â†’   1. Comparison operators: `eq`, `neq`, `gt`, `gte`, `lt`, `lte`
  1617â†’   2. Logical operators: `and`, `or`, `not`
  1618â†’   3. Property access: `{ "prop": "self.ComponentName.property" }`
  1619â†’   4. Literal values: numbers, strings, booleans directly
  1620â†’   
  1621â†’   Example:
  1622â†’```json
  1623â†’   {
  1624â†’     "and": [
  1625â†’       { "gt": [{ "prop": "self.Energy.value" }, 50] },
  1626â†’       { "eq": [{ "prop": "self.State.status" }, "hungry"] }
  1627â†’     ]
  1628â†’   }
  1629â†’```
  1630â†’
  1631â†’4. **Effects** shall be expressed as operation trees:
  1632â†’   1. `set`: Assign a value to a property.
  1633â†’   2. `increment` / `decrement`: Modify numeric properties.
  1634â†’   3. `transition`: Change a state machine state.
  1635â†’   4. `spawn`: Create a new entity.
  1636â†’   5. `destroy`: Remove an entity.
  1637â†’   6. `emit`: Emit an event for logging/observation.
  1638â†’
  1639â†’5. **Triggers** define when rules are evaluated:
  1640â†’   1. `everyTick`: Evaluate each timestep.
  1641â†’   2. `onProximity`: Evaluate when entities are within range.
  1642â†’   3. `onStateChange`: Evaluate when a specific property changes.
  1643â†’   4. `onEvent`: Evaluate when a named event is emitted.
  1644â†’
  1645â†’6. **Probabilistic effects** shall be supported:
  1646â†’```json
  1647â†’   {
  1648â†’     "probability": { "mul": [0.03, { "prop": "source.Contagion.infectivity" }] },
  1649â†’     "effect": { "set": { "target": "self.Health.status", "value": "infected" } }
  1650â†’   }
  1651â†’```
  1652â†’
  1653â†’7. **Steering behaviors** shall be composable in JSON:
  1654â†’```json
  1655â†’   {
  1656â†’     "SteeringBehavior": {
  1657â†’       "rules": [
  1658â†’         { "type": "separation", "query": { "radius": 25 }, "weight": 1.5 },
  1659â†’         { "type": "cohesion", "query": { "radius": 50, "filter": { "hasComponent": "Flockmate" } }, "weight": 1.0 },
  1660â†’         { "type": "flee", "query": { "radius": 100, "filter": { "hasComponent": "Predator" } }, "weight": 3.0 }
  1661â†’       ]
  1662â†’     }
  1663â†’   }
  1664â†’```
  1665â†’
  1666â†’---
  1667â†’
  1668â†’### 5. JSON Data Format & Schema
  1669â†’
  1670â†’**Question**: What should the JSON structure look like? How do we make it intuitive yet powerful?
  1671â†’
  1672â†’**Considerations**:
  1673â†’- Top-level keys: simulation metadata, environment config, agent definitions, rules?
  1674â†’- Agent initialization: list of individual agents vs population specifications?
  1675â†’- Rule definitions: array of rule objects with conditions and actions?
  1676â†’- Parameter sweeps: support for multiple runs with varying parameters?
  1677â†’- Validation: JSON schema for type checking?
  1678â†’- Example ABM types to support initially:
  1679â†’  - Predator-prey (Lotka-Volterra)
  1680â†’  - Traffic/transportation
  1681â†’  - Epidemic spread (SIR model)
  1682â†’  - Social networks
  1683â†’  - Flocking/swarming
  1684â†’  - Cellular automata (Conway's Game of Life)
  1685â†’
  1686â†’**Your Answer**:
  1687â†’Requirements:
  1688â†’1. The JSON structure shall align with the ODD protocol:
  1689â†’```
  1690â†’   {
  1691â†’     "overview": { ... },
  1692â†’     "designConcepts": { ... },
  1693â†’     "details": { ... }
  1694â†’   }
  1695â†’```
  1696â†’
  1697â†’2. **Overview** section shall contain:
  1698â†’   1. `purpose`: String describing the model's purpose.
  1699â†’   2. `entities`: Component type definitions and archetypes.
  1700â†’   3. `stateVariables`: Alias for component properties (for ODD compliance).
  1701â†’   4. `scales`: Spatial and temporal configuration.
  1702â†’   5. `processSchedule`: Ordered list of systems to execute each tick.
  1703â†’
  1704â†’3. **Design Concepts** section shall contain:
  1705â†’   1. `sensing`: What information agents can perceive about others.
  1706â†’   2. `interaction`: Rules governing agent-agent and agent-environment interactions.
  1707â†’   3. `stochasticity`: Random seed and which processes use randomness.
  1708â†’   4. `observation`: What data to collect for output/visualization.
  1709â†’
  1710â†’4. **Details** section shall contain:
  1711â†’   1. `initialization`: Entity spawning rules, initial conditions, optional external data files.
  1712â†’   2. `submodels`: Named behavior modules composed from primitives.
  1713â†’   3. `interventions`: Conditional modifications triggered during simulation (optional).
  1714â†’
  1715â†’5. The framework shall validate JSON against a published JSON Schema before execution.
  1716â†’   1. Validation errors shall be reported with line numbers and clear messages.
  1717â†’   2. The schema shall be versioned (e.g., `"schemaVersion": "1.0"`).
  1718â†’
  1719â†’6. The JSON format shall be **LLM-friendly**:
  1720â†’   1. Consistent key naming (camelCase).
  1721â†’   2. No ambiguous overloading of keys.
  1722â†’   3. Explicit type indicators where needed.
  1723â†’   4. Reasonable defaults for optional fields.
  1724â†’
  1725â†’
  1726â†’---
  1727â†’
  1728â†’### 6. Simulation Engine & Execution
  1729â†’
  1730â†’**Question**: How should the simulation loop work? What scheduling and update mechanisms?
  1731â†’
  1732â†’**Considerations**:
  1733â†’- Timestep size: fixed dt vs variable (event-driven)?
  1734â†’- Update order: synchronous (all agents update at once) vs asynchronous (sequential)?
  1735â†’- Random vs deterministic ordering of agent updates?
  1736â†’- Scheduling: should certain agents/events happen at specific times?
  1737â†’- Termination conditions: fixed duration, equilibrium detection, custom criteria?
  1738â†’- Pause/resume/reset capabilities?
  1739â†’- Performance targets: how many agents should we support (100? 1000? 10000+)?
  1740â†’
  1741â†’**Your Answer**:
  1742â†’Requirements:
  1743â†’1. Timestep is a fixed dt determined in the json. 
  1744â†’2. Update order is asynchronous. 
  1745â†’3. Termination condition is a fixed duration of time, determined in the json file, and is an input field in the page. 
  1746â†’4. Buttons on the page shall include:
  1747â†’   1. Pause/resume/reset capabilities. 
  1748â†’5. Performance targets:
  1749â†’   1. The simulation shall support up to 100 agents. 
  1750â†’6. **Process scheduling** shall be explicitly defined in JSON:
  1751â†’   1. Systems execute in the order listed in `processSchedule`.
  1752â†’   2. Each system entry may specify:
  1753â†’      - `order`: `"parallel"` (all entities update simultaneously) or `"sequential"` (one at a time).
  1754â†’      - `shuffle`: If sequential, whether to randomize entity order each tick.
  1755â†’   
  1756â†’   Example:
  1757â†’```json
  1758â†’   {
  1759â†’     "processSchedule": [
  1760â†’       { "system": "Sensing", "order": "parallel" },
  1761â†’       { "system": "Decision", "order": "sequential", "shuffle": true },
  1762â†’       { "system": "Movement", "order": "parallel" },
  1763â†’       { "system": "Interaction", "order": "sequential", "shuffle": true }
  1764â†’     ]
  1765â†’   }
  1766â†’```
  1767â†’
  1768â†’7. **Stochasticity** shall be reproducible:
  1769â†’   1. A `seed` value in JSON determines all random number generation.
  1770â†’   2. If no seed is provided, a random seed is generated and reported.
  1771â†’   3. The UI shall display the current seed and allow the user to input a specific seed.
  1772â†’---
  1773â†’
  1774â†’### 7. Visualization Options
  1775â†’
  1776â†’**Question**: What should be visualized and how? What rendering technologies should we use?
  1777â†’
  1778â†’**Considerations**:
  1779â†’- ~~Rendering library: P5.js (consistency with other visualizations), raw Canvas 2D, WebGL (for 10,000+ agents)?~~
  1780â†’- ~~Visual representation of agents: circles/dots, sprites/images, custom shapes?~~
  1781â†’- ~~Color coding: by agent type, state, property value?~~
  1782â†’- Environment visualization: background, resource density heatmaps, obstacles?
  1783â†’- Trails: show agent movement history?
  1784â†’- Real-time graphs: population over time, resource levels, statistics?
  1785â†’- ~~2D vs 3D visualization (is 3D necessary for any ABM types)?~~
  1786â†’- ~~Zoom and pan controls?~~
  1787â†’- ~~Agent labels/tooltips on hover?~~
  1788â†’
  1789â†’**Your Answer**:
  1790â†’Requirements:
  1791â†’1. There shall be only a 2D visualisation of the model. 
  1792â†’2. There shall be no pan/zoom controls. 
  1793â†’3. The user shall be able to see current individual agent states when clicking on an agent.
  1794â†’4. The visual representation of agents shall be as coloured circles by default. 
  1795â†’   1. The user shall have the capability to define groups of agents, and for each group the json shall have the capability to define what shape is used per group. 
  1796â†’      1. The system shall accept icons from icon libraries to represent agents, referenced via a link to the icon. 
  1797â†’   2. If the json requests multiple groups and no shape is assigned for that group, then a random shape is assigned. 
  1798â†’   3. A legend shall display the groups, if there is more than one group. 
  1799â†’5. The agent-based model simulator is strictly 2D. 
  1800â†’   1. The simulator makes use of WebGL in order to optimise the simulation. 
  1801â†’6. There shall be no zoom or pan controls. The window shall show the full simulation. 
  1802â†’7. Colouring shall be defined as follows:
  1803â†’   1. By default, colouring shall be defined by the agent type. 
  1804â†’   2. The inputted json shall be able to define if the colouring should be determined by a particular agent state. The agent states shall contain a maximum and minimum range, as defined in the ODD. Therefore, the user shall be able to define two colours, representing the maximum and minimum range of the state. 
  1805â†’8. The environment
  1806â†’9. Real-time graphs
  1807â†’   1. The user shall be able to view two timeseries plots in two vertical windows below the simulation. 
  1808â†’   2. The first timeseries plot shall focus on the large-scale simulation, and should have tickboxes which determine which states to visualise. 
  1809â†’   3. The second timeseries plot shall focus on the individual agents. 
  1810â†’      1. The second plot shall have two dropdowns
  1811â†’         1. The first dropdown shall define which agent GROUP the user wishes to view the states for. 
  1812â†’         2. The second dropdown shall define which INDIVIDUAL agent the user wishes to view the states for. 
  1813â†’10. **Graph update frequency**: Time series plots shall update every N ticks (configurable, default 1).
  1814â†’
  1815â†’11. **Color interpolation**: When coloring by state value, interpolation shall be linear in RGB space by default.
  1816â†’
  1817â†’12. **Click-to-inspect**: When a user clicks an agent, a panel shall display:
  1818â†’    1. Entity ID
  1819â†’    2. Archetype name
  1820â†’    3. All component data as key-value pairs
  1821â†’    4. Option to "track" this agent (highlight it persistently)
  1822â†’
  1823â†’
  1824â†’---
  1825â†’
  1826â†’### 8. Non-Visualized Performance Mode
  1827â†’
  1828â†’**Question**: How should the "fast mode" work? What optimizations are needed?
  1829â†’
  1830â†’**Considerations**:
  1831â†’- Skip all rendering, run simulation logic only?
  1832â†’- Use Web Workers to avoid blocking UI?
  1833â†’- Batch processing: run N timesteps then update progress?
  1834â†’- Output options: final state only vs periodic snapshots vs full timeseries?
  1835â†’- Speed comparison target: how much faster should it be (10x? 100x?)?
  1836â†’- Progress reporting: how to show user that simulation is running?
  1837â†’- Memory management for long simulations?
  1838â†’
  1839â†’**Your Answer**:
  1840â†’For now do not implement this, but consider that this may be a feature added later on when architecting the software. 
  1841â†’
  1842â†’Requirements:
  1843â†’1. 
  1844â†’
  1845â†’---
  1846â†’
  1847â†’### 9. Data Output & Analytics
  1848â†’
  1849â†’**Question**: What data should be collected and exported? What analysis tools should be built-in?
  1850â†’
  1851â†’**Considerations**:
  1852â†’- Timeseries data: agent positions, states, population counts?
  1853â†’- Aggregate statistics: mean, variance, spatial density?
  1854â†’- Export formats: JSON (full state), CSV (timeseries), images/video (visualization)?
  1855â†’- Real-time plotting: population dynamics, phase portraits, histograms?
  1856â†’- Metrics specific to ABM type (e.g., clustering coefficient for social networks)?
  1857â†’- Integration with existing visualizers (state space, time series, network graphs)?
  1858â†’
  1859â†’**Your Answer**:
  1860â†’Requirements:
  1861â†’1. The JSON shall define an `observation` section specifying what data to collect:
  1862â†’```json
  1863â†’   {
  1864â†’     "observation": {
  1865â†’       "timeseries": [
  1866â†’         { "name": "susceptible", "query": { "count": { "filter": { "eq": ["Health.status", "S"] } } } },
  1867â†’         { "name": "avgSpeed", "query": { "average": { "property": "Velocity.magnitude" } } }
  1868â†’       ],
  1869â†’       "snapshots": {
  1870â†’         "every": 10,
  1871â†’         "include": ["Position", "Health"]
  1872â†’       },
  1873â†’       "events": ["infection", "death", "birth"]
  1874â†’     }
  1875â†’   }
  1876â†’```
  1877â†’
  1878â†’2. Export formats:
  1879â†’   1. **JSON**: Full simulation state or timeseries.
  1880â†’   2. **CSV**: Timeseries data with columns per observed metric.
  1881â†’
  1882â†’3. Event logging:
  1883â†’   1. Rules may emit named events via the `emit` effect.
  1884â†’   2. Events are logged with tick number, involved entity IDs, and event data.
  1885â†’   3. Event logs can be exported separately.
  1886â†’
  1887â†’---
  1888â†’
  1889â†’### 10. Integration with Existing Platform
  1890â†’
  1891â†’**Question**: How does ABM fit into the current visualization platform?
  1892â†’
  1893â†’**Considerations**:
  1894â†’- Page structure: similar to `/vectorfield` and `/systemmodel`?
  1895â†’- File upload zone for JSON configuration?
  1896â†’- Demo simulations with pre-loaded examples?
  1897â†’- Navigation: how to link from other pages (if at all)?
  1898â†’- Homepage listing: should it be in "System Models" or "Visualizations"?
  1899â†’- Data flow: can ABM results be exported to other visualizers?
  1900â†’
  1901â†’**Your Answer**:
  1902â†’Requirements:
  1903â†’1. The page structure shall be similar to `/vectorfield` and `/systemmodel`.
  1904â†’2. There shall be a file upload zone for the JSON configuration.
  1905â†’3. There shall be a preloaded example, namely Schellings segregation model, Conways game of life, and the predator prey system.
  1906â†’4. The homepage listing shall be under system models.
  1907â†’5. ABM results can be exported to other visualisers.
  1908â†’6. Page layout (top to bottom):
  1909â†’   1. Demo selector and file upload zone
  1910â†’   2. Simulation canvas (full width)
  1911â†’   3. Model Info section (below simulation, showing purpose, agent count, dt)
  1912â†’   4. Two timeseries graphs (aggregate population dynamics and individual agent metrics)
  1913â†’   5. Instructions panel
  1914â†’   6. Expected JSON Format section with example code block (like other visualization pages) 
  1915â†’
  1916â†’---
  1917â†’
  1918â†’### 11. Extensibility & Plugin System
  1919â†’
  1920â†’**Question**: How can users add custom behaviours without modifying core code?
  1921â†’
  1922â†’**Considerations**:
  1923â†’- Plugin architecture: allow users to define custom agent classes?
  1924â†’- behaviour composition: mix-and-match predefined behaviors?
  1925â†’- ~~Custom rules in JSON: support JavaScript expressions (eval) or safe subset?~~
  1926â†’- Template library: common behaviours (seek, flee, wander, flock)?
  1927â†’- Version compatibility: how to handle breaking changes?
  1928â†’
  1929â†’**Your Answer**:
  1930â†’Requirements:
  1931â†’1. No custom code or scripts shall be permitted in JSON (security requirement).
  1932â†’
  1933â†’2. Extensibility shall be achieved through **primitive composition**:
  1934â†’   1. Users create novel behaviors by combining existing primitives in JSON.
  1935â†’   2. The primitives library shall be comprehensive enough that most ABM behaviors are expressible.
  1936â†’
  1937â†’3. **Archetype inheritance** allows building complex agent types from simpler ones:
  1938â†’```json
  1939â†’   {
  1940â†’     "archetypes": {
  1941â†’       "BaseAgent": { "Position": {}, "Velocity": {} },
  1942â†’       "Prey": { "extends": "BaseAgent", "Health": { "value": 100 }, "FleesBehavior": { ... } },
  1943â†’       "SmartPrey": { "extends": "Prey", "Memory": { "capacity": 5 } }
  1944â†’     }
  1945â†’   }
  1946â†’```
  1947â†’
  1948â†’4. **Submodel modularity**: Named behavior modules can be defined once and referenced:
  1949â†’```json
  1950â†’   {
  1951â†’     "submodels": {
  1952â†’       "standardFlocking": {
  1953â†’         "type": "SteeringBehavior",
  1954â†’         "rules": [ ... ]
  1955â†’       }
  1956â†’     },
  1957â†’     "archetypes": {
  1958â†’       "Bird": {
  1959â†’         "Position": {},
  1960â†’         "Velocity": {},
  1961â†’         "SteeringBehavior": { "ref": "standardFlocking" }
  1962â†’       }
  1963â†’     }
  1964â†’   }
  1965â†’```
  1966â†’
  1967â†’5. Future consideration: A curated **behavior library** of pre-built submodels (flocking, SIR, pursuit-evasion) that users can import by name.
  1968â†’
  1969â†’---
  1970â†’
  1971â†’### 12. Demo Examples & Use Cases
  1972â†’
  1973â†’**Question**: What example simulations should we include to demonstrate capabilities?
  1974â†’
  1975â†’**Considerations**:
  1976â†’- Starter examples (must include):
  1977â†’  - Flocking/Boids (already have `/flocking` page - integrate or separate?)
  1978â†’  - Predator-prey dynamics
  1979â†’  - Epidemic spread (SIR/SEIR model)
  1980â†’  - Traffic simulation
  1981â†’  - Conway's Game of Life
  1982â†’- Domain coverage: ensure examples span social, ecological, physical systems
  1983â†’- Complexity gradient: simple â†’ intermediate â†’ advanced examples
  1984â†’- Educational value: can examples teach ABM concepts?
  1985â†’
  1986â†’**Your Answer**:
  1987â†’Requirements:
  1988â†’1. The framework shall ship with these example simulations:
  1989â†’   1. **Schelling's Segregation Model** â€” demonstrates grid-based movement, threshold rules.
  1990â†’   2. **Conway's Game of Life** â€” demonstrates cellular automata, grid environment.
  1991â†’   3. **Predator-Prey (Lotka-Volterra)** â€” demonstrates heterogeneous agents, reproduction, death.
  1992â†’   4. **Flocking (Boids)** â€” demonstrates steering behaviors, continuous space.
  1993â†’   5. **SIR Epidemic** â€” demonstrates state machines, probabilistic transmission.
  1994â†’
  1995â†’2. Examples shall be selectable from a dropdown in the UI.
  1996â†’
  1997â†’3. Each example shall include:
  1998â†’   1. The JSON configuration.
  1999â†’   2. A brief description displayed to the user.
  2000â†’   3. Suggested parameters to experiment with.
  2001â†’
  2002â†’---
  2003â†’
  2004â†’### 13. Performance & Scalability
  2005â†’
  2006â†’**Question**: What performance optimizations are critical? What are acceptable limits?
  2007â†’
  2008â†’**Considerations**:
  2009â†’- Spatial indexing: quadtree/grid for efficient neighbor searches?
  2010â†’- Level of detail: render fewer agents when zoomed out?
  2011â†’- Agent pooling: reuse objects instead of creating/destroying?
  2012â†’- Culling: only update/render agents in viewport?
  2013â†’- WebGL instancing for rendering thousands of similar agents?
  2014â†’- Progressive enhancement: graceful degradation for low-end devices?
  2015â†’- Benchmarking: what metrics to track (FPS, agents/sec, memory)?
  2016â†’
  2017â†’**Your Answer**:
  2018â†’Requirements:
  2019â†’1. The simulation shall support up to 100 agents at 60 FPS (as stated in Q6).
  2020â†’
  2021â†’2. **Spatial indexing** shall be implemented for neighbor queries:
  2022â†’   1. For continuous space: spatial hash grid or quadtree.
  2023â†’   2. Neighbor queries shall be O(k) where k is the number of neighbors, not O(n) where n is total agents.
  2024â†’
  2025â†’3. **Rendering optimization**:
  2026â†’   1. Use WebGL instanced rendering for drawing agents.
  2027â†’   2. Batch draw calls by visual type (shape + color).
  2028â†’
  2029â†’4. **Future consideration**: For non-visualized mode, Web Workers shall be used to avoid blocking the UI thread.
  2030â†’
  2031â†’---
  2032â†’
  2033â†’### 14. User Interface & Controls
  2034â†’
  2035â†’**Question**: What controls should users have during simulation? What parameters should be adjustable in real-time?
  2036â†’
  2037â†’**Considerations**:
  2038â†’- Playback: play, pause, step forward, reset?
  2039â†’- Speed control: 0.1x to 10x simulation speed?
  2040â†’- Live parameter adjustment: change agent behaviours while running?
  2041â†’- Add/remove agents manually (click to add, click to remove)?
  2042â†’- Visualization toggles: show/hide trails, labels, grid, zones?
  2043â†’- Camera controls: pan, zoom, rotate (if 3D)?
  2044â†’- Inspector: click agent to see detailed state?
  2045â†’
  2046â†’**Your Answer**:
  2047â†’Requirements:
  2048â†’1. **Playback controls**:
  2049â†’   1. Play / Pause button.
  2050â†’   2. Step forward (advance one tick while paused).
  2051â†’   3. Reset (return to initial state).
  2052â†’
  2053â†’2. **Speed control**:
  2054â†’   1. Slider or dropdown for simulation speed: 0.5x, 1x, 2x. 
  2055â†’   2. Speed affects ticks per second, not timestep size.
  2056â†’
  2057â†’3. **Parameter adjustment**:
  2058â†’   1. Key simulation parameters (as defined in JSON under a `uiParameters` section) shall be editable in the UI.
  2059â†’   2. Changes take effect immediately (next tick).
  2060â†’   3. Example:
  2061â†’```json
  2062â†’     {
  2063â†’       "uiParameters": [
  2064â†’         { "name": "Transmission Rate", "path": "diseaseParams.transmissionProb", "min": 0, "max": 1, "step": 0.01 }
  2065â†’       ]
  2066â†’     }
  2067â†’```
  2068â†’
  2069â†’4. **Visualization toggles**:
  2070â†’   1. Show/hide trails.
  2071â†’   2. Show/hide grid (if grid environment).
  2072â†’   3. Show/hide zones.
  2073â†’
  2074â†’5. **Inspector panel**: Click an agent to see its state (covered in Q7).
  2075â†’
  2076â†’---
  2077â†’
  2078â†’### 15. Technology Stack Decision
  2079â†’
  2080â†’**Question**: What rendering and computation technologies should we use?
  2081â†’
  2082â†’**Considerations**:
  2083â†’- Visualization: P5.js vs raw Canvas 2D vs WebGL?
  2084â†’  - P5.js: consistent with existing visualizations, easier to use
  2085â†’  - Canvas 2D: lighter weight, more control
  2086â†’  - WebGL: maximum performance for 10,000+ agents
  2087â†’- Web Workers: for non-visualized mode?
  2088â†’- WebAssembly: for compute-intensive simulations (physics, pathfinding)?
  2089â†’- State management: React state vs separate simulation controller?
  2090â†’- Type safety: TypeScript interfaces for all ABM components?
  2091â†’
  2092â†’**Your Answer**:
  2093â†’
  2094â†’Requirements:
  2095â†’
  2096â†’1. **Rendering**: PIXI.js (WebGL-based 2D renderer).
  2097â†’   1. Use `ParticleContainer` for efficient batch rendering of agents.
  2098â†’   2. Automatic fallback to Canvas 2D via PIXI's built-in detection.
  2099â†’   3. Target: 100 agents at 60 FPS (with headroom to 1000+).
  2100â†’
  2101â†’2. **Framework**: Integrate with existing platform (React, TypeScript).
  2102â†’   1. PIXI application shall be encapsulated in a React component.
  2103â†’   2. PIXI canvas lifecycle (create, resize, destroy) shall be managed via React `useEffect`.
  2104â†’
  2105â†’3. **Simulation logic**: Pure TypeScript, decoupled from rendering.
  2106â†’   1. Simulation state shall be serializable (for save/load, export).
  2107â†’   2. The ECS world shall be updated independently of the PIXI render loop.
  2108â†’   3. The renderer shall only read from the ECS world, never mutate it.
  2109â†’
  2110â†’4. **JSON validation**: Use Ajv for JSON Schema validation.
  2111â†’
  2112â†’5. **Expression evaluation**: Custom safe evaluator for predicate/operation trees (no `eval`, no `Function`).
  2113â†’
  2114â†’6. **State management**: 
  2115â†’   1. Simulation state managed by a controller class.
  2116â†’   2. React UI subscribes to state updates via callbacks or a lightweight event emitter.
  2117â†’   3. PIXI renderer subscribes to entity positions/visuals for rendering.
  2118â†’
  2119â†’---
  2120â†’
  2121â†’### Summary of Requirements
  2122â†’
  2123â†’**Implemented features (v1)**:
  2124â†’1. âœ… ECS architecture with Entity, Component, System pattern
  2125â†’2. âœ… Safe expression evaluator (no eval/Function) for conditions and effects
  2126â†’3. âœ… PIXI.js WebGL rendering with multi-layer containers
  2127â†’4. âœ… ODD protocol-compliant JSON structure
  2128â†’5. âœ… Spatial indexing with O(k) neighbor queries
  2129â†’6. âœ… Seeded RNG for reproducible simulations
  2130â†’7. âœ… Three demo models: Flocking, SIR Epidemic, Predator-Prey
  2131â†’8. âœ… Click-to-inspect agent state
  2132â†’9. âœ… Timeseries graphs for aggregate and individual metrics
  2133â†’10. âœ… Playback controls (play/pause/reset/step)
  2134â†’11. âœ… colorByState with colorMap support for enum values
  2135â†’12. âœ… Bounded boundary handling with velocity reflection
  2136â†’
  2137â†’**Pending features for later**:
  2138â†’- [ ] Schelling's Segregation Model demo
  2139â†’- [ ] Conway's Game of Life demo
  2140â†’- [ ] Non-visualized "fast mode" with Web Workers
  2141â†’- [ ] Grid2D spatial environment
  2142â†’- [ ] Network/graph topology
  2143â†’- [ ] Parameter sweep functionality
  2144â†’- [ ] JSON Schema validation with Ajv
  2145â†’
  2146â†’**Special considerations**:
  2147â†’1. LLM-friendly JSON format - see `/public/docs/abm-json-guide.md` for specification
  2148â†’2. System and user prompts for LLM generation defined in the guide
  2149â†’
  2150â†’---
  2151â†’**STATUS**: âœ… Core implementation complete. Future enhancements tracked in "Future Enhancements" section above.
  2152â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
