# Data Visualization Platform - Next.js Edition

## Project Overview
A modern data visualization platform built with Next.js 15, React 18, TypeScript, and P5.js. Provides interactive data visualizations including heat maps, scatter plots, particle systems, and more. Configured for static export to GitHub Pages.

## Tech Stack

### Frontend Framework
- **Next.js 15** - React framework with App Router
- **React 18** - UI library with hooks and modern patterns
- **TypeScript** - Type-safe development
- **Tailwind CSS** - Utility-first styling

### Visualization
- **P5.js** - Creative coding library for visualizations
- **Client-side rendering** - All visualizations render in browser

### Build & Deploy
- **Static Export** - `output: 'export'` for GitHub Pages
- **GitHub Pages** - Static hosting with CDN
- **No server-side dependencies** - Pure client-side application

## Core Features

### 1. Interactive Visualizations
- **Heat Maps** - `/heatmap` - 2D data matrices with color-coded intensity
- **Scatter Plots** - `/scatter` - Plot relationships between variables
- **Geospatial Data** - `/geospatial` - Map-based visualizations
- **Time Series** - `/timeseries` - Data changes over time
- **Network Graphs** - `/network` - Connections and relationships
- **Bar Charts** - `/barchart` - Categorical data comparison

### 2. System Models & Simulations
- **State-Space System** - `/systemmodel` - Discrete-time system simulation with stocks and flows
- **State Space Visualizer** - `/statespace` - Phase portraits and trajectory visualization
- **Particle System** - `/particles` - Physics-based particle simulation
- **Flocking Behavior** - `/flocking` - Emergent group behavior simulation

### 3. Data Input Methods
1. **URL Parameters** - JSON data encoded in query string
2. **File Upload** - Drag & drop JSON files with validation
3. **PostMessage API** - For iframe embedding and external communication
4. **Demo Data** - Built-in example datasets for each visualization

### 4. Theming & Customization
- **Color Palettes** - Multiple built-in palettes (Viridis, Plasma, Inferno, etc.)
- **Typography** - Theme-based font sizing from `color-palettes.json`
- **Responsive Design** - Adapts to different screen sizes

## Architecture

### Directory Structure
```
/simulator
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                    # Next.js App Router pages
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx           # Home page / visualization gallery
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx         # Root layout with metadata
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heatmap/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx       # Heat map visualization page
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ systemmodel/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx       # System model simulator page
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ statespace/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx       # State space/phase portrait page
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ globals.css        # Global styles + Tailwind
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ visualizations/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HeatMap.tsx    # P5.js heat map component
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SystemModel.tsx # System simulator with stocks & flows
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ StateSpaceVisualization.tsx # Phase portrait viewer
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ VisualizationLayout.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ColorPaletteSelector.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ FileUploadZone.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ MessageDisplay.tsx
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.ts           # Utilities (ColorUtils, DataParser, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # TypeScript type definitions
‚îÇ   ‚îî‚îÄ‚îÄ public/
‚îÇ       ‚îî‚îÄ‚îÄ data/
‚îÇ           ‚îî‚îÄ‚îÄ color-palettes.json  # Theme configuration
‚îú‚îÄ‚îÄ backup/                     # Legacy vanilla JS version
‚îú‚îÄ‚îÄ next.config.js             # Next.js configuration
‚îú‚îÄ‚îÄ tailwind.config.ts         # Tailwind CSS configuration
‚îî‚îÄ‚îÄ package.json
```

### Component Architecture

#### HeatMap Component (`/src/components/visualizations/HeatMap.tsx`)

**Key Implementation Details:**
- Uses P5.js in instance mode within React
- Loads theme configuration asynchronously for font sizes
- Uses `paletteRef` for color palette to avoid re-renders
- Implements `p.noLoop()` for static visualizations
- Properly cleans up P5 instances on unmount

**Memory Leak Fix (Dec 2025):**
The component previously had an infinite loop caused by including `fontSizes` state in the useEffect dependency array while also modifying it within the effect. This created:
- Thousands of P5.js instances per second
- Runaway memory consumption (94+ GB observed)
- Browser crashes

**Solution:**
- Removed `fontSizes` state entirely
- Font sizes loaded as local variables in the effect
- P5 sketch captures these variables in closure
- useEffect dependencies: `[data, width, height, onError]` only
- No circular dependency = no infinite loop

**Code Pattern:**
```typescript
useEffect(() => {
  let p5: any
  let isMounted = true

  const loadP5 = async () => {
    // Load font sizes as local variables (not state)
    let labelSize = 12
    let valueSize = 10

    try {
      const [loadedLabelSize, loadedValueSize] = await Promise.all([
        TypographyUtils.getVisualizationFontSize('heatmap', 'labelSize'),
        TypographyUtils.getVisualizationFontSize('heatmap', 'fontSize')
      ])
      labelSize = loadedLabelSize
      valueSize = loadedValueSize
    } catch (error) {
      console.warn('Using default font sizes')
    }

    // Create P5 sketch using local variables
    const sketch = (p: any) => {
      p.setup = () => {
        // ... setup code
        p.noLoop() // Static visualization
      }

      p.draw = () => {
        // Uses labelSize and valueSize from closure
      }
    }

    p5 = new P5(sketch)
  }

  loadP5()

  return () => {
    isMounted = false
    if (p5) p5.remove()
  }
}, [data, width, height, onError]) // No fontSizes!
```

#### SystemModel Component (`/src/components/visualizations/SystemModel.tsx`)

**Purpose**: Simulates discrete-time state-space systems and visualizes them as stocks-and-flows diagrams with animated particles.

**Key Features:**
- **Force-directed graph layout** - States positioned based on A matrix structure
- **Draggable nodes** - Click and drag any node to reposition
- **Interactive hover info** - Shows connectivity metrics, flow rates, and connections
- **Animated flow particles** - Variable velocity based on flow magnitude
- **Bidirectional edge handling** - Parallel pipes for reverse connections
- **Export capabilities** - CSV, JSON, copy current state
- **Direct navigation** - "View Phase Portrait" button to State Space Visualizer

**Implementation Patterns:**
```typescript
// Use refs to avoid P5 re-mounting on state changes
const currentTimeIndexRef = useRef(0)
const [currentTimeIndex, setCurrentTimeIndex] = useState(0)

useEffect(() => {
  currentTimeIndexRef.current = currentTimeIndex
}, [currentTimeIndex])

// P5 reads from ref instead of state
p.draw = () => {
  const idx = currentTimeIndexRef.current // No re-mount!
  // ... use idx
}
```

**Force-Directed Layout:**
- Initializes states in circle
- Spring forces between connected nodes (proportional to |A[i][j]|)
- Repulsion forces prevent overlap
- Centering force keeps layout bounded
- 300 iterations for stable configuration

**Bidirectional Edge Detection:**
```typescript
// Build adjacency map
const edgeMap = new Map<string, Edge>()
edges.forEach(edge => {
  edgeMap.set(`${edge.from.id}->${edge.to.id}`, edge)
})

// Detect reverse edges
edges.forEach(edge => {
  if (edge.from.id === edge.to.id) return // Skip self-loops

  const reverseKey = `${edge.to.id}->${edge.from.id}`
  if (edgeMap.get(reverseKey)) {
    // Mark as bidirectional with parallel offset
    edge.bidirectional = true
    edge.parallelOffset = BIDIRECTIONAL_OFFSET
  }
})
```

**Critical Learning - Conditional Rendering vs Disabled:**
Initially used `disabled={!hasData}` for export buttons. Problem: buttons visible but unusable created confusion.

Solution: Conditional rendering for primary actions
```typescript
{hasSimulationData && (
  <button onClick={openInStateSpaceVisualizer}>
    üé® View Phase Portrait
  </button>
)}
```

Benefits:
- Clearer UI - button only appears when functional
- Prevents errors - no risk of clicking when no data
- Better UX - users see what's available

#### StateSpaceVisualization Component (`/src/components/visualizations/StateSpaceVisualization.tsx`)

**Purpose**: Displays phase portraits (state vs state plots) from time series data.

**Key Features:**
- **Multi-plot grid** - Shows all state pairs (upper triangle only)
- **Interactive state selection** - Toggle which states to visualize
- **Trajectory trails** - Adjustable length showing recent history
- **Current point tracking** - Red dot shows current position
- **Complete trajectory** - Faint gray line shows full path
- **Dual format support** - Accepts simple JSON or System Simulator exports

**Data Integration:**
```typescript
// Accepts System Simulator export format
interface SystemSimulatorExport {
  metadata?: { title, dt, timeHorizon }
  system?: { A, B, C, D, labels }
  results: { t, x, u, y }  // Extract x and t for phase portrait
}

// Or simple format
interface StateSpaceData {
  t: number[]
  x: number[][]  // [timeStep][stateIndex]
  labels?: string[]
  title?: string
}
```

**SessionStorage Integration:**
Seamless navigation from System Simulator:
```typescript
// In SystemModel.tsx
const openInStateSpaceVisualizer = () => {
  const stateSpaceData = {
    t: simulationRef.current.t,
    x: simulationRef.current.x,
    labels: data.labels?.states,
    title: data.title
  }
  sessionStorage.setItem('stateSpaceData', JSON.stringify(stateSpaceData))
  router.push('/statespace')
}

// In statespace/page.tsx
useEffect(() => {
  const sessionData = sessionStorage.getItem('stateSpaceData')
  if (sessionData) {
    const parsedData = JSON.parse(sessionData)
    setStateSpaceData(parsedData)
    sessionStorage.removeItem('stateSpaceData') // Clear after use
  }
}, [])
```

**Grid Layout Calculation:**
For n selected states, shows n(n-1)/2 plots (upper triangle):
```typescript
const plotsPerRow = Math.ceil(Math.sqrt(gridSize * (gridSize - 1) / 2))
const plotWidth = width / plotsPerRow
const plotHeight = height / Math.ceil((gridSize * (gridSize - 1) / 2) / plotsPerRow)

// Draw only i < j pairs
for (let i = 0; i < selected.length; i++) {
  for (let j = i + 1; j < selected.length; j++) {
    drawPhasePlot(stateI, stateJ, ...)
  }
}
```

### Utility Classes (`/src/lib/utils.ts`)

#### ColorUtils
- **Static color palette generation** - Viridis, Plasma, Inferno, Magma, etc.
- **Theme configuration loading** - Loads from `/data/color-palettes.json`
- **Caching** - Static properties cache theme config (bounded size, safe)

#### TypographyUtils
- **Font size management** - Loads visualization-specific font sizes from theme
- **Fallback handling** - Returns defaults if theme loading fails

#### DataParser
- **URL parameter parsing** - Extracts and validates JSON from query strings
- **Error handling** - Graceful fallbacks for malformed data

#### FileHandler
- **Drag & drop support** - File upload with validation
- **JSON parsing** - Client-side JSON validation
- **Cleanup functions** - Returns cleanup function for event listeners

### Data Flow

1. **Page Load**
   - Next.js renders page component
   - Checks URL parameters via `DataParser.parseURLParams()`
   - Loads demo data if no URL data provided

2. **User Uploads File**
   - `FileUploadZone` handles drag/drop or click to upload
   - Validates JSON structure
   - Calls `onFileUpload` callback with parsed data

3. **Visualization Renders**
   - React component receives data prop
   - useEffect loads P5.js dynamically (code splitting)
   - Loads theme config (fonts, colors)
   - Creates P5 instance with sketch
   - P5 renders visualization on canvas

4. **Palette Change**
   - Separate useEffect watches `colorPalette` prop
   - Loads new palette data
   - Updates `paletteRef.current`
   - Calls `p5Instance.updateDisplay()` to redraw

## JSON Data Formats

### Heat Map Data
```json
{
  "data": [[1, 2, 3], [4, 5, 6], [7, 8, 9]],
  "labels": {
    "x": ["A", "B", "C"],
    "y": ["Row 1", "Row 2", "Row 3"]
  },
  "colorScale": "viridis",
  "title": "Sample Heat Map"
}
```

### Color Palette Theme Config
Located at `/public/data/color-palettes.json`:
```json
{
  "palettes": {
    "viridis": { "type": "sequential", "colors": 256 },
    "plasma": { "type": "sequential", "colors": 256 }
  },
  "typography": {
    "heatmap": {
      "titleSize": 24,
      "labelSize": 14,
      "fontSize": 12
    }
  }
}
```

## Performance Considerations

### Memory Management
- **P5 Instance Cleanup** - Always call `p5.remove()` in useEffect cleanup
- **Avoid State in Dependencies** - Don't include state that's modified within the effect
- **Use Refs for Mutable Data** - `paletteRef` used instead of state to prevent re-renders
- **Static Visualizations** - Call `p.noLoop()` for non-animated visualizations

### Best Practices
1. **Load P5 dynamically** - `await import('p5')` for code splitting
2. **Use local variables** - For data that doesn't need to trigger re-renders
3. **Cleanup event listeners** - Remove all listeners in useEffect return function
4. **Monitor dependencies** - Only include values that should trigger re-creation

### Common Pitfalls

#### Pitfall 1: State in Effect Dependencies
‚ùå **DON'T**: Include state in dependencies if you modify it in the effect
```typescript
useEffect(() => {
  setFontSize(20) // Modifies state
}, [fontSize]) // Depends on it = INFINITE LOOP
```

‚úÖ **DO**: Use local variables or refs
```typescript
useEffect(() => {
  let fontSize = 20
  // Load async...
  fontSize = loadedSize
  // Use in sketch closure
}, [data]) // Only depends on data
```

#### Pitfall 2: P5 Reading from State
‚ùå **DON'T**: Read state directly in P5 draw loop (causes re-mount on every state change)
```typescript
const [currentIndex, setCurrentIndex] = useState(0)

useEffect(() => {
  const sketch = (p) => {
    p.draw = () => {
      const idx = currentIndex // Causes re-mount!
    }
  }
  p5 = new P5(sketch)
}, [currentIndex]) // P5 recreated every frame!
```

‚úÖ **DO**: Use refs for values P5 needs to read
```typescript
const currentIndexRef = useRef(0)
const [currentIndex, setCurrentIndex] = useState(0)

useEffect(() => {
  currentIndexRef.current = currentIndex
}, [currentIndex])

useEffect(() => {
  const sketch = (p) => {
    p.draw = () => {
      const idx = currentIndexRef.current // No re-mount!
    }
  }
  p5 = new P5(sketch)
}, [data]) // Only re-create when data changes
```

#### Pitfall 3: Disabled vs Hidden Buttons
‚ùå **DON'T**: Leave buttons visible when they can't function
```typescript
<button disabled={!hasData}>Export</button>
// Button visible but grayed out - confusing UX
```

‚úÖ **DO**: Conditionally render buttons that require preconditions
```typescript
{hasData && <button>Export</button>}
// Button only appears when it can actually work
```

Exception: Use `disabled` for buttons that should always be visible but temporarily inactive (e.g., "Next" button at end of list).

## Development Workflow

### Local Development
```bash
npm run dev       # Start dev server on localhost:3000
npm run build     # Build for production
npm run lint      # Run ESLint
```

### Static Export
```bash
npm run build     # Creates /out directory
npm run export    # Alias for build (configured in next.config.js)
```

### Deployment
- **GitHub Pages** - Push to `gh-pages` branch or use GitHub Actions
- **Static hosting** - All files in `/out` can be served from any static host
- **Base path** - Configure `basePath` in `next.config.js` for subdirectory hosting

## Browser Compatibility
- **Modern browsers** - Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **ES modules** - Native ESM support required
- **Canvas/WebGL** - P5.js requires canvas API
- **Async/await** - Modern JavaScript features throughout

## Known Issues & Solutions

### Issue: Memory Leak in P5 Components
**Symptom**: Browser memory grows to 10s of GB
**Cause**: Infinite useEffect loop creating P5 instances
**Solution**: Remove state variables from dependencies if modified within effect

### Issue: Font Sizes Not Loading
**Symptom**: Default font sizes used instead of theme values
**Cause**: Async loading completes after P5 instance created
**Solution**: Load theme config before creating sketch, use local variables

### Issue: Palette Not Updating
**Symptom**: Changing palette doesn't update visualization
**Cause**: P5 sketch doesn't re-run on palette change
**Solution**: Separate useEffect watches palette, calls `p5Instance.updateDisplay()`

## Recent Additions (December 2025)

### System Model Simulator
- Force-directed graph layout based on A matrix structure
- Draggable nodes with visual feedback
- Interactive node info panels showing connectivity and flow metrics
- Bidirectional edge detection with parallel pipe rendering
- Export to CSV, JSON, and clipboard
- One-click navigation to State Space Visualizer

### State Space Visualizer
- Phase portrait grid showing all state pairs
- Interactive state selection (minimum 2 states)
- Adjustable trajectory trail length
- Dual format support (simple JSON + System Simulator exports)
- SessionStorage integration for seamless navigation
- Real-time playback with timeline scrubbing

### Integration Pattern
```
System Simulator ‚Üí "View Phase Portrait" ‚Üí State Space Visualizer
                    ‚Üì sessionStorage ‚Üì
              Automatic data transfer, zero friction
```

## Future Enhancements
- [ ] Vector field visualization (see planning section below)
- [ ] PNG/SVG export for visualizations
- [ ] Real-time data streaming via WebSocket
- [ ] Collaborative features with shareable URLs
- [ ] 3D phase portraits with WebGL
- [ ] Accessibility improvements (ARIA labels, keyboard navigation)
- [ ] WebAssembly for intensive computations
- [ ] Bifurcation diagrams for parameter studies

## Contributing
When modifying P5.js components:
1. Always test memory usage in browser DevTools
2. Ensure useEffect dependencies are correct
3. Call `p.remove()` in cleanup function
4. Use refs for data that shouldn't trigger re-renders
5. Document async loading patterns

## Resources
- [Next.js Documentation](https://nextjs.org/docs)
- [P5.js Reference](https://p5js.org/reference/)
- [React Hooks](https://react.dev/reference/react)
- [Tailwind CSS](https://tailwindcss.com/docs)

---

## PLANNING: Vector Field Visualizer

### Design Decisions Required

**Instructions**: Fill in your requirements below. Once complete, notify Claude to review this section and implement.

#### 1. System Definition & Input
**Question**: What type of systems should it support?
- [ ] Linear only: `dx/dt = Ax` (2√ó2 or 3√ó3 matrix)?
- [ ] Linear with input: `dx/dt = Ax + Bu`?
- [ ] Nonlinear: `dx/dt = f(x)` with custom functions?

**Your Answer**:


**Question**: How should users input the system?
- [ ] Manual matrix entry (text fields)?
- [ ] JSON upload (from System Simulator)?
- [ ] Predefined examples?
- [ ] Connection to System Simulator (import A matrix directly)?

**Your Answer**:


---

#### 2. Dimensionality & Projection
**Question**: Which dimensions to visualize?
- [ ] 2D only (x1 vs x2)?
- [ ] 3D vector fields?
- [ ] For higher-dimensional systems (n>2), select which 2 states to plot?

**Your Answer**:


**Question**: For 3+ state systems, how to handle other states?
- [ ] Fix them at zero?
- [ ] Fix at equilibrium values?
- [ ] User-specified slice through state space?

**Your Answer**:


---

#### 3. Vector Field Representation
**Question**: How to display the field?
- [ ] Arrow grid (classic)?
- [ ] Streamlines/flow lines?
- [ ] Both options (user toggle)?
- [ ] Color coding by magnitude?

**Your Answer**:


**Question**: Arrow scaling?
- [ ] Normalized (all same length, shows direction only)?
- [ ] Proportional to magnitude (shows speed)?
- [ ] Log-scaled for large dynamic ranges?

**Your Answer**:


---

#### 4. Grid & Bounds
**Question**: State space range?
- [ ] Fixed (e.g., -10 to 10)?
- [ ] User-adjustable?
- [ ] Auto-calculated from eigenvalues/system characteristics?

**Your Answer**:


**Question**: Grid density?
- [ ] Fixed grid (e.g., 20√ó20)?
- [ ] User-adjustable slider?
- [ ] Adaptive (denser near interesting features)?

**Your Answer**:


---

#### 5. Trajectory Integration
**Question**: Should users be able to plot solution trajectories?
- [ ] Click to add initial condition ‚Üí show trajectory?
- [ ] Multiple trajectories simultaneously?
- [ ] Forward time, backward time, or both?
- [ ] Integration method (Euler, RK4)?

**Your Answer**:


**Question**: Trajectory visualization?
- [ ] Animated point moving along path?
- [ ] Full path drawn?
- [ ] Fading trail?

**Your Answer**:


---

#### 6. Analysis Features
**Question**: What analytical tools to include?
- [ ] Equilibrium points (where dx/dt = 0)?
- [ ] Nullclines (isoclines where one state doesn't change)?
- [ ] Eigenvectors of A matrix?
- [ ] Stability classification (saddle, stable node, unstable spiral, etc.)?
- [ ] Lyapunov function contours?

**Your Answer**:


---

#### 7. Interactivity
**Question**: What interactions should be supported?
- [ ] Click to add trajectories?
- [ ] Drag matrix sliders to see real-time changes?
- [ ] Zoom/pan the view?
- [ ] Toggle nullclines/eigenvectors on/off?

**Your Answer**:


---

#### 8. Integration with Existing Pages
**Question**: How should it connect to other tools?
- [ ] "View Vector Field" button in System Simulator (like Phase Portrait)?
- [ ] Only for 2-state systems?
- [ ] Extract 2D subsystems from higher-dimensional systems?

**Your Answer**:


---

#### 9. Predefined Examples
**Question**: What examples to include?

**Your Answer**:


---

#### 10. Performance & Rendering
**Question**: Technology choice?
- [ ] P5.js (consistent with other visualizations)?
- [ ] Canvas API directly (better performance)?
- [ ] WebGL for 3D?

**Your Answer**:


---

### Summary of Requirements
Once you've filled in the sections above, provide a brief summary here:

**Must-have features for v1**:


**Nice-to-have features for later**:


**Special considerations**:


---
**STATUS**: ‚è≥ Awaiting user input. Notify Claude when ready to implement.
