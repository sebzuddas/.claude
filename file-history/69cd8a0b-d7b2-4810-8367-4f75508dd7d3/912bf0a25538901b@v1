'use client'

import { useState, useEffect } from 'react'
import VisualizationLayout from '@/components/ui/VisualizationLayout'
import StateSpaceVisualization from '@/components/visualizations/StateSpaceVisualization'
import FileUploadZone from '@/components/ui/FileUploadZone'
import MessageDisplay from '@/components/ui/MessageDisplay'
import CodeBlock from '@/components/ui/CodeBlock'
import { DataParser } from '@/lib/utils'
import type { StateSpaceData, SystemSimulatorExport, FileUploadResult } from '@/types'

export default function StateSpacePage() {
  const [data, setData] = useState<StateSpaceData | null>(null)
  const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' | 'info' }>()

  useEffect(() => {
    // Initialize with data from URL or demo data
    const urlData = DataParser.parseURLParams()

    if (urlData.error) {
      setMessage({ text: urlData.error, type: 'error' })
      return
    }

    if (urlData.demo || !urlData.data) {
      generateDemoData()
      setMessage({ text: 'Demo data loaded: Damped Oscillator. Upload your own JSON file.', type: 'success' })
    } else {
      setStateSpaceData(urlData.data)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [])

  const generateDemoData = () => {
    // Generate a damped oscillator trajectory
    const dt = 0.05
    const tMax = 10
    const steps = Math.floor(tMax / dt)

    const t: number[] = []
    const x: number[][] = []

    // Initial conditions
    let position = 2
    let velocity = 0

    // Parameters
    const omega = 2 * Math.PI // Natural frequency (1 Hz)
    const zeta = 0.1 // Damping ratio

    for (let i = 0; i < steps; i++) {
      t.push(i * dt)
      x.push([position, velocity])

      // Damped harmonic oscillator equations
      const accel = -2 * zeta * omega * velocity - omega * omega * position

      // Euler integration
      velocity += accel * dt
      position += velocity * dt
    }

    const demoData: StateSpaceData = {
      t,
      x,
      labels: ['Position', 'Velocity'],
      title: 'Damped Oscillator Phase Portrait'
    }

    setStateSpaceData(demoData)
  }

  const setStateSpaceData = (newData: any) => {
    try {
      // Try to parse as complete simulator export first
      if (newData.results && newData.results.x && newData.results.t) {
        const exportData = newData as SystemSimulatorExport
        const stateSpaceData: StateSpaceData = {
          t: exportData.results.t,
          x: exportData.results.x,
          labels: exportData.system?.labels?.states || undefined,
          title: exportData.metadata?.title || 'State Space Visualization'
        }
        setData(stateSpaceData)
        setMessage({ text: 'Loaded data from System Simulator export!', type: 'success' })
        return
      }

      // Try simple format
      if (newData.t && newData.x) {
        if (!Array.isArray(newData.t) || !Array.isArray(newData.x)) {
          setMessage({ text: 'Invalid data: t and x must be arrays', type: 'error' })
          return
        }

        if (newData.x.length === 0 || !Array.isArray(newData.x[0])) {
          setMessage({ text: 'Invalid data: x must be a 2D array [timeStep][stateIndex]', type: 'error' })
          return
        }

        if (newData.t.length !== newData.x.length) {
          setMessage({ text: 'Invalid data: t and x must have same length', type: 'error' })
          return
        }

        const stateSpaceData: StateSpaceData = {
          t: newData.t,
          x: newData.x,
          labels: newData.labels || undefined,
          title: newData.title || 'State Space Visualization'
        }

        setData(stateSpaceData)
        setMessage({ text: 'State space data loaded successfully!', type: 'success' })
        return
      }

      setMessage({ text: 'Invalid data format. See examples below.', type: 'error' })
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : 'Failed to parse data'
      setMessage({ text: errorMsg, type: 'error' })
    }
  }

  const handleFileUpload = (result: FileUploadResult) => {
    if (result.error) {
      setMessage({ text: result.error, type: 'error' })
    } else if (result.data) {
      setStateSpaceData(result.data)
    }
  }

  return (
    <VisualizationLayout
      title="State Space Visualization"
      description="Visualize phase portraits and state trajectories from time series data"
    >
      {/* Controls */}
      <div className="controls">
        <button
          onClick={generateDemoData}
          className="btn mr-2"
        >
          Load Demo Data
        </button>
      </div>

      {/* File Upload */}
      <FileUploadZone
        onFileUpload={handleFileUpload}
        description="Drop a JSON file with time series data or System Simulator export"
        className="w-full max-w-2xl"
      />

      {/* Message Display */}
      {message && (
        <MessageDisplay
          message={message.text}
          type={message.type}
          onClose={() => setMessage(undefined)}
        />
      )}

      {/* Visualization */}
      {data && (
        <div className="bg-white rounded-lg shadow-lg p-4">
          <StateSpaceVisualization
            data={data}
            onError={(error) => setMessage({ text: error, type: 'error' })}
          />
        </div>
      )}

      {/* Usage Instructions */}
      <div className="mt-8 max-w-4xl">
        <h3 className="text-lg font-semibold mb-4">Accepted JSON Formats:</h3>

        <div className="mb-6">
          <h4 className="font-semibold mb-2">Format 1: Simple Time Series</h4>
          <p className="text-sm text-gray-600 mb-3">
            Basic format with time array and state matrix
          </p>
          <CodeBlock
            code={{
              "t": [0, 0.1, 0.2, 0.3],
              "x": [
                [1.0, 0.0],
                [0.99, 0.1],
                [0.96, 0.19],
                [0.91, 0.27]
              ],
              "labels": ["Position", "Velocity"],
              "title": "My System"
            }}
          />
        </div>

        <div className="mb-6">
          <h4 className="font-semibold mb-2">Format 2: System Simulator Export</h4>
          <p className="text-sm text-gray-600 mb-3">
            Complete export from the System Model simulator (click "ðŸ“„ Export JSON")
          </p>
          <CodeBlock
            code={{
              "metadata": {
                "title": "Mass-Spring-Damper System",
                "dt": 0.1,
                "timeHorizon": 10
              },
              "system": {
                "A": "...",
                "B": "...",
                "labels": {
                  "states": ["Position", "Velocity"]
                }
              },
              "results": {
                "t": [0, 0.1, 0.2],
                "x": [[1, 0], [0.99, 0.1], [0.96, 0.19]],
                "u": "...",
                "y": "..."
              }
            }}
          />
        </div>

        <div className="mt-6 p-4 bg-blue-50 rounded-lg">
          <h4 className="font-semibold mb-2">Features:</h4>
          <ul className="list-disc list-inside text-sm space-y-1">
            <li>Phase portrait grid showing all state pairs (state i vs state j)</li>
            <li>Interactive playback with timeline scrubbing</li>
            <li>Select which states to visualize (minimum 2 required)</li>
            <li>Adjustable trail length to see recent history</li>
            <li>Current point (red), starting point (green), complete trajectory (gray)</li>
            <li>Automatically works with System Simulator exports</li>
          </ul>
        </div>

        <div className="mt-4 p-4 bg-amber-50 rounded-lg">
          <h4 className="font-semibold mb-2">Workflow:</h4>
          <ol className="list-decimal list-inside text-sm space-y-1">
            <li>Run a simulation in the System Model page</li>
            <li>Click "ðŸ“„ Export JSON" to download complete data</li>
            <li>Come to this page and upload the JSON file</li>
            <li>Explore the state space trajectories and phase portraits!</li>
          </ol>
        </div>
      </div>
    </VisualizationLayout>
  )
}
