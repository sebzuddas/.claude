/**
 * Schelling's Segregation Model
 *
 * Classic model demonstrating how mild individual preferences for similar
 * neighbors can lead to large-scale segregation patterns.
 *
 * This implementation uses steering behaviors:
 * - Agents flee from different-type neighbors
 * - Agents have cohesion with same-type neighbors
 * - Result: emergent clustering/segregation
 */

import type { ABMModelDefinition } from '@/lib/abm'

export const SCHELLING_MODEL: ABMModelDefinition = {
  schemaVersion: '1.0',

  overview: {
    purpose: "Schelling's Segregation Model - demonstrates how mild preferences for similar neighbors lead to large-scale segregation",

    entities: {
      componentTypes: [
        {
          name: 'Position',
          properties: {
            x: { type: 'number', default: 0 },
            y: { type: 'number', default: 0 }
          }
        },
        {
          name: 'Velocity',
          properties: {
            x: { type: 'number', default: 0 },
            y: { type: 'number', default: 0 }
          }
        },
        {
          name: 'AgentType',
          properties: {
            type: { type: 'enum', enumValues: ['A', 'B'], default: 'A' }
          }
        },
        {
          name: 'SteeringBehavior',
          properties: {
            rules: { type: 'string', default: '[]' },
            maxSpeed: { type: 'number', default: 30 },
            maxForce: { type: 'number', default: 2 }
          }
        }
      ],

      archetypes: [
        {
          name: 'TypeA',
          components: {
            Position: { x: 0, y: 0 },
            Velocity: { x: 0, y: 0 },
            AgentType: { type: 'A' },
            SteeringBehavior: {
              rules: [
                // Flee from different-type neighbors (creates separation between groups)
                { type: 'flee', weight: 2.0, query: { radius: 50, filter: { eq: [{ prop: 'other.AgentType.type' }, 'B'] } } },
                // Cohesion with same-type neighbors (creates clustering)
                { type: 'cohesion', weight: 1.0, query: { radius: 80, filter: { eq: [{ prop: 'other.AgentType.type' }, 'A'] } } },
                // Separation to prevent overlap
                { type: 'separation', weight: 1.5, query: { radius: 15 } },
                // Slight random movement
                { type: 'wander', weight: 0.2, params: { wanderRadius: 10, wanderDistance: 20, wanderJitter: 0.2 } }
              ],
              maxSpeed: 30,
              maxForce: 2.5
            }
          },
          visual: {
            shape: 'circle',
            size: 6,
            color: '#4285f4'  // Blue
          }
        },
        {
          name: 'TypeB',
          components: {
            Position: { x: 0, y: 0 },
            Velocity: { x: 0, y: 0 },
            AgentType: { type: 'B' },
            SteeringBehavior: {
              rules: [
                // Flee from different-type neighbors
                { type: 'flee', weight: 2.0, query: { radius: 50, filter: { eq: [{ prop: 'other.AgentType.type' }, 'A'] } } },
                // Cohesion with same-type neighbors
                { type: 'cohesion', weight: 1.0, query: { radius: 80, filter: { eq: [{ prop: 'other.AgentType.type' }, 'B'] } } },
                // Separation to prevent overlap
                { type: 'separation', weight: 1.5, query: { radius: 15 } },
                // Slight random movement
                { type: 'wander', weight: 0.2, params: { wanderRadius: 10, wanderDistance: 20, wanderJitter: 0.2 } }
              ],
              maxSpeed: 30,
              maxForce: 2.5
            }
          },
          visual: {
            shape: 'square',
            size: 5,
            color: '#ea4335'  // Red
          }
        }
      ]
    },

    scales: {
      spatial: {
        spatial: {
          type: 'continuous2D',
          width: 600,
          height: 400
        },
        boundary: 'bounded'
      },
      temporal: {
        dt: 0.05,
        maxTicks: 10000
      }
    },

    processSchedule: [
      { system: 'Steering', order: 'parallel' },
      { system: 'Movement', order: 'parallel' }
    ]
  },

  designConcepts: {
    sensing: {
      description: 'Agents sense nearby agents and their types within a radius',
      defaultRadius: 60
    },

    interaction: {
      description: 'Agents prefer same-type neighbors via steering behaviors (flee different, cohere with same)',
      rules: []  // Behavior driven by steering, not explicit rules
    },

    stochasticity: {
      description: 'Random initial positions create different segregation patterns each run'
    },

    observation: {
      timeseries: [
        {
          name: 'typeA',
          query: { count: { filter: { eq: [{ prop: 'AgentType.type' }, 'A'] } } }
        },
        {
          name: 'typeB',
          query: { count: { filter: { eq: [{ prop: 'AgentType.type' }, 'B'] } } }
        }
      ],
      events: []
    }
  },

  details: {
    initialization: {
      entities: [
        {
          archetype: 'TypeA',
          count: 50,
          position: {
            type: 'random',
            region: {
              min: { x: 20, y: 20 },
              max: { x: 580, y: 380 }
            }
          },
          propertyVariation: {
            'Velocity.x': { distribution: 'uniform', min: -10, max: 10 },
            'Velocity.y': { distribution: 'uniform', min: -10, max: 10 }
          }
        },
        {
          archetype: 'TypeB',
          count: 50,
          position: {
            type: 'random',
            region: {
              min: { x: 20, y: 20 },
              max: { x: 580, y: 380 }
            }
          },
          propertyVariation: {
            'Velocity.x': { distribution: 'uniform', min: -10, max: 10 },
            'Velocity.y': { distribution: 'uniform', min: -10, max: 10 }
          }
        }
      ]
    }
  },

  uiParameters: [
    {
      name: 'Type A Count',
      path: 'params.typeACount',
      type: 'number',
      min: 10,
      max: 100,
      step: 10,
      description: 'Number of Type A agents'
    },
    {
      name: 'Type B Count',
      path: 'params.typeBCount',
      type: 'number',
      min: 10,
      max: 100,
      step: 10,
      description: 'Number of Type B agents'
    }
  ]
}
