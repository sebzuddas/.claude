# Data Visualization Platform - Next.js Edition

## Project Overview
A modern data visualization platform built with Next.js 15, React 18, TypeScript, and P5.js. Provides interactive data visualizations including heat maps, scatter plots, particle systems, and more. Configured for static export to GitHub Pages.

## Tech Stack

### Frontend Framework
- **Next.js 15** - React framework with App Router
- **React 18** - UI library with hooks and modern patterns
- **TypeScript** - Type-safe development
- **Tailwind CSS** - Utility-first styling

### Visualization
- **P5.js** - Creative coding library for visualizations
- **Client-side rendering** - All visualizations render in browser

### Build & Deploy
- **Static Export** - `output: 'export'` for GitHub Pages
- **GitHub Pages** - Static hosting with CDN
- **No server-side dependencies** - Pure client-side application

## Core Features

### 1. Interactive Visualizations
- **Heat Maps** - `/heatmap` - 2D data matrices with color-coded intensity
- **Scatter Plots** - `/scatter` - Plot relationships between variables
- **Geospatial Data** - `/geospatial` - Map-based visualizations
- **Time Series** - `/timeseries` - Data changes over time
- **Network Graphs** - `/network` - Connections and relationships
- **Bar Charts** - `/barchart` - Categorical data comparison

### 2. System Models & Simulations
- **State-Space System** - `/systemmodel` - Discrete-time system simulation with stocks and flows
- **State Space Visualizer** - `/statespace` - Phase portraits and trajectory visualization
- **Particle System** - `/particles` - Physics-based particle simulation
- **Flocking Behavior** - `/flocking` - Emergent group behavior simulation

### 2. Data Input Methods
1. **URL Parameters** - JSON data encoded in query string
2. **File Upload** - Drag & drop JSON files with validation
3. **PostMessage API** - For iframe embedding and external communication
4. **Demo Data** - Built-in example datasets for each visualization

### 3. Theming & Customization
- **Color Palettes** - Multiple built-in palettes (Viridis, Plasma, Inferno, etc.)
- **Typography** - Theme-based font sizing from `color-palettes.json`
- **Responsive Design** - Adapts to different screen sizes

## Architecture

### Directory Structure
```
/simulator
├── src/
│   ├── app/                    # Next.js App Router pages
│   │   ├── page.tsx           # Home page / visualization gallery
│   │   ├── layout.tsx         # Root layout with metadata
│   │   ├── heatmap/
│   │   │   └── page.tsx       # Heat map visualization page
│   │   └── globals.css        # Global styles + Tailwind
│   ├── components/
│   │   ├── visualizations/
│   │   │   └── HeatMap.tsx    # P5.js heat map component
│   │   └── ui/
│   │       ├── VisualizationLayout.tsx
│   │       ├── ColorPaletteSelector.tsx
│   │       ├── FileUploadZone.tsx
│   │       └── MessageDisplay.tsx
│   ├── lib/
│   │   └── utils.ts           # Utilities (ColorUtils, DataParser, etc.)
│   ├── types/
│   │   └── index.ts           # TypeScript type definitions
│   └── public/
│       └── data/
│           └── color-palettes.json  # Theme configuration
├── backup/                     # Legacy vanilla JS version
├── next.config.js             # Next.js configuration
├── tailwind.config.ts         # Tailwind CSS configuration
└── package.json
```

### Component Architecture

#### HeatMap Component (`/src/components/visualizations/HeatMap.tsx`)

**Key Implementation Details:**
- Uses P5.js in instance mode within React
- Loads theme configuration asynchronously for font sizes
- Uses `paletteRef` for color palette to avoid re-renders
- Implements `p.noLoop()` for static visualizations
- Properly cleans up P5 instances on unmount

**Memory Leak Fix (Dec 2025):**
The component previously had an infinite loop caused by including `fontSizes` state in the useEffect dependency array while also modifying it within the effect. This created:
- Thousands of P5.js instances per second
- Runaway memory consumption (94+ GB observed)
- Browser crashes

**Solution:**
- Removed `fontSizes` state entirely
- Font sizes loaded as local variables in the effect
- P5 sketch captures these variables in closure
- useEffect dependencies: `[data, width, height, onError]` only
- No circular dependency = no infinite loop

**Code Pattern:**
```typescript
useEffect(() => {
  let p5: any
  let isMounted = true

  const loadP5 = async () => {
    // Load font sizes as local variables (not state)
    let labelSize = 12
    let valueSize = 10

    try {
      const [loadedLabelSize, loadedValueSize] = await Promise.all([
        TypographyUtils.getVisualizationFontSize('heatmap', 'labelSize'),
        TypographyUtils.getVisualizationFontSize('heatmap', 'fontSize')
      ])
      labelSize = loadedLabelSize
      valueSize = loadedValueSize
    } catch (error) {
      console.warn('Using default font sizes')
    }

    // Create P5 sketch using local variables
    const sketch = (p: any) => {
      p.setup = () => {
        // ... setup code
        p.noLoop() // Static visualization
      }

      p.draw = () => {
        // Uses labelSize and valueSize from closure
      }
    }

    p5 = new P5(sketch)
  }

  loadP5()

  return () => {
    isMounted = false
    if (p5) p5.remove()
  }
}, [data, width, height, onError]) // No fontSizes!
```

### Utility Classes (`/src/lib/utils.ts`)

#### ColorUtils
- **Static color palette generation** - Viridis, Plasma, Inferno, Magma, etc.
- **Theme configuration loading** - Loads from `/data/color-palettes.json`
- **Caching** - Static properties cache theme config (bounded size, safe)

#### TypographyUtils
- **Font size management** - Loads visualization-specific font sizes from theme
- **Fallback handling** - Returns defaults if theme loading fails

#### DataParser
- **URL parameter parsing** - Extracts and validates JSON from query strings
- **Error handling** - Graceful fallbacks for malformed data

#### FileHandler
- **Drag & drop support** - File upload with validation
- **JSON parsing** - Client-side JSON validation
- **Cleanup functions** - Returns cleanup function for event listeners

### Data Flow

1. **Page Load**
   - Next.js renders page component
   - Checks URL parameters via `DataParser.parseURLParams()`
   - Loads demo data if no URL data provided

2. **User Uploads File**
   - `FileUploadZone` handles drag/drop or click to upload
   - Validates JSON structure
   - Calls `onFileUpload` callback with parsed data

3. **Visualization Renders**
   - React component receives data prop
   - useEffect loads P5.js dynamically (code splitting)
   - Loads theme config (fonts, colors)
   - Creates P5 instance with sketch
   - P5 renders visualization on canvas

4. **Palette Change**
   - Separate useEffect watches `colorPalette` prop
   - Loads new palette data
   - Updates `paletteRef.current`
   - Calls `p5Instance.updateDisplay()` to redraw

## JSON Data Formats

### Heat Map Data
```json
{
  "data": [[1, 2, 3], [4, 5, 6], [7, 8, 9]],
  "labels": {
    "x": ["A", "B", "C"],
    "y": ["Row 1", "Row 2", "Row 3"]
  },
  "colorScale": "viridis",
  "title": "Sample Heat Map"
}
```

### Color Palette Theme Config
Located at `/public/data/color-palettes.json`:
```json
{
  "palettes": {
    "viridis": { "type": "sequential", "colors": 256 },
    "plasma": { "type": "sequential", "colors": 256 }
  },
  "typography": {
    "heatmap": {
      "titleSize": 24,
      "labelSize": 14,
      "fontSize": 12
    }
  }
}
```

## Performance Considerations

### Memory Management
- **P5 Instance Cleanup** - Always call `p5.remove()` in useEffect cleanup
- **Avoid State in Dependencies** - Don't include state that's modified within the effect
- **Use Refs for Mutable Data** - `paletteRef` used instead of state to prevent re-renders
- **Static Visualizations** - Call `p.noLoop()` for non-animated visualizations

### Best Practices
1. **Load P5 dynamically** - `await import('p5')` for code splitting
2. **Use local variables** - For data that doesn't need to trigger re-renders
3. **Cleanup event listeners** - Remove all listeners in useEffect return function
4. **Monitor dependencies** - Only include values that should trigger re-creation

### Common Pitfalls
❌ **DON'T**: Include state in dependencies if you modify it in the effect
```typescript
useEffect(() => {
  setFontSize(20) // Modifies state
}, [fontSize]) // Depends on it = INFINITE LOOP
```

✅ **DO**: Use local variables or refs
```typescript
useEffect(() => {
  let fontSize = 20
  // Load async...
  fontSize = loadedSize
  // Use in sketch closure
}, [data]) // Only depends on data
```

## Development Workflow

### Local Development
```bash
npm run dev       # Start dev server on localhost:3000
npm run build     # Build for production
npm run lint      # Run ESLint
```

### Static Export
```bash
npm run build     # Creates /out directory
npm run export    # Alias for build (configured in next.config.js)
```

### Deployment
- **GitHub Pages** - Push to `gh-pages` branch or use GitHub Actions
- **Static hosting** - All files in `/out` can be served from any static host
- **Base path** - Configure `basePath` in `next.config.js` for subdirectory hosting

## Browser Compatibility
- **Modern browsers** - Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **ES modules** - Native ESM support required
- **Canvas/WebGL** - P5.js requires canvas API
- **Async/await** - Modern JavaScript features throughout

## Known Issues & Solutions

### Issue: Memory Leak in P5 Components
**Symptom**: Browser memory grows to 10s of GB
**Cause**: Infinite useEffect loop creating P5 instances
**Solution**: Remove state variables from dependencies if modified within effect

### Issue: Font Sizes Not Loading
**Symptom**: Default font sizes used instead of theme values
**Cause**: Async loading completes after P5 instance created
**Solution**: Load theme config before creating sketch, use local variables

### Issue: Palette Not Updating
**Symptom**: Changing palette doesn't update visualization
**Cause**: P5 sketch doesn't re-run on palette change
**Solution**: Separate useEffect watches palette, calls `p5Instance.updateDisplay()`

## Future Enhancements
- [ ] Add more visualization types (scatter, network, particle systems)
- [ ] Implement WebAssembly for computationally intensive visualizations
- [ ] Add export functionality (PNG, SVG, PDF)
- [ ] Real-time data streaming via WebSocket
- [ ] Collaborative features with shareable URLs
- [ ] Animation controls for time-series data
- [ ] 3D visualizations with WebGL
- [ ] Accessibility improvements (ARIA labels, keyboard navigation)

## Contributing
When modifying P5.js components:
1. Always test memory usage in browser DevTools
2. Ensure useEffect dependencies are correct
3. Call `p.remove()` in cleanup function
4. Use refs for data that shouldn't trigger re-renders
5. Document async loading patterns

## Resources
- [Next.js Documentation](https://nextjs.org/docs)
- [P5.js Reference](https://p5js.org/reference/)
- [React Hooks](https://react.dev/reference/react)
- [Tailwind CSS](https://tailwindcss.com/docs)
