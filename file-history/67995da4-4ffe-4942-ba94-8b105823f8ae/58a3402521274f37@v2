'use client'

import { useState, useEffect } from 'react'
import VisualizationLayout from '@/components/ui/VisualizationLayout'
import ScatterPlot from '@/components/visualizations/ScatterPlot'
import FileUploadZone from '@/components/ui/FileUploadZone'
import MessageDisplay from '@/components/ui/MessageDisplay'
import CodeBlock from '@/components/ui/CodeBlock'
import { DataParser } from '@/lib/utils'
import type { ScatterPlotData, FileUploadResult } from '@/types'

export default function ScatterPlotPage() {
  const [data, setData] = useState<ScatterPlotData | null>(null)
  const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' | 'info' }>()

  useEffect(() => {
    // Initialize with data from URL or demo data
    const urlData = DataParser.parseURLParams()

    if (urlData.error) {
      setMessage({ text: urlData.error, type: 'error' })
      return
    }

    if (urlData.demo || (!urlData.data)) {
      generateDemoData()
      setMessage({ text: 'Demo data loaded. Upload your own JSON file or use URL parameters.', type: 'success' })
    } else {
      setScatterData(urlData.data)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [])

  const generateDemoData = () => {
    const points = []
    const numPoints = 50

    for (let i = 0; i < numPoints; i++) {
      const x = Math.random() * 100
      const y = x * 0.8 + Math.random() * 30 - 15 // Roughly linear with noise
      points.push({
        x: Math.round(x * 10) / 10,
        y: Math.round(y * 10) / 10,
        label: `Point ${i + 1}`
      })
    }

    setScatterData({
      points: points,
      title: 'Demo Scatter Plot',
      xLabel: 'Variable X',
      yLabel: 'Variable Y'
    })
  }

  const setScatterData = (newData: any) => {
    // Validate data
    if (!newData?.points || !Array.isArray(newData.points)) {
      setMessage({ text: 'Invalid data: missing required "points" array', type: 'error' })
      return
    }

    if (newData.points.length === 0) {
      setMessage({ text: 'Invalid data: points array is empty', type: 'error' })
      return
    }

    // Validate point structure
    const validPoints = newData.points.every((p: any) =>
      typeof p.x === 'number' && typeof p.y === 'number'
    )

    if (!validPoints) {
      setMessage({ text: 'Invalid data: each point must have numeric x and y values', type: 'error' })
      return
    }

    setData(newData)
    setMessage({ text: 'Scatter plot data loaded successfully!', type: 'success' })
  }

  const handleFileUpload = (result: FileUploadResult) => {
    if (result.error) {
      setMessage({ text: result.error, type: 'error' })
    } else if (result.data) {
      setScatterData(result.data)
    }
  }

  const handleExport = () => {
    setMessage({ text: 'Export functionality coming soon!', type: 'info' })
  }

  return (
    <VisualizationLayout
      title="Scatter Plot Visualization"
      description="Plot relationships between two variables with trend line analysis"
    >
      {/* Controls */}
      <div className="controls">
        <button
          onClick={generateDemoData}
          className="btn mr-2"
        >
          Regenerate Demo Data
        </button>
        <button
          onClick={handleExport}
          className="btn"
        >
          Export as Image
        </button>
      </div>

      {/* File Upload */}
      <FileUploadZone
        onFileUpload={handleFileUpload}
        description="Drop a JSON file here or click to select"
        className="w-full max-w-2xl"
      />

      {/* Message Display */}
      {message && (
        <MessageDisplay
          message={message.text}
          type={message.type}
          onClose={() => setMessage(undefined)}
        />
      )}

      {/* Visualization */}
      {data && (
        <div className="bg-white rounded-lg shadow-lg p-4">
          <ScatterPlot
            data={data}
            onError={(error) => setMessage({ text: error, type: 'error' })}
          />
        </div>
      )}

      {/* Usage Instructions */}
      <div className="mt-8 max-w-4xl">
        <h3 className="text-lg font-semibold mb-4">Expected JSON Format:</h3>
        <CodeBlock
          code={{
            "points": [
              {"x": 12.5, "y": 23.8, "label": "Sample A"},
              {"x": 18.7, "y": 31.2, "label": "Sample B"},
              {"x": 25.3, "y": 42.1, "label": "Sample C"}
            ],
            "title": "Performance vs Investment",
            "xLabel": "Investment ($K)",
            "yLabel": "Performance Score"
          }}
        />

        <div className="mt-6">
          <h4 className="text-md font-semibold mb-2">Field Descriptions:</h4>
          <ul className="list-disc list-inside text-sm text-gray-700 space-y-1">
            <li><strong>points</strong> (required): Array of data points with x, y coordinates</li>
            <li><strong>label</strong> (optional): Label for each point shown in tooltip</li>
            <li><strong>title</strong> (optional): Chart title</li>
            <li><strong>xLabel, yLabel</strong> (optional): Axis labels</li>
          </ul>
        </div>
      </div>
    </VisualizationLayout>
  )
}
