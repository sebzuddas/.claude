'use client'

import { useState, useEffect } from 'react'
import VisualizationLayout from '@/components/ui/VisualizationLayout'
import NetworkGraph from '@/components/visualizations/NetworkGraph'
import FileUploadZone from '@/components/ui/FileUploadZone'
import MessageDisplay from '@/components/ui/MessageDisplay'
import CodeBlock from '@/components/ui/CodeBlock'
import { DataParser } from '@/lib/utils'
import type { NetworkGraphData, FileUploadResult } from '@/types'

export default function NetworkPage() {
  const [data, setData] = useState<NetworkGraphData | null>(null)
  const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' | 'info' }>()

  useEffect(() => {
    // Initialize with data from URL or demo data
    const urlData = DataParser.parseURLParams()

    if (urlData.error) {
      setMessage({ text: urlData.error, type: 'error' })
      return
    }

    if (urlData.demo || (!urlData.data)) {
      generateDemoData()
      setMessage({ text: 'Demo network loaded. Upload your own JSON file or use URL parameters.', type: 'success' })
    } else {
      setNetworkData(urlData.data)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [])

  const generateDemoData = () => {
    // Create a small social network graph
    const nodes = [
      { id: '1', label: 'Alice', size: 12, color: '#FF6B6B', group: 1 },
      { id: '2', label: 'Bob', size: 10, color: '#4ECDC4', group: 1 },
      { id: '3', label: 'Charlie', size: 14, color: '#45B7D1', group: 1 },
      { id: '4', label: 'Diana', size: 11, color: '#FFA07A', group: 2 },
      { id: '5', label: 'Eve', size: 13, color: '#98D8C8', group: 2 },
      { id: '6', label: 'Frank', size: 10, color: '#F7DC6F', group: 2 },
      { id: '7', label: 'Grace', size: 12, color: '#BB8FCE', group: 3 },
      { id: '8', label: 'Henry', size: 11, color: '#85C1E2', group: 3 },
      { id: '9', label: 'Ivy', size: 10, color: '#F8B195', group: 3 },
      { id: '10', label: 'Jack', size: 15, color: '#C06C84', group: 1 }
    ]

    const edges = [
      { source: '1', target: '2', weight: 2 },
      { source: '1', target: '3', weight: 1 },
      { source: '2', target: '3', weight: 3 },
      { source: '2', target: '4', weight: 1 },
      { source: '3', target: '5', weight: 2 },
      { source: '4', target: '5', weight: 1 },
      { source: '4', target: '6', weight: 2 },
      { source: '5', target: '6', weight: 1 },
      { source: '5', target: '7', weight: 2 },
      { source: '6', target: '8', weight: 1 },
      { source: '7', target: '8', weight: 3 },
      { source: '7', target: '9', weight: 1 },
      { source: '8', target: '9', weight: 2 },
      { source: '1', target: '10', weight: 2 },
      { source: '3', target: '10', weight: 1 },
      { source: '10', target: '7', weight: 1 }
    ]

    setNetworkData({
      nodes,
      edges,
      title: 'Demo Social Network',
      directed: false
    })
  }

  const setNetworkData = (newData: any) => {
    // Validate data
    if (!newData?.nodes || !Array.isArray(newData.nodes)) {
      setMessage({ text: 'Invalid data: missing required "nodes" array', type: 'error' })
      return
    }

    if (newData.nodes.length === 0) {
      setMessage({ text: 'Invalid data: nodes array is empty', type: 'error' })
      return
    }

    // Validate node structure
    const validNodes = newData.nodes.every((n: any) => n.id)
    if (!validNodes) {
      setMessage({ text: 'Invalid data: each node must have an "id" field', type: 'error' })
      return
    }

    // Validate edges if present
    if (newData.edges && Array.isArray(newData.edges)) {
      const validEdges = newData.edges.every((e: any) => e.source && e.target)
      if (!validEdges) {
        setMessage({ text: 'Invalid data: each edge must have "source" and "target" fields', type: 'error' })
        return
      }
    }

    setData(newData)
    setMessage({ text: 'Network graph data loaded successfully!', type: 'success' })
  }

  const handleFileUpload = (result: FileUploadResult) => {
    if (result.error) {
      setMessage({ text: result.error, type: 'error' })
    } else if (result.data) {
      setNetworkData(result.data)
    }
  }

  const handleExport = () => {
    setMessage({ text: 'Export functionality coming soon!', type: 'info' })
  }

  return (
    <VisualizationLayout
      title="Network Graph Visualization"
      description="Force-directed graph layout with interactive node positioning"
    >
      {/* Controls */}
      <div className="controls">
        <button
          onClick={generateDemoData}
          className="btn mr-2"
        >
          Regenerate Demo Data
        </button>
        <button
          onClick={handleExport}
          className="btn"
        >
          Export as Image
        </button>
      </div>

      {/* File Upload */}
      <FileUploadZone
        onFileUpload={handleFileUpload}
        description="Drop a JSON file here or click to select"
        className="w-full max-w-2xl"
      />

      {/* Message Display */}
      {message && (
        <MessageDisplay
          message={message.text}
          type={message.type}
          onClose={() => setMessage(undefined)}
        />
      )}

      {/* Visualization */}
      {data && (
        <div className="bg-white rounded-lg shadow-lg p-4">
          <NetworkGraph
            data={data}
            onError={(error) => setMessage({ text: error, type: 'error' })}
          />
        </div>
      )}

      {/* Usage Instructions */}
      <div className="mt-8 max-w-4xl">
        <h3 className="text-lg font-semibold mb-4">Expected JSON Format:</h3>
        <CodeBlock
          code={{
            "nodes": [
              {"id": "1", "label": "Node A", "size": 12, "color": "#FF6B6B", "group": 1},
              {"id": "2", "label": "Node B", "size": 10, "color": "#4ECDC4", "group": 1},
              {"id": "3", "label": "Node C", "size": 14, "color": "#45B7D1", "group": 2}
            ],
            "edges": [
              {"source": "1", "target": "2", "weight": 2, "label": "friends"},
              {"source": "2", "target": "3", "weight": 1, "directed": true}
            ],
            "title": "My Network",
            "directed": false
          }}
        />

        <div className="mt-6">
          <h4 className="text-md font-semibold mb-2">Field Descriptions:</h4>
          <ul className="list-disc list-inside text-sm text-gray-700 space-y-1">
            <li><strong>nodes</strong> (required): Array of network nodes</li>
            <li><strong>id</strong> (required): Unique identifier for each node</li>
            <li><strong>label</strong> (optional): Display name for node</li>
            <li><strong>size</strong> (optional): Node size (default: 10)</li>
            <li><strong>color</strong> (optional): Node color hex code</li>
            <li><strong>group</strong> (optional): Group identifier for clustering</li>
            <li><strong>edges</strong> (optional): Array of connections between nodes</li>
            <li><strong>source, target</strong> (required for edges): Node IDs to connect</li>
            <li><strong>weight</strong> (optional): Edge weight/strength (default: 1)</li>
            <li><strong>directed</strong> (optional): Whether edge has direction (arrow)</li>
          </ul>
        </div>

        <div className="mt-6">
          <h4 className="text-md font-semibold mb-2">Force-Directed Layout:</h4>
          <p className="text-sm text-gray-700 mb-2">
            The network layout is calculated using a physics simulation with two primary forces:
          </p>
          <ol className="list-decimal list-inside text-sm text-gray-700 space-y-2 ml-4">
            <li>
              <strong>Repulsion (Coulomb's Law):</strong> All nodes repel each other with force
              inversely proportional to distance squared. This prevents nodes from clustering too tightly.
            </li>
            <li>
              <strong>Attraction (Hooke's Law):</strong> Connected nodes (edges) attract each other
              like springs, with force proportional to distance from rest length. This keeps
              connected nodes near each other.
            </li>
          </ol>
          <p className="text-sm text-gray-700 mt-3">
            The system stabilizes when these forces balance. Drag nodes to explore the network
            structure, and the layout will adapt while maintaining the force equilibrium.
          </p>
        </div>

        <div className="mt-6">
          <h4 className="text-md font-semibold mb-2">Use Cases:</h4>
          <ul className="list-disc list-inside text-sm text-gray-700 space-y-1">
            <li>Social network analysis</li>
            <li>Organizational hierarchies</li>
            <li>Computer network topology</li>
            <li>Knowledge graphs and ontologies</li>
            <li>Biological networks (protein interactions, food webs)</li>
            <li>Citation networks</li>
          </ul>
        </div>
      </div>
    </VisualizationLayout>
  )
}
